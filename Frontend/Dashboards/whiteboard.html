<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collaborative Whiteboard - StudyFinder</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="../js/notifications.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #121212;
      color: #fff;
      overflow: hidden;
      height: 100vh;
    }

    .whiteboard-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    .whiteboard-header {
      background: rgba(26, 26, 46, 0.9);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 107, 0, 0.2);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .back-btn {
      background: rgba(255, 107, 0, 0.15);
      border: 1px solid rgba(255, 107, 0, 0.3);
      color: #ff6b00;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .back-btn:hover {
      background: rgba(255, 107, 0, 0.25);
      transform: translateX(-2px);
    }

    .group-info {
      display: flex;
      flex-direction: column;
    }

    .group-name {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
    }

    .active-users {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .user-count {
      color: #ff6b00;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .header-btn {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #fff;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-btn:hover {
      background: rgba(255, 107, 0, 0.2);
      border-color: rgba(255, 107, 0, 0.3);
    }

    .header-btn i {
      font-size: 14px;
    }

    /* Main Content */
    .whiteboard-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Toolbar */
    .toolbar {
      background: rgba(26, 26, 46, 0.9);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 107, 0, 0.2);
      padding: 20px 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 80px;
      align-items: center;
    }

    .tool-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      width: 100%;
    }

    .tool-section:last-child {
      border-bottom: none;
    }

    .tool-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.7);
      width: 50px;
      height: 50px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      position: relative;
    }

    .tool-btn:hover {
      background: rgba(255, 107, 0, 0.15);
      border-color: rgba(255, 107, 0, 0.3);
      color: #ff6b00;
      transform: translateY(-2px);
    }

    .tool-btn.active {
      background: linear-gradient(135deg, #ff6b00, #ff4b2b);
      border-color: transparent;
      color: white;
      box-shadow: 0 4px 15px rgba(255, 107, 0, 0.4);
    }

    .tool-label {
      position: absolute;
      left: 70px;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 10;
    }

    .tool-btn:hover .tool-label {
      opacity: 1;
    }

    .color-picker-container {
      display: flex;
      flex-direction: column;
      gap: 5px;
      align-items: center;
    }

    .color-swatch {
      width: 50px;
      height: 30px;
      border-radius: 8px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .color-swatch:hover {
      transform: scale(1.1);
      border-color: #ff6b00;
    }

    #colorPicker {
      width: 0;
      height: 0;
      opacity: 0;
      position: absolute;
    }

    .stroke-width-selector {
      display: flex;
      flex-direction: column;
      gap: 5px;
      align-items: center;
    }

    .width-option {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .width-option:hover {
      background: rgba(255, 107, 0, 0.15);
      border-color: rgba(255, 107, 0, 0.3);
    }

    .width-option.active {
      background: rgba(255, 107, 0, 0.2);
      border-color: #ff6b00;
    }

    .width-indicator {
      background: white;
      border-radius: 50%;
    }

    /* Canvas Area */
    .canvas-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: #1a1a2e;
    }

    #whiteboardCanvas {
      display: block;
      cursor: crosshair;
      touch-action: none;
    }

    #whiteboardCanvas.cursor-pen {
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="2" fill="%23ff6b00"/></svg>') 12 12, crosshair;
    }

    #whiteboardCanvas.cursor-eraser {
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" fill="none" stroke="%23ff6b00" stroke-width="2"/></svg>') 12 12, crosshair;
    }

    #whiteboardCanvas.cursor-text {
      cursor: text;
    }

    /* Collaborators Panel */
    .collaborators-panel {
      background: rgba(26, 26, 46, 0.9);
      backdrop-filter: blur(20px);
      border-left: 1px solid rgba(255, 107, 0, 0.2);
      width: 250px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
    }

    .collaborators-panel::-webkit-scrollbar {
      width: 6px;
    }

    .collaborators-panel::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }

    .collaborators-panel::-webkit-scrollbar-thumb {
      background: rgba(255, 107, 0, 0.5);
      border-radius: 3px;
    }

    .panel-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 600;
      color: #ff6b00;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .collaborator-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .collaborator-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6b00, #ff4b2b);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      position: relative;
    }

    .collaborator-cursor {
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      bottom: -2px;
      right: -2px;
      border: 2px solid #1a1a2e;
    }

    .collaborator-info {
      flex: 1;
    }

    .collaborator-name {
      font-size: 13px;
      color: #fff;
      font-weight: 500;
    }

    .collaborator-status {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
    }

    .cursor-preview {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .remote-cursor {
      position: absolute;
      width: 20px;
      height: 20px;
      pointer-events: none;
      transition: all 0.1s ease;
      z-index: 1000;
    }

    .remote-cursor svg {
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
    }

    .cursor-label {
      position: absolute;
      left: 20px;
      top: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
    }

    /* Loading State */
    .loading-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 107, 0, 0.2);
      border-top-color: #ff6b00;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .collaborators-panel {
        position: absolute;
        right: -250px;
        top: 60px;
        bottom: 0;
        transition: right 0.3s ease;
        z-index: 100;
      }

      .collaborators-panel.active {
        right: 0;
      }

      .toolbar {
        width: 60px;
        padding: 15px 8px;
      }

      .tool-btn {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }

      .group-name {
        font-size: 16px;
      }

      .header-btn {
        padding: 6px 12px;
        font-size: 12px;
      }
    }

    /* Additional responsive styles */
    @media (max-width: 480px) {
      .whiteboard-header { padding: 10px 12px; }
      .header-left { gap: 8px; }
      .back-btn { padding: 6px 10px; font-size: 14px; }
      .group-name { font-size: 14px; }
      .header-btn { padding: 5px 10px; font-size: 11px; }
      .toolbar { padding: 12px 6px; }
      .tool-btn { width: 40px; height: 40px; font-size: 16px; }
      .participants-panel { width: 100%; }
      .participant-item { font-size: 12px; }
    }

    @media (max-width: 360px) {
      .whiteboard-header { padding: 8px 10px; flex-direction: column; gap: 10px; }
      .group-name { font-size: 13px; }
      .toolbar { padding: 10px 5px; gap: 5px; }
      .tool-btn { width: 36px; height: 36px; font-size: 14px; }
    }

    @media (orientation: landscape) and (max-height: 500px) {
      .whiteboard-header { padding: 8px 15px; }
      .toolbar { padding: 8px; }
    }
  </style>
</head>
<body>
  <div class="whiteboard-container">
    <!-- Header -->
    <div class="whiteboard-header">
      <div class="header-left">
        <button class="back-btn" onclick="goBackToGroups()">
          <i class="fas fa-arrow-left"></i>
          Back to Chat
        </button>
        <div class="group-info">
          <div class="group-name" id="groupName">Loading...</div>
          <div class="active-users">
            <i class="fas fa-circle" style="color: #10b981; font-size: 8px;"></i>
            <span class="user-count" id="userCount">0</span> active
          </div>
        </div>
      </div>
      <div class="header-right">
        <button class="header-btn" onclick="clearCanvas()">
          <i class="fas fa-trash"></i>
          Clear All
        </button>
        <button class="header-btn" onclick="downloadWhiteboard()">
          <i class="fas fa-download"></i>
          Download
        </button>
        <button class="header-btn" onclick="toggleCollaborators()">
          <i class="fas fa-users"></i>
          Collaborators
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="whiteboard-content">
      <!-- Toolbar -->
      <div class="toolbar">
        <div class="tool-section">
          <button class="tool-btn active" data-tool="pen" onclick="selectTool('pen')">
            <i class="fas fa-pen"></i>
            <span class="tool-label">Pen</span>
          </button>
          <button class="tool-btn" data-tool="eraser" onclick="selectTool('eraser')">
            <i class="fas fa-eraser"></i>
            <span class="tool-label">Eraser</span>
          </button>
          <button class="tool-btn" data-tool="line" onclick="selectTool('line')">
            <i class="fas fa-minus"></i>
            <span class="tool-label">Line</span>
          </button>
          <button class="tool-btn" data-tool="rectangle" onclick="selectTool('rectangle')">
            <i class="far fa-square"></i>
            <span class="tool-label">Rectangle</span>
          </button>
          <button class="tool-btn" data-tool="circle" onclick="selectTool('circle')">
            <i class="far fa-circle"></i>
            <span class="tool-label">Circle</span>
          </button>
          <button class="tool-btn" data-tool="text" onclick="selectTool('text')">
            <i class="fas fa-font"></i>
            <span class="tool-label">Text</span>
          </button>
        </div>

        <div class="tool-section">
          <div class="color-picker-container">
            <div class="color-swatch" id="colorSwatch" onclick="document.getElementById('colorPicker').click()"></div>
            <input type="color" id="colorPicker" value="#ff6b00">
          </div>
        </div>

        <div class="tool-section stroke-width-selector">
          <button class="width-option active" data-width="2" onclick="selectWidth(2)">
            <div class="width-indicator" style="width: 2px; height: 2px;"></div>
          </button>
          <button class="width-option" data-width="5" onclick="selectWidth(5)">
            <div class="width-indicator" style="width: 5px; height: 5px;"></div>
          </button>
          <button class="width-option" data-width="10" onclick="selectWidth(10)">
            <div class="width-indicator" style="width: 10px; height: 10px;"></div>
          </button>
        </div>

        <div class="tool-section">
          <button class="tool-btn" onclick="undo()">
            <i class="fas fa-undo"></i>
            <span class="tool-label">Undo</span>
          </button>
          <button class="tool-btn" onclick="redo()">
            <i class="fas fa-redo"></i>
            <span class="tool-label">Redo</span>
          </button>
        </div>
      </div>

      <!-- Canvas Area -->
      <div class="canvas-area">
        <div class="loading-container" id="loadingContainer">
          <div class="loading-spinner"></div>
          <div class="loading-text">Connecting to whiteboard...</div>
        </div>
        <canvas id="whiteboardCanvas"></canvas>
      </div>

      <!-- Collaborators Panel -->
      <div class="collaborators-panel" id="collaboratorsPanel">
        <div class="panel-section">
          <div class="panel-title">Active Users</div>
          <div id="collaboratorsList">
            <!-- Collaborators will be added here dynamically -->
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-title">Recent Actions</div>
          <div id="recentActions" style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">
            No recent activity
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Get group name from URL
    const urlParams = new URLSearchParams(window.location.search);
    const groupName = urlParams.get('group');
    let socket = null;
    let canvas, ctx;
    let isDrawing = false;
    let currentTool = 'pen';
    let currentColor = '#ff6b00';
    let currentWidth = 2;
    let drawingHistory = [];
    let historyStep = -1;
    let startX, startY;
    let collaborators = new Map();

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      if (!groupName) {
        alert('No group specified!');
        goBackToGroups();
        return;
      }

      document.getElementById('groupName').textContent = decodeURIComponent(groupName);
      initializeCanvas();
      connectWebSocket();
      setupEventListeners();
    });

    function initializeCanvas() {
      canvas = document.getElementById('whiteboardCanvas');
      ctx = canvas.getContext('2d');

      // Set canvas size
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      // Set initial drawing properties
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      // Mouse events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);

      // Touch events
      canvas.addEventListener('touchstart', handleTouchStart);
      canvas.addEventListener('touchmove', handleTouchMove);
      canvas.addEventListener('touchend', stopDrawing);

      // Hide loading
      document.getElementById('loadingContainer').style.display = 'none';
    }

    function resizeCanvas() {
      const canvasArea = canvas.parentElement;
      canvas.width = canvasArea.clientWidth;
      canvas.height = canvasArea.clientHeight;
      
      // Redraw from history
      redrawCanvas();
    }

    function setupEventListeners() {
      // Color picker
      document.getElementById('colorPicker').addEventListener('change', function(e) {
        currentColor = e.target.value;
        document.getElementById('colorSwatch').style.backgroundColor = currentColor;
      });

      // Set initial color swatch
      document.getElementById('colorSwatch').style.backgroundColor = currentColor;
    }

    function connectWebSocket() {
      const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      socket = new WebSocket(`${wsProtocol}//${window.location.hostname}:5000`);

      socket.addEventListener('open', function() {
        console.log('Connected to whiteboard');
        
        // Join whiteboard room
        socket.send(JSON.stringify({
          type: 'join_whiteboard',
          groupName: groupName,
          userId: localStorage.getItem('userId') || 'user_' + Date.now(),
          userName: localStorage.getItem('userName') || 'Anonymous'
        }));
      });

      socket.addEventListener('message', function(event) {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
      });

      socket.addEventListener('close', function() {
        console.log('Disconnected from whiteboard');
        setTimeout(connectWebSocket, 3000); // Reconnect after 3 seconds
      });

      socket.addEventListener('error', function(error) {
        console.error('WebSocket error:', error);
      });
    }

    function handleWebSocketMessage(data) {
      switch(data.type) {
        case 'whiteboard_joined':
          Toast.success(`Joined whiteboard`, 'Connected');
          if (data.canvasData) {
            loadCanvasData(data.canvasData);
          }
          break;
        
        case 'whiteboard_draw':
          drawRemotePath(data);
          break;
        
        case 'whiteboard_clear':
          clearCanvas(false);
          break;
        
        case 'collaborator_joined':
          addCollaborator(data.collaborator);
          addRecentAction(`${data.collaborator.name} joined`);
          break;
        
        case 'collaborator_left':
          removeCollaborator(data.collaboratorId);
          break;
        
        case 'cursor_move':
          updateRemoteCursor(data);
          break;

        case 'collaborators_update':
          updateCollaboratorsList(data.collaborators);
          break;
      }
    }

    function startDrawing(e) {
      isDrawing = true;
      const rect = canvas.getBoundingClientRect();
      startX = e.clientX - rect.left;
      startY = e.clientY - rect.top;

      if (currentTool === 'pen' || currentTool === 'eraser') {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
      }
    }

    function draw(e) {
      if (!isDrawing && currentTool !== 'text') return;

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // Send cursor position to other users
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
          type: 'cursor_move',
          groupName: groupName,
          x: x / canvas.width,
          y: y / canvas.height
        }));
      }

      if (!isDrawing) return;

      ctx.strokeStyle = currentTool === 'eraser' ? '#1a1a2e' : currentColor;
      ctx.lineWidth = currentTool === 'eraser' ? currentWidth * 5 : currentWidth;

      if (currentTool === 'pen' || currentTool === 'eraser') {
        ctx.lineTo(x, y);
        ctx.stroke();
      } else if (currentTool === 'line' || currentTool === 'rectangle' || currentTool === 'circle') {
        redrawCanvas();
        drawShape(startX, startY, x, y);
      }
    }

    function stopDrawing(e) {
      if (!isDrawing) return;
      isDrawing = false;

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // Save to history
      saveState();

      // Broadcast drawing to other users
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
          type: 'whiteboard_draw',
          groupName: groupName,
          tool: currentTool,
          color: currentColor,
          width: currentWidth,
          startX: startX / canvas.width,
          startY: startY / canvas.height,
          endX: x / canvas.width,
          endY: y / canvas.height
        }));
      }
    }

    function handleTouchStart(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    }

    function handleTouchMove(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    }

    function drawShape(x1, y1, x2, y2) {
      ctx.strokeStyle = currentColor;
      ctx.lineWidth = currentWidth;
      ctx.beginPath();

      if (currentTool === 'line') {
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
      } else if (currentTool === 'rectangle') {
        ctx.rect(x1, y1, x2 - x1, y2 - y1);
      } else if (currentTool === 'circle') {
        const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        ctx.arc(x1, y1, radius, 0, 2 * Math.PI);
      }

      ctx.stroke();
    }

    function selectTool(tool) {
      currentTool = tool;
      
      // Update UI
      document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.tool-btn[data-tool="${tool}"]`).classList.add('active');

      // Update cursor
      canvas.className = '';
      if (tool === 'pen') canvas.classList.add('cursor-pen');
      else if (tool === 'eraser') canvas.classList.add('cursor-eraser');
      else if (tool === 'text') canvas.classList.add('cursor-text');
    }

    function selectWidth(width) {
      currentWidth = width;
      
      // Update UI
      document.querySelectorAll('.width-option').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.width-option[data-width="${width}"]`).classList.add('active');
    }

    function saveState() {
      historyStep++;
      if (historyStep < drawingHistory.length) {
        drawingHistory.length = historyStep;
      }
      drawingHistory.push(canvas.toDataURL());
    }

    function undo() {
      if (historyStep > 0) {
        historyStep--;
        const img = new Image();
        img.src = drawingHistory[historyStep];
        img.onload = function() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
        };
      }
    }

    function redo() {
      if (historyStep < drawingHistory.length - 1) {
        historyStep++;
        const img = new Image();
        img.src = drawingHistory[historyStep];
        img.onload = function() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
        };
      }
    }

    function clearCanvas(broadcast = true) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawingHistory = [];
      historyStep = -1;
      saveState();

      if (broadcast && socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
          type: 'whiteboard_clear',
          groupName: groupName
        }));
      }

      Toast.info('Whiteboard cleared');
    }

    function downloadWhiteboard() {
      const link = document.createElement('a');
      link.download = `${groupName}_whiteboard_${Date.now()}.png`;
      link.href = canvas.toDataURL();
      link.click();
      Toast.success('Whiteboard downloaded', 'Success');
    }

    function toggleCollaborators() {
      const panel = document.getElementById('collaboratorsPanel');
      panel.classList.toggle('active');
    }

    function redrawCanvas() {
      if (historyStep >= 0 && drawingHistory[historyStep]) {
        const img = new Image();
        img.src = drawingHistory[historyStep];
        img.onload = function() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
        };
      }
    }

    function drawRemotePath(data) {
      const x1 = data.startX * canvas.width;
      const y1 = data.startY * canvas.height;
      const x2 = data.endX * canvas.width;
      const y2 = data.endY * canvas.height;

      ctx.strokeStyle = data.tool === 'eraser' ? '#1a1a2e' : data.color;
      ctx.lineWidth = data.tool === 'eraser' ? data.width * 5 : data.width;

      if (data.tool === 'pen' || data.tool === 'eraser') {
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
      } else {
        drawShape(x1, y1, x2, y2);
      }

      saveState();
    }

    function loadCanvasData(dataUrl) {
      const img = new Image();
      img.src = dataUrl;
      img.onload = function() {
        ctx.drawImage(img, 0, 0);
        saveState();
      };
    }

    function addCollaborator(collaborator) {
      collaborators.set(collaborator.id, collaborator);
      updateCollaboratorsList();
      document.getElementById('userCount').textContent = collaborators.size;
    }

    function removeCollaborator(id) {
      collaborators.delete(id);
      updateCollaboratorsList();
      document.getElementById('userCount').textContent = collaborators.size;
    }

    function updateCollaboratorsList(collabList) {
      if (collabList) {
        collaborators.clear();
        collabList.forEach(c => collaborators.set(c.id, c));
      }

      const container = document.getElementById('collaboratorsList');
      container.innerHTML = '';

      if (collaborators.size === 0) {
        container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); font-size: 12px;">No other users</div>';
        return;
      }

      collaborators.forEach(collab => {
        const item = document.createElement('div');
        item.className = 'collaborator-item';
        item.innerHTML = `
          <div class="collaborator-avatar">
            ${collab.name.charAt(0).toUpperCase()}
            <div class="collaborator-cursor" style="background-color: ${collab.color || '#ff6b00'};"></div>
          </div>
          <div class="collaborator-info">
            <div class="collaborator-name">${collab.name}</div>
            <div class="collaborator-status">Drawing</div>
          </div>
          <div class="cursor-preview">
            <i class="fas fa-pen" style="color: ${collab.color || '#ff6b00'}; font-size: 14px;"></i>
          </div>
        `;
        container.appendChild(item);
      });

      document.getElementById('userCount').textContent = collaborators.size;
    }

    function updateRemoteCursor(data) {
      // You can implement remote cursor visualization here
      // Create cursor elements that follow other users' mouse positions
    }

    function addRecentAction(text) {
      const container = document.getElementById('recentActions');
      const action = document.createElement('div');
      action.style.marginBottom = '8px';
      action.style.color = 'rgba(255, 255, 255, 0.7)';
      action.innerHTML = `
        <i class="fas fa-circle" style="font-size: 6px; color: #10b981; margin-right: 8px;"></i>
        ${text}
      `;
      container.prepend(action);

      // Keep only last 5 actions
      while (container.children.length > 5) {
        container.removeChild(container.lastChild);
      }
    }

    function goBackToGroups() {
      window.location.href = 'groups.html';
    }

    // Initialize first state
    setTimeout(() => saveState(), 100);
  </script>
</body>
</html>
