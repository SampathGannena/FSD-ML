<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Study Groups - Jarvis</title>
  <script src="../js/notifications.js"></script>
  <script src="../js/auth-guard.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/emoji-button.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #121212;
      color: #fff;
      height: 100vh;
      overflow: hidden;
    }

    .chart-container {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 35%;
      max-width: 400px;
      background-color: #1e1e1e;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #333;
      overflow-y: auto;
    }

    .sidebar h2 {
      margin-bottom: 1rem;
      font-size: 1.3rem;
      color: #ff4b2b;
      border-bottom: 2px solid #ff4b2b;
      padding-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .refresh-btn {
      background: none;
      border: none;
      color: #ff4b2b;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .refresh-btn:hover {
      background-color: rgba(255, 75, 43, 0.1);
    }

    .groups-container {
      flex-grow: 1;
      overflow-y: auto;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }
    
    .groups-container::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }

    .group-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .group-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 75, 43, 0.3);
      transform: translateY(-2px);
    }

    .group-card.selected-group {
      background: rgba(255, 75, 43, 0.1);
      border-color: #ff4b2b;
    }

    .group-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .group-name {
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      margin: 0;
      flex: 1;
    }

    .group-status {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .group-status.active {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
      border: 1px solid rgba(76, 175, 80, 0.3);
    }

    .group-status.pending {
      background: rgba(255, 193, 7, 0.2);
      color: #FFC107;
      border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .group-description {
      color: #ccc;
      font-size: 0.85rem;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .group-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 10px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: #ff4b2b;
    }

    .stat-label {
      font-size: 0.7rem;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .group-members {
      margin-top: 10px;
    }

    .group-members h4 {
      font-size: 0.8rem;
      color: #ff4b2b;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .members-list {
      max-height: 120px;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .members-list::-webkit-scrollbar {
      display: none;
    }

    .member-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      font-size: 0.8rem;
      position: relative;
    }
    
    .member-item.more {
      color: #888;
      font-style: italic;
      padding-left: 32px;
    }
    
    .member-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #333;
    }
    
    .member-badge {
      font-size: 0.6rem;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: auto;
      font-weight: 600;
    }
    
    .member-badge.admin {
      background: linear-gradient(135deg, #ffd700, #ffaa00);
      color: #000;
    }
    
    .member-badge.mod {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: #fff;
    }
    
    .no-members {
      color: #666;
      font-style: italic;
      font-size: 0.8rem;
    }

    .member-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
      position: absolute;
      bottom: 4px;
      left: 18px;
      border: 1px solid #1a1a2e;
    }

    .member-status.online {
      background-color: #4CAF50;
      box-shadow: 0 0 6px rgba(76, 175, 80, 0.6);
    }

    .member-status.offline {
      background-color: #757575;
    }

    .member-status.away {
      background-color: #FF9800;
      box-shadow: 0 0 6px rgba(255, 152, 0, 0.6);
    }

    .member-name {
      color: #ddd;
    }
    
    /* Group header badges */
    .group-badges {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .admin-badge {
      color: #ffd700;
      font-size: 0.9rem;
    }
    
    .group-card.is-admin {
      border-left: 3px solid #ffd700;
    }
    
    /* Activity preview */
    .activity-preview {
      padding: 8px 12px;
      background: rgba(255, 75, 43, 0.1);
      border-radius: 6px;
      margin: 10px 0;
      font-size: 0.75rem;
      border-left: 2px solid #ff4b2b;
    }
    
    .activity-user {
      color: #ff4b2b;
      font-weight: 600;
    }
    
    .activity-action {
      color: #aaa;
      margin-left: 4px;
    }
    
    /* Leave button */
    .quick-btn.leave-btn {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }
    
    .quick-btn.leave-btn:hover {
      background: rgba(239, 68, 68, 0.4);
    }

    .group-progress {
      margin: 15px 0;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .progress-label {
      font-size: 0.8rem;
      color: #ff4b2b;
      font-weight: 600;
    }

    .progress-percentage {
      font-size: 0.8rem;
      color: #fff;
      font-weight: 600;
    }

    .progress-bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #ff4b2b, #ff8a50);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .progress-milestones {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .milestone {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      cursor: help;
    }

    .milestone.completed {
      color: #22c55e;
      background: rgba(34, 197, 94, 0.2);
    }

    .milestone.current {
      color: #ff4b2b;
      background: rgba(255, 75, 43, 0.2);
      animation: pulse 2s infinite;
    }

    .milestone.upcoming {
      color: #6b7280;
      background: rgba(107, 114, 128, 0.2);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .group-quick-actions {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .quick-btn {
      background: rgba(255, 75, 43, 0.1);
      border: 1px solid rgba(255, 75, 43, 0.3);
      color: #ff4b2b;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .quick-btn:hover {
      background: #ff4b2b;
      color: white;
      transform: translateY(-1px);
    }

    .quick-btn i {
      font-size: 0.9rem;
    }

    .join-new-group {
      background: linear-gradient(135deg, #ff4b2b, #ff8a50);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .join-new-group:hover {
      background: linear-gradient(135deg, #e63946, #ff6b47);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 75, 43, 0.3);
    }

    .empty-groups {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .empty-groups i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .empty-groups h3 {
      margin-bottom: 10px;
      color: #888;
    }

    .empty-groups p {
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff4b2b, #ff8a50);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #e63946, #ff6b47);
      transform: translateY(-1px);
    }

    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #181818;
    }

    .chat-header {
      padding: 1rem;
      background-color: #1e1e1e;
      border-bottom: 2px solid #ff4b2b;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-header h2 {
      font-size: 1.2rem;
      color: #ff4b2b;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .group-info-btn {
      background: none;
      border: none;
      color: #ff4b2b;
      cursor: pointer;
      padding: 5px 8px;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .group-info-btn:hover {
      background-color: rgba(255, 75, 43, 0.1);
    }

    .chat-body {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }

    .chat-body::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }

    /* Enhanced Message Bubble Styles */
    .message-container {
      display: flex;
      gap: 10px;
      max-width: 80%;
      margin-bottom: 4px;
    }

    .message-container.own-message {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      color: #fff;
      flex-shrink: 0;
    }

    .message-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .message-sender {
      font-weight: 600;
      color: #fff;
    }

    .message-role {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      background: rgba(255, 75, 43, 0.3);
      color: #ff4b2b;
    }

    .message-role.admin {
      background: rgba(255, 193, 7, 0.3);
      color: #ffc107;
    }

    .message-role.moderator {
      background: rgba(33, 150, 243, 0.3);
      color: #2196F3;
    }

    .message-time {
      color: #888;
      font-size: 11px;
    }

    .message-bubble {
      background-color: #2c2c2c;
      color: #fff;
      padding: 10px 14px;
      border-radius: 16px;
      border-top-left-radius: 4px;
      word-wrap: break-word;
      position: relative;
    }

    .own-message .message-bubble {
      background: linear-gradient(135deg, #ff4b2b, #ff6b4a);
      border-radius: 16px;
      border-top-right-radius: 4px;
    }

    .message-text {
      line-height: 1.4;
    }

    .message-edited {
      font-size: 10px;
      color: #888;
      font-style: italic;
      margin-top: 4px;
    }

    /* Message Actions */
    .message-actions {
      display: none;
      position: absolute;
      top: -8px;
      right: 10px;
      background: #333;
      border-radius: 16px;
      padding: 4px 8px;
      gap: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .message-container:hover .message-actions {
      display: flex;
    }

    .message-action-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 6px;
      font-size: 14px;
      opacity: 0.7;
      transition: opacity 0.2s, transform 0.2s;
    }

    .message-action-btn:hover {
      opacity: 1;
      transform: scale(1.2);
    }

    /* Reactions */
    .message-reactions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    .reaction-badge {
      display: flex;
      align-items: center;
      gap: 4px;
      background: rgba(255,255,255,0.1);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .reaction-badge:hover {
      background: rgba(255,255,255,0.2);
    }

    .reaction-count {
      color: #aaa;
    }

    /* Replies */
    .message-replies {
      margin-top: 8px;
      padding-left: 12px;
      border-left: 2px solid #ff4b2b;
    }

    .reply-item {
      padding: 6px 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      margin-bottom: 4px;
      font-size: 13px;
    }

    .reply-header {
      display: flex;
      gap: 6px;
      font-size: 11px;
      color: #888;
      margin-bottom: 2px;
    }

    .reply-sender {
      color: #ff4b2b;
      font-weight: 500;
    }

    /* Pinned Message Badge */
    .pinned-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      margin-bottom: 4px;
    }

    /* System Messages */
    .system-message {
      align-self: center;
      background: rgba(255,255,255,0.1);
      color: #888;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      text-align: center;
      margin: 8px 0;
    }

    /* Date Separator */
    .date-separator {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 16px 0;
      color: #666;
      font-size: 12px;
    }

    .date-separator::before,
    .date-separator::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #333;
    }

    /* Attachment Styles */
    .message-attachment {
      margin-top: 8px;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .attachment-icon {
      font-size: 24px;
    }

    .attachment-info {
      flex: 1;
    }

    .attachment-name {
      color: #fff;
      font-size: 13px;
    }

    .attachment-size {
      color: #888;
      font-size: 11px;
    }

    .attachment-download {
      background: #ff4b2b;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    /* Legacy simple messages - keep for backwards compatibility */
    .chat-body p {
      background-color: #ff4b2b;
      color: #000;
      padding: 10px 15px;
      border-radius: 12px;
      width: fit-content;
      max-width: 70%;
      margin-bottom: 10px;
      word-wrap: break-word;
    }

    .user-msg {
      align-self: flex-end;
      background-color: #333 !important;
      color: #fff !important;
    }

    .typing-indicator {
      font-style: italic;
      opacity: 0.7;
      color: #999;
    }

    .chat-footer {
      padding: 1rem;
      border-top: 2px solid #333;
      background-color: #1e1e1e;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .chat-footer input[type="text"] {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #333;
      border-radius: 25px;
      background-color: #2c2c2c;
      color: #fff;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .chat-footer input[type="text"]:focus {
      outline: none;
      border-color: #ff4b2b;
    }

    .chat-footer input::placeholder {
      color: #aaa;
    }

    .emoji-btn, .file-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      color: #ff4b2b;
      padding: 8px;
      border-radius: 50%;
      transition: background-color 0.3s;
    }

    .emoji-btn:hover, .file-btn:hover {
      background-color: rgba(255, 75, 43, 0.1);
    }

    .send-btn {
      padding: 12px 16px;
      background: linear-gradient(135deg, #ff4b2b, #ff8a50);
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .send-btn:hover {
      background: linear-gradient(135deg, #e63946, #ff6b47);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(255, 75, 43, 0.3);
    }

    .send-btn:active {
      transform: translateY(0);
    }

    .chat-welcome {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .welcome-icon {
      font-size: 4rem;
      color: #ff4b2b;
      margin-bottom: 20px;
      opacity: 0.8;
    }

    .chat-welcome h3 {
      color: #ff4b2b;
      margin-bottom: 10px;
      font-size: 1.5rem;
    }

    .chat-welcome p {
      margin-bottom: 30px;
      color: #aaa;
      max-width: 400px;
      line-height: 1.5;
    }

    .collaboration-quick-access {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      max-width: 500px;
      width: 100%;
    }

    .quick-action-btn {
      background: rgba(255, 75, 43, 0.1);
      border: 1px solid #ff4b2b;
      color: #ff4b2b;
      padding: 15px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .quick-action-btn:hover {
      background: rgba(255, 75, 43, 0.2);
      transform: translateY(-2px);
    }

    .quick-action-btn i {
      font-size: 1.2rem;
    }

    .chat-toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .tool-btn {
      background: none;
      border: 1px solid #333;
      color: #ff4b2b;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tool-btn:hover {
      background: rgba(255, 75, 43, 0.1);
      border-color: #ff4b2b;
    }

    .send-btn i {
      font-size: 0.9rem;
    }

    #file-upload {
      display: none;
    }

    .group-item {
      cursor: pointer;
      transition: background 0.3s;
    }

    .group-item:hover {
      background-color: #3a3a3a;
    }

    /* Group Management Modal Styles */
    .group-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .group-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .group-modal {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 16px;
      width: 90%;
      max-width: 1200px;
      max-height: 90vh;
      overflow: hidden;
      transform: scale(0.9);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .group-modal-overlay.active .group-modal {
      transform: scale(1);
    }

    .modal-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .modal-tabs {
      flex-shrink: 0;
      border-bottom: 1px solid #333;
    }

    .modal-tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .modal-tab-content::-webkit-scrollbar {
      display: none;
    }

    .modal-tab-content.active {
      display: block;
    }

    .schedule-session-modal {
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .schedule-session-modal::-webkit-scrollbar {
      display: none;
    }

    .empty-resources {
      text-align: center;
      padding: 3rem 2rem;
      color: #888;
    }

    .empty-resources i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-resources h4 {
      margin-bottom: 0.5rem;
      color: #ccc;
    }

    .empty-resources p {
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .modal-header {
      background: linear-gradient(135deg, #ff4b2b, #ff8a50);
      padding: 20px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
    }

    .modal-header h2 {
      color: white;
      margin: 0;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background-color 0.3s;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .modal-content {
      height: calc(80vh - 80px);
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .modal-content::-webkit-scrollbar {
      display: none;
    }

    .modal-tabs {
      display: flex;
      background: #222;
      border-bottom: 1px solid #333;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .modal-tabs::-webkit-scrollbar {
      display: none;
    }

    .modal-tab {
      background: none;
      border: none;
      color: #aaa;
      padding: 15px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
    }

    .modal-tab:hover {
      background: #333;
      color: #fff;
    }

    .modal-tab.active {
      color: #ff4b2b;
      border-bottom-color: #ff4b2b;
      background: #2a2a2a;
    }

    .modal-tab i {
      margin-right: 8px;
    }

    .modal-tab-content {
      display: none;
      padding: 20px;
    }

    .modal-tab-content.active {
      display: block;
    }

    /* Overview Tab Styles */
    .group-overview {
      display: grid;
      gap: 20px;
      grid-template-columns: 1fr 1fr;
    }

    .overview-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
    }

    .overview-card h3 {
      color: #ff4b2b;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-item {
      margin-bottom: 12px;
    }

    .info-item label {
      font-weight: 600;
      color: #ff4b2b;
      margin-right: 10px;
    }

    .info-item span, .info-item p {
      color: #ddd;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-badge.active {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 1px solid #22c55e;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .stat-box {
      text-align: center;
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 8px;
    }

    .stat-number {
      font-size: 1.5rem;
      font-weight: 600;
      color: #ff4b2b;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #aaa;
    }

    .activity-feed {
      max-height: 200px;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .activity-feed::-webkit-scrollbar {
      display: none;
    }

    .activity-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      gap: 12px;
    }

    .activity-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .activity-icon.online {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .activity-icon.file {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .activity-icon.session {
      background: rgba(168, 85, 247, 0.2);
      color: #a855f7;
    }

    .activity-content {
      flex: 1;
      color: #ddd;
    }

    .activity-time {
      font-size: 0.8rem;
      color: #aaa;
      margin-top: 4px;
    }

    /* Members Tab Styles */
    .members-management {
      color: #fff;
    }

    .members-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .members-header h3 {
      color: #ff4b2b;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
    }

    .members-list-detailed {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .member-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.2s ease;
    }
    
    .member-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 75, 43, 0.3);
    }

    .member-avatar {
      position: relative;
      flex-shrink: 0;
      width: 50px;
      height: 50px;
    }

    .member-avatar img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid #333;
      object-fit: cover;
    }
    
    .member-avatar > div:first-of-type {
      width: 50px !important;
      height: 50px !important;
    }

    .status-indicator {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid #1a1a2e;
    }

    .status-indicator.online {
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
    }

    .status-indicator.offline {
      background: #6b7280;
    }

    .status-indicator.away {
      background: #fbbf24;
      box-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
    }

    .member-info {
      flex: 1;
      min-width: 0;
    }

    .member-name {
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .member-role {
      color: #ff4b2b;
      font-size: 0.85rem;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .member-activity {
      color: #888;
      font-size: 0.8rem;
    }

    .member-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .action-btn {
      background: rgba(255, 75, 43, 0.1);
      border: 1px solid #ff4b2b;
      color: #ff4b2b;
      width: 36px;
      height: 36px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .action-btn:hover {
      background: #ff4b2b;
      color: white;
    }
    
    /* No members/activity message styles */
    .no-members-message, .no-activity {
      text-align: center;
      padding: 40px 20px;
      color: #888;
    }
    
    .no-members-message i, .no-activity i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    .no-members-message p, .no-activity p {
      font-size: 1rem;
      margin: 0;
    }
    
    /* Admin role badge */
    .admin-role-badge {
      background: linear-gradient(135deg, #ffd700, #ffaa00);
      color: #000;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .admin-role-badge i {
      font-size: 0.7rem;
    }
    
    /* Loading states */
    .loading-resources, .loading-members {
      text-align: center;
      padding: 40px;
      color: #888;
    }
    
    .loading-resources i, .loading-members i {
      font-size: 2rem;
      margin-bottom: 10px;
      color: #ff4b2b;
    }

    /* Collaboration Tab Styles */
    .collaboration-tools {
      color: #fff;
    }

    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .tool-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tool-card:hover {
      background: rgba(255, 75, 43, 0.1);
      border-color: #ff4b2b;
      transform: translateY(-2px);
    }

    .tool-icon {
      font-size: 2rem;
      color: #ff4b2b;
      margin-bottom: 12px;
    }

    .tool-title {
      font-weight: 600;
      margin-bottom: 8px;
    }

    .tool-description {
      color: #aaa;
      font-size: 0.9rem;
    }

    /* Session Scheduling Modal Styles */
    .schedule-modal {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        color: white;
        box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    }

    .schedule-form {
        padding: 30px;
    }

    .form-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .form-section h4 {
        color: #ffffff;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-section h4 i {
        background: rgba(255, 75, 43, 0.2);
        padding: 8px;
        border-radius: 8px;
        font-size: 14px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
        color: #ffffff;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 14px;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #ff4b2b;
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 20px rgba(255, 75, 43, 0.3);
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }

    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .radio-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .radio-option {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        cursor: pointer;
        padding: 15px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
        transition: all 0.3s ease;
    }

    .radio-option:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 75, 43, 0.5);
    }

    .radio-option input[type="radio"] {
        width: auto;
        margin: 0;
        accent-color: #ff4b2b;
    }

    .radio-option span {
        font-weight: 500;
        color: white;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .radio-option small {
        display: block;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 4px;
        font-size: 12px;
    }

    .expertise-tags {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin-top: 10px;
    }

    .tag-option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
    }

    .tag-option:hover {
        background: rgba(255, 75, 43, 0.2);
    }

    .tag-option input[type="checkbox"] {
        width: auto;
        margin: 0;
        accent-color: #ff4b2b;
    }

    .participant-list {
        margin-bottom: 20px;
    }

    .participant-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        margin-bottom: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .participant-item img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    .participant-info {
        flex: 1;
    }

    .participant-name {
        font-weight: 500;
        color: white;
        display: block;
    }

    .participant-email {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.7);
        display: block;
        margin-top: 2px;
    }

    .role-tag {
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .role-tag.organizer {
        background: linear-gradient(135deg, #ff4b2b, #ff416c);
        color: white;
    }

    .role-tag.invited {
        background: rgba(33, 150, 243, 0.8);
        color: white;
    }

    .role-tag.member {
        background: rgba(76, 175, 80, 0.8);
        color: white;
    }

    .remove-participant {
        background: rgba(244, 67, 54, 0.2);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #ff4757;
        transition: all 0.3s ease;
    }

    .remove-participant:hover {
        background: rgba(244, 67, 54, 0.4);
        color: white;
    }

    .invite-section {
        margin-top: 20px;
    }

    .invite-input-group {
        display: flex;
        gap: 12px;
        margin-bottom: 15px;
    }

    .invite-input-group input {
        flex: 1;
    }

    .invite-btn {
        background: linear-gradient(135deg, #ff4b2b, #ff416c);
        border: none;
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }

    .invite-btn:hover {
        background: linear-gradient(135deg, #ff416c, #ff4b2b);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 75, 43, 0.3);
    }

    .invite-suggestions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .invite-suggestions span {
        color: rgba(255, 255, 255, 0.8);
        font-size: 13px;
    }

    .suggestion-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
    }

    .suggestion-btn:hover {
        background: rgba(255, 75, 43, 0.2);
        border-color: rgba(255, 75, 43, 0.5);
    }

    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
    }

    .checkbox-option {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        cursor: pointer;
        padding: 12px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }

    .checkbox-option:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 75, 43, 0.3);
    }

    .checkbox-option input[type="checkbox"] {
        width: auto;
        margin: 0;
        accent-color: #ff4b2b;
        margin-top: 2px;
    }

    .checkbox-option span {
        font-weight: 500;
        color: white;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .checkbox-option span i {
        color: rgba(255, 75, 43, 0.8);
    }

    .checkbox-option small {
        display: block;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 4px;
        font-size: 11px;
    }

    /* Notification Popup Styles */
    .notification-popup {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10001;
        max-width: 400px;
        border-radius: 12px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        animation: slideInRight 0.4s ease-out;
    }

    .notification-popup.success {
        background: linear-gradient(135deg, #4CAF50, #45a049);
    }

    .notification-popup.info {
        background: linear-gradient(135deg, #2196F3, #1976D2);
    }

    .notification-popup.warning {
        background: linear-gradient(135deg, #FF9800, #F57C00);
    }

    .notification-content {
        padding: 20px;
        color: white;
        display: flex;
        gap: 15px;
        align-items: flex-start;
    }

    .notification-icon {
        font-size: 24px;
        margin-top: 2px;
    }

    .notification-text h4 {
        margin: 0 0 8px 0;
        font-size: 16px;
        font-weight: 600;
    }

    .notification-text p {
        margin: 4px 0;
        font-size: 13px;
        opacity: 0.9;
    }

    .notification-close {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
        transition: all 0.3s ease;
        margin-left: auto;
    }

    .notification-close:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* Empty State Styles */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: rgba(255, 255, 255, 0.8);
    }

    .empty-state i {
        font-size: 48px;
        color: rgba(255, 75, 43, 0.5);
        margin-bottom: 20px;
    }

    .empty-state h3 {
        font-size: 24px;
        margin-bottom: 10px;
        color: white;
    }

    .empty-state p {
        font-size: 16px;
        margin-bottom: 30px;
        opacity: 0.8;
    }

    /* Enhanced Session Card Styles */
    .session-card {
        position: relative;
        overflow: hidden;
    }

    .session-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #ff4b2b, #ff416c);
    }

    .session-meta {
        display: flex;
        gap: 15px;
        margin-bottom: 10px;
    }

    .session-subject,
    .session-level {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 12px;
        background: rgba(255, 75, 43, 0.1);
        color: #ff4b2b;
    }

    .session-level.beginner {
        background: rgba(76, 175, 80, 0.1);
        color: #4CAF50;
    }

    .session-level.intermediate {
        background: rgba(255, 152, 0, 0.1);
        color: #FF9800;
    }

    .session-level.advanced {
        background: rgba(244, 67, 54, 0.1);
        color: #F44336;
    }

    .mentor-badge {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        margin-left: 10px;
    }

    .session-description {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 10px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border-left: 3px solid #ff4b2b;
    }

    .action-btn.primary {
        background: linear-gradient(135deg, #ff4b2b, #ff416c);
        color: white;
    }

    .action-btn.danger {
        background: rgba(244, 67, 54, 0.1);
        color: #F44336;
    }

    .action-btn.danger:hover {
        background: rgba(244, 67, 54, 0.2);
    }

    /* Sessions Tab Styles */
    .sessions-management {
      color: #fff;
      padding: 10px;
    }

    .sessions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sessions-header-content h3 {
      color: #ff4b2b;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0 0 5px 0;
      font-size: 1.3rem;
    }

    .sessions-header-content p {
      color: #aaa;
      margin: 0;
      font-size: 0.9rem;
    }

    .sessions-view-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.05);
      padding: 5px;
      border-radius: 8px;
      width: fit-content;
    }

    .view-toggle-btn {
      background: transparent;
      border: none;
      color: #aaa;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .view-toggle-btn.active {
      background: #ff4b2b;
      color: white;
    }

    .view-toggle-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .sessions-view {
      display: none;
    }

    .sessions-view.active {
      display: block;
    }

    .sessions-header h3 {
      color: #ff4b2b;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
    }

    .sessions-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .loading-sessions {
      text-align: center;
      padding: 40px;
      color: #aaa;
    }

    .loading-sessions i {
      font-size: 2rem;
      margin-bottom: 10px;
      color: #ff4b2b;
    }

    .session-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      transition: all 0.3s ease;
    }

    .session-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 75, 43, 0.3);
    }

    .session-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .session-card.upcoming .session-status {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .session-card.completed .session-status {
      background: rgba(107, 114, 128, 0.2);
      color: #6b7280;
    }

    /* Live session styles */
    .session-card.live {
      border-color: rgba(255, 75, 43, 0.5);
      background: rgba(255, 75, 43, 0.08);
      animation: liveGlow 2s ease-in-out infinite;
    }

    @keyframes liveGlow {
      0%, 100% {
        box-shadow: 0 0 5px rgba(255, 75, 43, 0.3);
      }
      50% {
        box-shadow: 0 0 20px rgba(255, 75, 43, 0.5);
      }
    }

    .session-status.live {
      background: rgba(255, 75, 43, 0.3) !important;
      color: #ff4b2b !important;
      animation: livePulse 1.5s ease-in-out infinite;
    }

    @keyframes livePulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }

    .session-card.ended {
      opacity: 0.6;
    }

    .session-status.ended {
      background: rgba(107, 114, 128, 0.2) !important;
      color: #6b7280 !important;
    }

    /* Session countdown */
    .session-countdown {
      color: #f59e0b;
      font-size: 0.85rem;
      margin: 6px 0;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(245, 158, 11, 0.15);
      border-radius: 6px;
      width: fit-content;
    }

    .session-countdown i {
      animation: hourglassSpin 2s ease-in-out infinite;
    }

    @keyframes hourglassSpin {
      0%, 100% {
        transform: rotate(0deg);
      }
      50% {
        transform: rotate(180deg);
      }
    }

    /* Live join button */
    .action-btn.live {
      background: linear-gradient(135deg, #ff4b2b 0%, #ff416c 100%);
      color: white;
      animation: liveButtonPulse 1.5s ease-in-out infinite;
    }

    .action-btn.live:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(255, 75, 43, 0.4);
    }

    @keyframes liveButtonPulse {
      0%, 100% {
        box-shadow: 0 0 5px rgba(255, 75, 43, 0.3);
      }
      50% {
        box-shadow: 0 0 15px rgba(255, 75, 43, 0.5);
      }
    }

    /* Disabled button styles */
    .action-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .action-btn[disabled] {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
      background: rgba(107, 114, 128, 0.2);
    }

    /* Joining state button */
    .action-btn.joining {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      pointer-events: none;
      cursor: wait;
    }

    .action-btn.joining i {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .session-info {
      flex: 1;
    }

    .session-info h4 {
      margin: 0 0 8px 0;
      font-size: 1.1rem;
    }

    .session-time, .session-participants {
      color: #aaa;
      font-size: 0.9rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
    }

    .session-time i, .session-participants i {
      margin-right: 8px;
      width: 16px;
    }

    .session-actions {
      display: flex;
      gap: 8px;
    }

    /* Calendar View Styles */
    .calendar-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .calendar-header h3 {
      margin: 0;
      color: #ff4b2b;
    }

    .calendar-nav-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.3s;
    }

    .calendar-nav-btn:hover {
      background: #ff4b2b;
    }

    .calendar-days-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-bottom: 10px;
    }

    .calendar-day-header {
      text-align: center;
      padding: 10px;
      color: #ff4b2b;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .btn-join {
      background: linear-gradient(135deg, #ff4b2b, #ff8a50);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-join:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 75, 43, 0.3);
    }

    .btn-edit, .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #ddd;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-edit:hover, .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Resources Tab Styles */
    .resources-management {
      color: #fff;
    }

    .resources-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .resources-header h3 {
      color: #ff4b2b;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
    }

    .resources-grid {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    
    .empty-resources {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }
    
    .empty-resources i {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
      color: #ff4b2b;
    }
    
    .empty-resources h4 {
      color: #ccc;
      margin-bottom: 10px;
      font-size: 1.2rem;
    }
    
    .empty-resources p {
      font-size: 0.95rem;
      max-width: 300px;
      margin: 0 auto;
    }
    
    .loading-resources {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }
    
    .loading-resources i {
      font-size: 2.5rem;
      margin-bottom: 15px;
      color: #ff4b2b;
    }
    
    .loading-resources p {
      font-size: 1rem;
    }

    .resource-category {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .resource-category h4 {
      color: #ff4b2b;
      margin: 0 0 15px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
    }

    .resource-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .resource-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 75, 43, 0.3);
    }

    .resource-item:last-child {
      margin-bottom: 0;
    }

    .resource-icon {
      color: #ff4b2b;
      font-size: 1.5rem;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 75, 43, 0.1);
      border-radius: 10px;
    }

    .resource-info {
      flex: 1;
    }

    .resource-name {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 1rem;
    }

    .resource-meta {
      color: #aaa;
      font-size: 0.85rem;
    }

    .resource-actions {
      display: flex;
      gap: 8px;
    }

    .resource-actions button {
      background: none;
      border: 1px solid #ff4b2b;
      color: #ff4b2b;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .resource-actions button:hover {
      background: #ff4b2b;
      color: white;
    }

    /* Settings Tab Styles */
    .group-settings {
      color: #fff;
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .settings-header h3 {
      color: #ff4b2b;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
    }

    .settings-section {
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .settings-section h4 {
      color: #ff4b2b;
      margin: 0 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
    }

    .setting-item {
      margin-bottom: 15px;
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      transition: background 0.3s ease;
    }

    .setting-item:hover {
      background: rgba(255, 255, 255, 0.06);
    }

    .setting-item:last-child {
      margin-bottom: 0;
    }

    .setting-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      gap: 12px;
      font-size: 0.95rem;
    }

    .setting-label input[type="checkbox"] {
      margin: 0;
      width: 18px;
      height: 18px;
      accent-color: #ff4b2b;
      cursor: pointer;
    }

    .danger-zone {
      border-color: rgba(239, 68, 68, 0.5);
      background: rgba(239, 68, 68, 0.05);
    }

    .danger-zone h4 {
      color: #ef4444;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    /* Button Primary Styles */
    .btn-primary {
      background: linear-gradient(135deg, #ff4b2b, #ff8a50);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(255, 75, 43, 0.4);
    }

    @media (max-width: 768px) {
      .group-overview {
        grid-template-columns: 1fr;
      }

      .tools-grid {
        grid-template-columns: 1fr 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .modal-tabs {
        flex-wrap: wrap;
      }

      .modal-tab {
        flex: 1;
        min-width: 120px;
      }
    }

    /* Enhanced responsive styles */
    @media (max-width: 1024px) {
      .sidebar { width: 40%; }
      .main-content { width: 60%; }
    }

    @media (max-width: 768px) {
      .chart-container { flex-direction: column; height: auto; min-height: 100vh; }
      .sidebar { width: 100%; max-width: 100%; border-right: none; border-bottom: 1px solid #333; max-height: 250px; }
      .main-content { width: 100%; padding: 15px; }
      .tools-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
      .tool-card { padding: 15px; }
    }

    @media (max-width: 480px) {
      .sidebar { padding: 0.75rem; max-height: 200px; }
      .sidebar h2 { font-size: 1.1rem; }
      .main-content { padding: 10px; }
      .tools-grid { grid-template-columns: 1fr; }
      .tool-card { padding: 12px; }
      .modal-content { width: 95%; padding: 15px; }
      .modal-tab { min-width: 100px; font-size: 13px; }
    }

    @media (max-width: 360px) {
      .sidebar { padding: 0.5rem; }
      .sidebar h2 { font-size: 1rem; }
      .tool-card { padding: 10px; }
      .modal-tab { min-width: 80px; font-size: 12px; }
    }

    @media (orientation: landscape) and (max-height: 500px) {
      .chart-container { height: auto; }
      .sidebar { max-height: 150px; }
    }

    /* Group Info Modal Styles */
    #group-info-modal .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #group-info-modal .modal-content {
      background: white;
      border-radius: 12px;
      padding: 0;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    #group-info-modal .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #group-info-modal .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #group-info-modal .modal-body {
      padding: 20px;
    }

    #group-info-modal .group-info-section {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    #group-info-modal .group-info-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    #group-info-modal .group-info-section h3 {
      margin: 0 0 8px 0;
      color: #333;
      font-size: 16px;
      font-weight: 600;
    }

    #group-info-modal .group-info-section p {
      margin: 0;
      color: #666;
      font-size: 14px;
      line-height: 1.5;
    }

    /* Poll Styles */
    .poll-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .poll-modal-overlay.active {
      display: flex;
    }

    .poll-modal {
      background: linear-gradient(135deg, #1e1e1e, #2d2d2d);
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .poll-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: linear-gradient(135deg, #ff4b2b, #ff6b4a);
    }

    .poll-modal-header h3 {
      margin: 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .poll-modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .poll-modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .poll-modal-body {
      padding: 20px;
      overflow-y: auto;
      max-height: 50vh;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .poll-modal-body::-webkit-scrollbar {
      display: none;
    }

    .poll-form-group {
      margin-bottom: 20px;
    }

    .poll-form-group label {
      display: block;
      margin-bottom: 8px;
      color: #aaa;
      font-size: 13px;
      font-weight: 500;
    }

    .poll-input {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 12px 15px;
      color: #fff;
      font-size: 14px;
      outline: none;
      transition: all 0.3s;
    }

    .poll-input:focus {
      border-color: #ff4b2b;
      box-shadow: 0 0 10px rgba(255, 75, 43, 0.2);
    }

    .poll-options-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .poll-option-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .poll-option-row .poll-input {
      flex: 1;
    }

    .poll-remove-option {
      background: rgba(255, 75, 75, 0.2);
      border: none;
      color: #ff6b6b;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .poll-remove-option:hover {
      background: rgba(255, 75, 75, 0.4);
    }

    .poll-add-option {
      background: rgba(255, 255, 255, 0.05);
      border: 1px dashed rgba(255, 255, 255, 0.2);
      color: #aaa;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 13px;
    }

    .poll-add-option:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #ff4b2b;
      color: #ff4b2b;
    }

    .poll-settings {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .poll-checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 13px;
      color: #ccc;
    }

    .poll-checkbox-label input[type="checkbox"] {
      accent-color: #ff4b2b;
    }

    .poll-modal-footer {
      padding: 15px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .poll-btn {
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .poll-btn-cancel {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
    }

    .poll-btn-cancel:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .poll-btn-create {
      background: linear-gradient(135deg, #ff4b2b, #ff6b4a);
      border: none;
      color: #fff;
    }

    .poll-btn-create:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(255, 75, 43, 0.4);
    }

    /* Poll Message in Chat */
    .poll-message {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border-radius: 12px;
      padding: 15px;
      margin: 10px 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .poll-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .poll-icon {
      background: linear-gradient(135deg, #ff4b2b, #ff6b4a);
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .poll-title {
      flex: 1;
    }

    .poll-question {
      font-size: 15px;
      font-weight: 600;
      color: #fff;
      margin: 0;
    }

    .poll-meta {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }

    .poll-options-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .poll-option-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 12px 15px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .poll-option-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #ff4b2b;
    }

    .poll-option-item.voted {
      border-color: #00b894;
    }

    .poll-option-item.voted::before {
      content: '';
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #00b894;
      font-weight: bold;
    }

    .poll-option-progress {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: rgba(255, 75, 43, 0.15);
      transition: width 0.5s ease;
      z-index: 0;
    }

    .poll-option-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .poll-option-text {
      font-size: 14px;
      color: #fff;
    }

    .poll-option-stats {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #888;
    }

    .poll-option-percent {
      font-weight: 600;
      color: #ff4b2b;
    }

    .poll-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .poll-total-votes {
      font-size: 12px;
      color: #888;
    }

    .poll-end-time {
      font-size: 11px;
      color: #ff6b6b;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .poll-ended {
      background: rgba(255, 75, 75, 0.1);
      color: #ff6b6b;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="chart-container">
    <aside class="sidebar">
      <h2>
        Your Study Groups
        <button class="refresh-btn" onclick="refreshGroups()" title="Refresh Groups">
          <i class="fas fa-sync-alt"></i>
        </button>
      </h2>
      <div class="groups-container" id="groups-container">
        <!-- Dynamic group cards will be inserted here -->
      </div>
      <button class="join-new-group" onclick="window.location.href='../ml_model/input.html'">
        <i class="fas fa-plus"></i>
        Find New Groups
      </button>
    </aside>
    <main class="chat-main">
      <div class="chat-header">
        <h2 id="chat-header-title">
          <i class="fas fa-comments"></i>
          Select a Group to Chat
        </h2>
        <button class="group-info-btn" onclick="showGroupInfo()" title="Group Information" id="group-info-btn">
          <i class="fas fa-info-circle"></i> Group Details
        </button>
      </div>
      <div class="chat-body" id="chat-body">
        <div class="chat-welcome">
          <div class="welcome-icon">
            <i class="fas fa-comments"></i>
          </div>
          <h3>Welcome to Group Chat!</h3>
          <p>Select a group from the sidebar to start collaborating with your study partners.</p>
          <div class="collaboration-quick-access">
            <button onclick="startVideoCall()" class="quick-action-btn">
              <i class="fas fa-video"></i>
              <span>Video Call</span>
            </button>
            <button onclick="openWhiteboard()" class="quick-action-btn">
              <i class="fas fa-chalkboard"></i>
              <span>Whiteboard</span>
            </button>
            <button onclick="shareFiles()" class="quick-action-btn">
              <i class="fas fa-upload"></i>
              <span>Share Files</span>
            </button>
            <button onclick="scheduleSession()" class="quick-action-btn">
              <i class="fas fa-calendar-plus"></i>
              <span>Schedule</span>
            </button>
          </div>
        </div>
      </div>
      <div class="chat-footer">
          <div class="chat-toolbar">
            <button class="emoji-btn" id="emoji-btn" title="Add Emoji"></button>
            <button class="file-btn" onclick="shareFiles()" title="Share Files"></button>
            <button class="tool-btn" onclick="startScreenShare()" title="Share Screen">
              <i class="fas fa-desktop"></i>
            </button>
            <button class="tool-btn" onclick="createPoll()" title="Create Poll">
              <i class="fas fa-poll"></i>
            </button>
            <button class="tool-btn" onclick="openCodeEditor()" title="Code Together">
              <i class="fas fa-code"></i>
            </button>
            <button class="tool-btn" onclick="openWhiteboard()" title="Whiteboard">
              <i class="fas fa-chalkboard"></i>
            </button>
          </div>
          <input type="file" id="file-upload" multiple />
          
          <!-- Message input -->
          <input type="text" id="chat-input" placeholder="Type a message... (Press Enter to send)" onkeydown="if(event.key==='Enter') sendMessage()"/>

          <!-- Send button -->
          <button class="send-btn" id="send-btn" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
      </div>
    </main>
  </div>
  <script>
    // @ts-nocheck
    /* eslint-disable */
    // Global variables
    let socket;
    let selectedGroupName = null;
    let chatBody;
    let input;

    // ===== GLOBAL FUNCTIONS FOR HTML ONCLICK HANDLERS =====
    // These must be defined IMMEDIATELY so they're available when HTML loads
    
    function refreshGroups() {
      console.log(' refreshGroups function called (GLOBAL DEFINITION)');
      const button = event.target.closest('.refresh-btn');
      if (!button) {
        console.error(' Refresh button not found');
        return;
      }
      
      const originalHTML = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      button.disabled = true;
      
      // Use timeout to ensure loadMatchedGroups is defined
      setTimeout(() => {
        if (typeof loadMatchedGroups === 'function') {
          loadMatchedGroups().finally(() => {
            button.innerHTML = originalHTML;
            button.disabled = false;
          });
        } else {
          console.error('loadMatchedGroups function not found');
          button.innerHTML = originalHTML;
          button.disabled = false;
        }
      }, 100);
    }

    // Make function globally accessible immediately
    window.refreshGroups = refreshGroups;
    
    // Add missing navigation functions
    window.navigateMonth = function(direction) {
      if (typeof currentCalendarDate === 'undefined') {
        window.currentCalendarDate = new Date();
      }
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
      if (typeof updateCalendarDisplay === 'function') {
        updateCalendarDisplay();
      }
    };
    
    window.switchSessionView = function(viewType) {
      console.log('switchSessionView called with:', viewType);
      // Update toggle buttons
      document.querySelectorAll('.view-toggle-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.view === viewType) {
          btn.classList.add('active');
        }
      });

      // Show/hide views
      document.querySelectorAll('.sessions-view').forEach(view => {
        view.classList.remove('active');
      });

      if (viewType === 'calendar') {
        const calendarView = document.getElementById('sessionsCalendarView');
        if (calendarView) {
          calendarView.classList.add('active');
          if (typeof initializeCalendar === 'function') {
            initializeCalendar();
          }
        }
      } else {
        const listView = document.getElementById('sessionsListView');
        if (listView) {
          listView.classList.add('active');
        }
      }
    };
    
    window.selectCalendarDay = function(dateString) {
      const date = new Date(dateString);
      console.log('Selected date:', date.toDateString());
      
      if (confirm(`Schedule a session for ${date.toLocaleDateString()}?`)) {
        if (typeof scheduleSession === 'function') {
          scheduleSession();
        } else {
          alert('Schedule session feature will be available soon!');
        }
      }
    };
    
    // Add other missing function stubs that are properly defined
    window.startVideoCall = function() {
      console.log(' startVideoCall called');
      alert('Video call feature will be implemented soon!');
    };
    
    window.openWhiteboard = function() {
      if (!selectedGroupName) {
        Toast.warning('Please select a group first', 'No Group Selected');
        return;
      }
      
      // Open whiteboard in new window
      const width = 1200;
      const height = 800;
      const left = (screen.width - width) / 2;
      const top = (screen.height - height) / 2;
      
      window.open(
        `whiteboard.html?group=${encodeURIComponent(selectedGroupName)}`,
        'Whiteboard',
        `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
      );
    }; 
    
    window.shareFiles = function() {
      console.log(' shareFiles called');
      const fileInput = document.getElementById('file-upload');
      if (fileInput) {
        fileInput.click();
      } else {
        alert('File sharing is not available');
      }
    };
    
    window.startScreenShare = function() {
      console.log(' startScreenShare called');
      alert('Screen sharing feature will be implemented soon!');
    };
    
    window.createPoll = function() {
      console.log(' createPoll called');
      if (!selectedGroupName) {
        alert('Please select a group first');
        return;
      }
      document.getElementById('pollModal').classList.add('active');
      document.getElementById('pollQuestion').focus();
    };
    
    // openCodeEditor is defined later with full implementation
    window.closeGroupModal = function() {
      const modal = document.getElementById('group-management-modal');
      if (modal) modal.remove();
    };
    
    window.switchModalTab = function(tabName, buttonElement) {
      console.log(' switchModalTab called:', tabName);
      
      // Update active tab button
      document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
      if (buttonElement) buttonElement.classList.add('active');
      
      // Update active tab content - HIDE ALL FIRST
      document.querySelectorAll('.modal-tab-content').forEach(content => {
        content.classList.remove('active');
        content.style.display = 'none';
      });
      
      const targetContent = document.getElementById(`${tabName}-content`);
      console.log(`Target content element for ${tabName}:`, targetContent);
      
      if (targetContent) {
        targetContent.classList.add('active');
        targetContent.style.display = 'block';
        console.log(` Successfully switched to ${tabName} tab`);
        
        // Load content when specific tabs are opened
        if (tabName === 'resources' && typeof refreshResourcesSection === 'function') {
          refreshResourcesSection();
        } else if (tabName === 'sessions' && typeof refreshSessionsView === 'function') {
          refreshSessionsView();
        }
      } else {
        console.error(`Could not find content element: ${tabName}-content`);
      }
    };
    
    window.showInviteModal = function() {
      console.log(' showInviteModal called');
      alert('Invite members feature coming soon!');
    };
    
    window.startPrivateChat = function(user) {
      console.log(' startPrivateChat called:', user);
      alert(`Starting private chat with ${user}...`);
    };
    
    window.viewMemberProfile = function(user) {
      console.log(' viewMemberProfile called:', user);
      alert(`Viewing profile of ${user}...`);
    };
    
    window.scheduleSession = function(groupId = null) {
      console.log(' scheduleSession called with groupId:', groupId);
      
      // Use the selected group name instead of trying to get an ID
      let groupName = null;
      if (!groupId || groupId === 'current') {
        if (selectedGroupName) {
          groupName = selectedGroupName;
          console.log('Using selected group name:', groupName);
        } else {
          alert('Please select a group first before scheduling a session.');
          return;
        }
      } else {
        groupName = groupId;
      }
      
      if (typeof showScheduleSessionModal === 'function') {
        showScheduleSessionModal(groupName);
      } else {
        alert('Session scheduling feature will be implemented soon!');
      }
    };
    
    // Add missing resource management functions
    window.uploadResource = function() {
      console.log('uploadResource() called');
      if (!selectedGroupName) {
        alert('Please select a group first');
        return;
      }
      
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.pdf,.doc,.docx,.ppt,.pptx,.txt,.jpg,.png,.zip';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        console.log('File selected for upload:', {
          name: file.name,
          size: file.size,
          type: file.type
        });
        
        if (typeof uploadFileToGroup === 'function') {
          uploadFileToGroup(file, selectedGroupName);
        } else {
          alert('File upload feature will be available soon!');
        }
      };
      input.click();
    };
    
    window.downloadFile = function(filename) {
      alert(`Downloading: ${filename}\n\nFile will be saved to your Downloads folder.`);
    };
    
    window.openSharedNote = function(noteId) {
      alert(`Opening shared note: ${noteId}\n\nFeatures:\n Real-time collaboration\n Version history\n Comments and suggestions`);
    };
    
    window.openLink = function(linkId) {
      alert(`Opening link: ${linkId}\n\nThis will open in a new tab.`);
    };
    
    // Session join state management - prevent concurrent clicks
    const sessionJoinState = {
      isJoining: false,
      joiningSessionId: null,
      lastJoinAttempt: 0,
      debounceDelay: 2000, // 2 seconds between join attempts
      activeJoiners: new Set() // Track active joining sessions
    };
    
    // Add session management functions
    window.joinSession = async function(sessionId) {
      console.log('Joining session:', sessionId);
      
      const now = Date.now();
      
      // Prevent rapid clicking (debounce)
      if (now - sessionJoinState.lastJoinAttempt < sessionJoinState.debounceDelay) {
        console.log('Join attempt blocked - too soon after last attempt');
        return;
      }
      
      // Prevent joining if already in process for this session
      if (sessionJoinState.activeJoiners.has(sessionId)) {
        console.log('Already joining this session');
        return;
      }
      
      // Prevent joining multiple sessions at once
      if (sessionJoinState.isJoining) {
        alert('Please wait, already joining a session...');
        return;
      }
      
      // Set joining state
      sessionJoinState.isJoining = true;
      sessionJoinState.joiningSessionId = sessionId;
      sessionJoinState.lastJoinAttempt = now;
      sessionJoinState.activeJoiners.add(sessionId);
      
      // Update button UI to show loading state
      const joinBtn = document.querySelector(`button[onclick="joinSession('${sessionId}')"]`);
      let originalBtnHTML = '';
      if (joinBtn) {
        originalBtnHTML = joinBtn.innerHTML;
        joinBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Joining...';
        joinBtn.disabled = true;
        joinBtn.classList.add('joining');
      }
      
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('Please login to join the session');
          return;
        }
        
        // Get session from localStorage to check time
        const sessions = JSON.parse(localStorage.getItem('scheduledSessions') || '[]');
        const session = sessions.find(s => s.id === sessionId);
        
        if (session) {
          const currentTime = new Date();
          const sessionStart = new Date(`${session.date}T${session.startTime}`);
          const sessionEnd = new Date(sessionStart.getTime() + (session.duration * 60 * 60 * 1000));
          
          // Allow joining 5 minutes before the scheduled time
          const earlyJoinWindow = 5 * 60 * 1000; // 5 minutes in milliseconds
          const canJoinFrom = new Date(sessionStart.getTime() - earlyJoinWindow);
          
          if (currentTime < canJoinFrom) {
            // Session hasn't started yet
            const timeUntilStart = sessionStart - currentTime;
            const hours = Math.floor(timeUntilStart / (1000 * 60 * 60));
            const minutes = Math.floor((timeUntilStart % (1000 * 60 * 60)) / (1000 * 60));
            
            let timeMessage = '';
            if (hours > 0) {
              timeMessage = `${hours} hour${hours > 1 ? 's' : ''} and ${minutes} minute${minutes !== 1 ? 's' : ''}`;
            } else {
              timeMessage = `${minutes} minute${minutes !== 1 ? 's' : ''}`;
            }
            
            alert(` Session Not Available Yet\n\nThis session is scheduled to start at ${sessionStart.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true})} on ${sessionStart.toLocaleDateString()}.\n\nTime remaining: ${timeMessage}\n\nYou can join 5 minutes before the scheduled time.`);
            return;
          }
          
          if (currentTime > sessionEnd) {
            // Session has ended
            alert(` Session Ended\n\nThis session has already ended at ${sessionEnd.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true})}.\n\nPlease schedule a new session or check other upcoming sessions.`);
            return;
          }
        }
        
        // Small delay to prevent race conditions on server
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // Fetch session details to get room code from server
        const response = await fetch(`${window.location.origin}/api/sessions/${sessionId}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const serverSession = await response.json();
          const roomCode = serverSession.roomCode || sessionId;
          window.location.href = `../mentorDash/videoRoom.html?room=${roomCode}`;
        } else {
          // If no specific session found, use sessionId as room code
          window.location.href = `../mentorDash/videoRoom.html?room=${sessionId}`;
        }
      } catch (err) {
        console.error('Error joining session:', err);
        // Fallback - just use sessionId as room code
        window.location.href = `../mentorDash/videoRoom.html?room=${sessionId}`;
      } finally {
        // Reset joining state after a delay (in case redirect doesn't happen)
        setTimeout(() => {
          sessionJoinState.isJoining = false;
          sessionJoinState.joiningSessionId = null;
          sessionJoinState.activeJoiners.delete(sessionId);
          
          // Restore button if still on page
          if (joinBtn && document.body.contains(joinBtn)) {
            joinBtn.innerHTML = originalBtnHTML;
            joinBtn.disabled = false;
            joinBtn.classList.remove('joining');
          }
        }, 3000);
      }
    };
    
    window.editSession = function(sessionId) {
      alert(`Editing session: ${sessionId}\n\nYou can modify:\n Date and time\n Duration\n Participants`);
    };
    
    window.cancelSession = function(sessionId) {
      if (confirm('Are you sure you want to cancel this session?')) {
        alert('Session cancelled successfully!');
        if (typeof loadScheduledSessions === 'function') {
          loadScheduledSessions();
        }
      }
    };
    
    window.viewSession = function(sessionId) {
      alert(`Viewing session details: ${sessionId}`);
    };
    
    // Add missing calendar functions  
    window.initializeCalendar = function() {
      if (typeof updateCalendarDisplay === 'function') {
        updateCalendarDisplay();
      }
      if (typeof loadUpcomingSessions === 'function') {
        loadUpcomingSessions();
      }
    };
    
    // Add settings functions
    window.leaveGroup = function() {
      if (confirm('Are you sure you want to leave this group?\n\nThis action cannot be undone.')) {
        alert('You have successfully left the group.');
        if (typeof closeGroupModal === 'function') {
          closeGroupModal();
        }
      }
    };
    window.showGroupInfo = async () => {
      console.log(' showGroupInfo called');
      if (!selectedGroupName) {
        alert('Please select a group first');
        return;
      }
      
      const selectedCard = document.querySelector('.group-card.selected-group');
      
      // Try to fetch real group data from API
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${window.location.origin}/api/groups/${encodeURIComponent(selectedGroupName)}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          const groupData = {
            name: data.name,
            description: data.description || 'No description',
            status: data.status || 'active',
            category: data.category || 'General',
            members: data.members || [],
            totalMembers: data.totalMembers || 0,
            activeMembers: data.activeMembers || 0,
            stats: data.stats || { totalMessages: 0, totalFiles: 0, totalSessions: 0 },
            recentActivity: data.recentActivity || [],
            progress: data.progress || { percentage: 0, milestones: [] },
            userRole: data.userRole || 'member',
            isAdmin: data.isAdmin || false,
            isMember: data.isMember || true,
            createdAt: data.createdAt
          };
          console.log(' Group data from API:', groupData);
          showGroupManagementModal(groupData);
        } else {
          // Fallback to card data
          console.log(' API failed, using card data');
          const groupData = {
            name: selectedGroupName,
            description: selectedCard?.querySelector('.group-description')?.textContent || 'Study group',
            status: selectedCard?.querySelector('.group-status')?.textContent || 'active',
            members: [],
            totalMembers: parseInt(selectedCard?.querySelector('.stat-value')?.textContent) || 0,
            activeMembers: 0,
            stats: { totalMessages: 0, totalFiles: 0, totalSessions: 0 },
            recentActivity: [],
            isAdmin: false,
            createdAt: new Date()
          };
          showGroupManagementModal(groupData);
        }
      } catch (err) {
        console.error('Error fetching group data:', err);
        // Fallback to basic data
        const groupData = {
          name: selectedGroupName,
          description: selectedCard?.querySelector('.group-description')?.textContent || 'Study group',
          status: selectedCard?.querySelector('.group-status')?.textContent || 'active',
          members: [],
          totalMembers: parseInt(selectedCard?.querySelector('.stat-value')?.textContent) || 0,
          activeMembers: 0,
          stats: { totalMessages: 0, totalFiles: 0, totalSessions: 0 },
          recentActivity: [],
          isAdmin: false,
          createdAt: new Date()
        };
        showGroupManagementModal(groupData);
      }
    };
    
    // handleGroupSelection is defined later in the file with full functionality
    // Just ensure it's accessible globally
    window.handleGroupSelection = async function(groupName, element) {
      // Call the main handleGroupSelection function defined below
      await handleGroupSelectionMain(groupName, element);
    };

    console.log(' Global functions registered immediately at script load');
    // ===== END GLOBAL FUNCTIONS =====

    // Test function for modal - defined globally
    function testShowModal() {
      console.log(' testShowModal function called (GLOBAL VERSION)');
      
      const testGroupData = {
        name: 'CS-ML-2024',
        members: 5,
        status: 'Active',
        description: 'Computer Science & Machine Learning study group for 2024'
      };
      
      console.log(' Test group data prepared:', testGroupData);
      console.log(' About to call showGroupManagementModal...');
      
      try {
        showGroupManagementModal(testGroupData);
        console.log(' showGroupManagementModal called successfully');
      } catch (error) {
        console.error(' Error in showGroupManagementModal:', error);
      }
    }

    // Current user info for messages
    let currentUser = {
      id: null,
      name: 'User',
      email: '',
      avatar: '',
      role: 'member'
    };

    // Load current user info from token
    async function loadCurrentUserInfo() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          console.warn('No token found, using default user');
          return;
        }
        
        const response = await fetch(`${window.location.origin}/api/profile`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          currentUser = {
            id: data._id || data.userId || data.id,
            name: data.fullname || data.username || data.name || 'User',
            email: data.email || '',
            avatar: data.avatar || '',
            role: 'member'
          };
          console.log(' Current user loaded:', currentUser.name, 'ID:', currentUser.id);
        } else {
          console.warn('Failed to load profile, status:', response.status);
        }
      } catch (err) {
        console.error('Error loading user info:', err);
      }
    }

    // Enhanced message rendering function
    function appendEnhancedMessage(messageData) {
      if (!chatBody) {
        chatBody = document.querySelector('#chat-body');
      }
      
      if (!chatBody) {
        console.warn('Chat body element not found');
        return;
      }

      const isOwnMessage = messageData.senderId === currentUser.id || 
                           messageData.senderName === currentUser.name ||
                           messageData.isOwn;
      
      const senderName = messageData.senderName || messageData.sender || 'Unknown';
      const avatarColor = getAvatarColor(senderName);
      const initials = senderName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
      const timestamp = messageData.timestamp ? new Date(messageData.timestamp) : new Date();
      const formattedTime = timestamp.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      
      // Handle system messages
      if (messageData.messageType === 'system') {
        const systemMsg = document.createElement('div');
        systemMsg.className = 'system-message';
        systemMsg.innerHTML = `<i class="fas fa-info-circle"></i> ${messageData.message}`;
        chatBody.appendChild(systemMsg);
        chatBody.scrollTop = chatBody.scrollHeight;
        return;
      }

      const container = document.createElement('div');
      container.className = `message-container ${isOwnMessage ? 'own-message' : ''}`;
      container.dataset.messageId = messageData.messageId || messageData._id || '';

      // Build message HTML
      let messageHTML = `
        <div class="message-avatar" style="background-color: ${avatarColor}">
          ${messageData.senderAvatar ? 
            `<img src="${messageData.senderAvatar}" style="width:100%;height:100%;border-radius:50%;">` : 
            initials}
        </div>
        <div class="message-content">
          ${!isOwnMessage ? `
            <div class="message-header">
              <span class="message-sender">${senderName}</span>
              ${messageData.senderRole && messageData.senderRole !== 'member' ? 
                `<span class="message-role ${messageData.senderRole}">${messageData.senderRole}</span>` : ''}
              <span class="message-time">${formattedTime}</span>
            </div>
          ` : ''}
          ${messageData.isPinned ? '<div class="pinned-badge"><i class="fas fa-thumbtack"></i> Pinned</div>' : ''}
          <div class="message-bubble">
            <div class="message-text">${escapeHtml(messageData.message)}</div>
            ${messageData.isEdited ? '<div class="message-edited">(edited)</div>' : ''}
            <div class="message-actions">
              <button class="message-action-btn" onclick="reactToMessage('${messageData.messageId || ''}', '')" title="Like"></button>
              <button class="message-action-btn" onclick="reactToMessage('${messageData.messageId || ''}', '')" title="Love"></button>
              <button class="message-action-btn" onclick="replyToMessage('${messageData.messageId || ''}')" title="Reply"></button>
              ${isOwnMessage ? `
                <button class="message-action-btn" onclick="editMessage('${messageData.messageId || ''}')" title="Edit"></button>
                <button class="message-action-btn" onclick="deleteMessage('${messageData.messageId || ''}')" title="Delete"></button>
              ` : ''}
              <button class="message-action-btn" onclick="pinMessage('${messageData.messageId || ''}')" title="Pin"></button>
            </div>
          </div>
          ${messageData.attachment ? `
            <div class="message-attachment">
              <span class="attachment-icon">${getFileIcon(messageData.attachment.originalname || messageData.attachment.filename)}</span>
              <div class="attachment-info">
                <div class="attachment-name">${messageData.attachment.originalname || messageData.attachment.filename}</div>
                <div class="attachment-size">${formatFileSize(messageData.attachment.size || 0)}</div>
              </div>
              <button class="attachment-download" onclick="downloadGroupFile('${messageData.attachment.filename}', '${messageData.attachment.originalname}')">
                <i class="fas fa-download"></i> Download
              </button>
            </div>
          ` : ''}
          ${renderReactions(messageData.reactions || [])}
          ${renderReplies(messageData.replies || [])}
        </div>
      `;

      container.innerHTML = messageHTML;
      chatBody.appendChild(container);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Render reactions
    function renderReactions(reactions) {
      if (!reactions || reactions.length === 0) return '';
      
      // Group reactions by emoji
      const grouped = reactions.reduce((acc, r) => {
        acc[r.emoji] = acc[r.emoji] || [];
        acc[r.emoji].push(r.userName);
        return acc;
      }, {});

      const badges = Object.entries(grouped).map(([emoji, users]) => 
        `<div class="reaction-badge" title="${users.join(', ')}">${emoji} <span class="reaction-count">${users.length}</span></div>`
      ).join('');

      return `<div class="message-reactions">${badges}</div>`;
    }

    // Render replies
    function renderReplies(replies) {
      if (!replies || replies.length === 0) return '';
      
      const repliesHTML = replies.slice(0, 3).map(reply => `
        <div class="reply-item">
          <div class="reply-header">
            <span class="reply-sender">${reply.senderName}</span>
            <span>${getTimeAgo(reply.timestamp)}</span>
          </div>
          <div>${escapeHtml(reply.message)}</div>
        </div>
      `).join('');

      return `
        <div class="message-replies">
          ${repliesHTML}
          ${replies.length > 3 ? `<div class="reply-more">+${replies.length - 3} more replies</div>` : ''}
        </div>
      `;
    }

    // Get file icon based on extension
    function getFileIcon(filename) {
      if (!filename) return '';
      const ext = filename.split('.').pop()?.toLowerCase();
      const icons = {
        pdf: '', doc: '', docx: '', xls: '', xlsx: '',
        ppt: '', pptx: '', txt: '', csv: '',
        jpg: '', jpeg: '', png: '', gif: '',
        zip: '', rar: '', mp4: '', mp3: ''
      };
      return icons[ext] || '';
    }

    // Message action functions
    async function reactToMessage(messageId, emoji) {
      if (!messageId) return;
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${window.location.origin}/api/messages/${messageId}/react`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ emoji })
        });
        if (response.ok) {
          console.log('Reaction added');
        }
      } catch (err) {
        console.error('Error adding reaction:', err);
      }
    }

    async function replyToMessage(messageId) {
      if (!messageId) return;
      const reply = prompt('Enter your reply:');
      if (!reply) return;
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${window.location.origin}/api/messages/${messageId}/reply`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ message: reply })
        });
        if (response.ok) {
          console.log('Reply added');
        }
      } catch (err) {
        console.error('Error adding reply:', err);
      }
    }

    async function editMessage(messageId) {
      if (!messageId) return;
      const newMessage = prompt('Edit your message:');
      if (!newMessage) return;
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${window.location.origin}/api/messages/${messageId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ message: newMessage })
        });
        if (response.ok) {
          console.log('Message edited');
        }
      } catch (err) {
        console.error('Error editing message:', err);
      }
    }

    async function deleteMessage(messageId) {
      if (!messageId) return;
      if (!confirm('Delete this message?')) return;
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${window.location.origin}/api/messages/${messageId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          // Remove from DOM
          const msgEl = document.querySelector(`[data-message-id="${messageId}"]`);
          if (msgEl) msgEl.remove();
        }
      } catch (err) {
        console.error('Error deleting message:', err);
      }
    }

    async function pinMessage(messageId) {
      if (!messageId) return;
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${window.location.origin}/api/messages/${messageId}/pin`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          alert(data.message);
        }
      } catch (err) {
        console.error('Error pinning message:', err);
      }
    }

    // Load chat history from API
    async function loadChatHistory(groupName) {
      try {
        const response = await fetch(`${window.location.origin}/api/messages/${encodeURIComponent(groupName)}`);
        if (response.ok) {
          const data = await response.json();
          if (data.messages && data.messages.length > 0) {
            // Clear welcome message
            if (chatBody) {
              const welcome = chatBody.querySelector('.chat-welcome');
              if (welcome) welcome.remove();
            }
            
            // Add date separator for first message
            const firstDate = new Date(data.messages[0].timestamp).toLocaleDateString('en-US', {
              weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            const dateSep = document.createElement('div');
            dateSep.className = 'date-separator';
            dateSep.textContent = firstDate;
            chatBody.appendChild(dateSep);
            
            // Render all messages
            data.messages.forEach(msg => {
              appendEnhancedMessage({
                messageId: msg._id,
                senderId: msg.senderId?._id || msg.senderId,
                senderName: msg.senderName || msg.senderId?.fullname,
                senderAvatar: msg.senderAvatar || msg.senderId?.avatar,
                senderRole: msg.senderRole,
                message: msg.message,
                messageType: msg.messageType,
                attachment: msg.attachment,
                timestamp: msg.timestamp,
                isPinned: msg.isPinned,
                isEdited: msg.isEdited,
                reactions: msg.reactions,
                replies: msg.replies
              });
            });
          }
        }
      } catch (err) {
        console.error('Error loading chat history:', err);
      }
    }

    // Legacy appendMessage function - still works for simple messages
    function appendMessage(content, className = '', isHTML = false) {
      if (!chatBody) {
        chatBody = document.querySelector('#chat-body');
      }
      
      if (!chatBody) {
        console.warn('Chat body element not found');
        return;
      }
      
      const msg = document.createElement('p');
      if (className) {
        msg.classList.add(className);
      }
      
      if (isHTML) {
        msg.innerHTML = content;
      } else {
        msg.textContent = content;
      }

      chatBody.appendChild(msg);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // Store current group data for modal
    let currentGroupData = null;
    
    // Helper function to format time ago
    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - new Date(date);
      const diffSeconds = Math.floor(diffMs / 1000);
      const diffMinutes = Math.floor(diffSeconds / 60);
      const diffHours = Math.floor(diffMinutes / 60);
      const diffDays = Math.floor(diffHours / 24);
      
      if (diffSeconds < 60) return 'just now';
      if (diffMinutes < 60) return `${diffMinutes} minute${diffMinutes > 1 ? 's' : ''} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
      if (diffDays < 30) return `${Math.floor(diffDays / 7)} week${Math.floor(diffDays / 7) > 1 ? 's' : ''} ago`;
      return `${Math.floor(diffDays / 30)} month${Math.floor(diffDays / 30) > 1 ? 's' : ''} ago`;
    }
    
    // Generate avatar color based on name
    function getAvatarColor(name) {
      if (!name) return '#ff4b2b';
      const colors = ['#ff4b2b', '#2196F3', '#4CAF50', '#FF9800', '#9C27B0', '#00BCD4', '#E91E63', '#3F51B5'];
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      return colors[Math.abs(hash) % colors.length];
    }
    
    // Generate members HTML from real data
    function generateMembersHTML(members) {
      if (!members || members.length === 0) {
        return '<div class="no-members-message"><i class="fas fa-users"></i><p>No members in this group yet.</p></div>';
      }
      
      return members.map(member => {
        const name = member.name || 'Unknown';
        const initial = name.charAt(0).toUpperCase();
        const color = getAvatarColor(name);
        const status = member.status || 'offline';
        const role = member.role || 'member';
        const roleLabel = role === 'admin' ? 'Admin' : role === 'moderator' ? 'Moderator' : 'Member';
        const lastActive = member.lastActive ? getTimeAgo(new Date(member.lastActive)) : 'Unknown';
        const avatar = member.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`;
        const memberId = member.id || member.userId || '';
        
        return `
          <div class="member-card" data-member-id="${memberId}">
            <div class="member-avatar">
              <img src="${avatar}" alt="${name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
              <div style="width: 40px; height: 40px; background-color: ${color}; border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; font-weight: bold;">${initial}</div>
              <div class="status-indicator ${status}"></div>
            </div>
            <div class="member-info">
              <div class="member-name">${name} ${role === 'admin' ? '<i class="fas fa-crown" style="color: gold; margin-left: 5px;"></i>' : ''}</div>
              <div class="member-role">${roleLabel}</div>
              <div class="member-activity">${status.charAt(0).toUpperCase() + status.slice(1)}  Last active: ${lastActive}</div>
            </div>
            <div class="member-actions">
              <button onclick="startPrivateChat('${memberId}')" class="action-btn" title="Send Message">
                <i class="fas fa-comment"></i>
              </button>
              <button onclick="viewMemberProfile('${memberId}')" class="action-btn" title="View Profile">
                <i class="fas fa-user"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Generate activity HTML from real data
    function generateActivityHTML(activities) {
      if (!activities || activities.length === 0) {
        return '<div class="no-activity"><i class="fas fa-history"></i><p>No recent activity</p></div>';
      }
      
      return activities.slice(0, 5).map(activity => {
        const user = activity.user || activity.userName || 'Unknown';
        const action = activity.action || 'activity';
        const description = activity.description || '';
        const time = activity.time || activity.timestamp ? getTimeAgo(new Date(activity.time || activity.timestamp)) : 'Unknown';
        
        // Determine icon based on action
        let iconClass = 'fas fa-circle';
        let iconType = 'default';
        
        if (action === 'joined' || action === 'left') {
          iconClass = 'fas fa-user';
          iconType = action === 'joined' ? 'online' : 'offline';
        } else if (action === 'message') {
          iconClass = 'fas fa-comment';
          iconType = 'message';
        } else if (action === 'file_upload') {
          iconClass = 'fas fa-file';
          iconType = 'file';
        } else if (action === 'session_created' || action === 'session_joined') {
          iconClass = 'fas fa-video';
          iconType = 'session';
        }
        
        return `
          <div class="activity-item">
            <div class="activity-icon ${iconType}"><i class="${iconClass}"></i></div>
            <div class="activity-content">
              <strong>${user}</strong> ${description || action}
              <div class="activity-time">${time}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function showGroupManagementModal(groupData) {
      console.log(' showGroupManagementModal called with:', groupData);
      
      try {
        // Remove existing modal if any
        const existingModal = document.getElementById('group-management-modal');
        if (existingModal) {
          console.log('Removing existing modal');
          existingModal.remove();
        }

        // Generate members HTML from real data
        const membersHTML = generateMembersHTML(groupData.members || []);
        
        // Generate activity HTML from real data
        const activityHTML = generateActivityHTML(groupData.recentActivity || []);
        
        // Calculate stats
        const stats = groupData.stats || {};
        const totalMembers = groupData.totalMembers || groupData.members?.length || 0;
        const activeMembers = groupData.activeMembers || groupData.members?.filter(m => m.status === 'online').length || 0;
        const messages = stats.totalMessages || stats.messages || 0;
        const filesShared = stats.totalFiles || stats.files || 0;
        
        // Calculate created time
        const createdAt = groupData.createdAt ? getTimeAgo(new Date(groupData.createdAt)) : 'Unknown';

        console.log(' Creating modal HTML...');
        // Create modal HTML
        const modalHTML = `
        <div id="group-management-modal" class="group-modal-overlay">
          <div class="group-modal">
            <div class="modal-header">
              <h2><i class="fas fa-users"></i> ${groupData.name}</h2>
              <button onclick="closeGroupModal()" class="close-btn">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="modal-content">
              <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchModalTab('overview', this)">
                  <i class="fas fa-info-circle"></i> Overview
                </button>
                <button class="modal-tab" onclick="switchModalTab('members', this)">
                  <i class="fas fa-users"></i> Members
                </button>
                <button class="modal-tab" onclick="switchModalTab('collaboration', this)">
                  <i class="fas fa-handshake"></i> Collaborate
                </button>
                <button class="modal-tab" onclick="switchModalTab('sessions', this)">
                  <i class="fas fa-calendar"></i> Sessions
                </button>
                <button class="modal-tab" onclick="console.log('Resources tab clicked!'); switchModalTab('resources', this)">
                  <i class="fas fa-book"></i> Resources
                </button>
                <button class="modal-tab" onclick="console.log('Settings tab clicked!'); switchModalTab('settings', this)">
                  <i class="fas fa-cog"></i> Settings
                </button>
              </div>

              <!-- Overview Tab -->
              <div class="modal-tab-content active" id="overview-content">
                <div class="group-overview">
                  <div class="overview-card">
                    <h3><i class="fas fa-info"></i> Group Information</h3>
                    <div class="info-item">
                      <label>Group Name:</label>
                      <span>${groupData.name}</span>
                    </div>
                    <div class="info-item">
                      <label>Status:</label>
                      <span class="status-badge ${groupData.status}">${groupData.status}</span>
                    </div>
                    <div class="info-item">
                      <label>Description:</label>
                      <p>${groupData.description}</p>
                    </div>
                    <div class="info-item">
                      <label>Created:</label>
                      <span>${createdAt}</span>
                    </div>
                    ${groupData.isAdmin ? '<div class="info-item"><label>Your Role:</label><span class="admin-role-badge"><i class="fas fa-crown"></i> Admin</span></div>' : ''}
                  </div>

                  <div class="overview-card">
                    <h3><i class="fas fa-chart-bar"></i> Group Statistics</h3>
                    <div class="stats-grid">
                      <div class="stat-box">
                        <div class="stat-number">${totalMembers}</div>
                        <div class="stat-label">Total Members</div>
                      </div>
                      <div class="stat-box">
                        <div class="stat-number">${activeMembers}</div>
                        <div class="stat-label">Online Now</div>
                      </div>
                      <div class="stat-box">
                        <div class="stat-number">${messages}</div>
                        <div class="stat-label">Messages</div>
                      </div>
                      <div class="stat-box">
                        <div class="stat-number">${filesShared}</div>
                        <div class="stat-label">Files Shared</div>
                      </div>
                    </div>
                  </div>

                  <div class="overview-card">
                    <h3><i class="fas fa-clock"></i> Recent Activity</h3>
                    <div class="activity-feed" id="modal-activity-feed">
                      ${activityHTML || '<div class="no-activity">No recent activity</div>'}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Members Tab -->
              <div class="modal-tab-content" id="members-content">
                <div class="members-management">
                  <div class="members-header">
                    <h3><i class="fas fa-users"></i> Group Members (${totalMembers})</h3>
                    ${groupData.isAdmin ? `<button onclick="showInviteModal()" class="btn-primary">
                      <i class="fas fa-user-plus"></i> Invite Members
                    </button>` : ''}
                  </div>
                  
                  <div class="members-list-detailed" id="modal-members-list">
                    ${membersHTML || '<div class="no-members-message">No members found</div>'}
                  </div>
                </div>
              </div>

              <!-- Collaboration Tab -->
              <div class="modal-tab-content" id="collaboration-content">
                <div class="collaboration-tools">
                  <div class="tools-grid">
                    <div class="tool-card" onclick="startScreenShare()">
                      <div class="tool-icon"><i class="fas fa-desktop"></i></div>
                      <div class="tool-title">Screen Share</div>
                      <div class="tool-description">Share your screen with group members</div>
                    </div>

                    <div class="tool-card" onclick="startVideoCall()">
                      <div class="tool-icon"><i class="fas fa-video"></i></div>
                      <div class="tool-title">Video Call</div>
                      <div class="tool-description">Start a group video conference</div>
                    </div>

                    <div class="tool-card" onclick="openWhiteboard()">
                      <div class="tool-icon"><i class="fas fa-chalkboard"></i></div>
                      <div class="tool-title">Whiteboard</div>
                      <div class="tool-description">Collaborative drawing and brainstorming</div>
                    </div>

                    <div class="tool-card" onclick="openCodeEditor()">
                      <div class="tool-icon"><i class="fas fa-code"></i></div>
                      <div class="tool-title">Code Together</div>
                      <div class="tool-description">Real-time collaborative coding</div>
                    </div>

                    <div class="tool-card" onclick="createPoll()">
                      <div class="tool-icon"><i class="fas fa-poll"></i></div>
                      <div class="tool-title">Quick Poll</div>
                      <div class="tool-description">Create polls and gather opinions</div>
                    </div>

                    <div class="tool-card" onclick="shareFiles()">
                      <div class="tool-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                      <div class="tool-title">File Sharing</div>
                      <div class="tool-description">Upload and share study materials</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Sessions Tab -->
              <div class="modal-tab-content" id="sessions-content">
                <div class="sessions-management">
                  <div class="sessions-header">
                    <div class="sessions-header-content">
                      <h3><i class="fas fa-calendar-alt"></i> Study Sessions</h3>
                      <p>Schedule and manage your group study sessions</p>
                    </div>
                    <button onclick="console.log('Schedule button clicked'); scheduleSession()" class="btn-primary">
                      <i class="fas fa-plus"></i> Schedule Session
                    </button>
                  </div>

                  <div class="sessions-view-toggle">
                    <button class="view-toggle-btn active" onclick="switchSessionView('list')" data-view="list">
                      <i class="fas fa-list"></i> List View
                    </button>
                    <button class="view-toggle-btn" onclick="switchSessionView('calendar')" data-view="calendar">
                      <i class="fas fa-calendar"></i> Calendar View
                    </button>
                  </div>

                  <div id="sessionsListView" class="sessions-view active">
                    <div class="sessions-list" id="sessionsContainer">
                      <div class="loading-sessions">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading sessions...</p>
                      </div>
                    </div>
                  </div>
                  </div>

                  <div id="sessionsCalendarView" class="sessions-view">
                    <div class="calendar-container">
                      <div class="calendar-header">
                        <button onclick="navigateMonth(-1)" class="calendar-nav-btn">
                          <i class="fas fa-chevron-left"></i>
                        </button>
                        <h3 id="calendarMonthYear"></h3>
                        <button onclick="navigateMonth(1)" class="calendar-nav-btn">
                          <i class="fas fa-chevron-right"></i>
                        </button>
                      </div>
                      <div class="calendar-grid">
                        <div class="calendar-days-header">
                          <div class="calendar-day-header">Sun</div>
                          <div class="calendar-day-header">Mon</div>
                          <div class="calendar-day-header">Tue</div>
                          <div class="calendar-day-header">Wed</div>
                          <div class="calendar-day-header">Thu</div>
                          <div class="calendar-day-header">Fri</div>
                          <div class="calendar-day-header">Sat</div>
                        </div>
                        <div class="calendar-days" id="calendarDays">
                          <!-- Calendar days will be generated here -->
                        </div>
                      </div>
                    </div>
                    <div class="calendar-sidebar">
                      <div class="upcoming-sessions">
                        <h4><i class="fas fa-clock"></i> Upcoming Sessions</h4>
                        <div id="upcomingSessionsList">
                          <!-- Upcoming sessions will be listed here -->
                        </div>
                      </div>
                      <div class="session-legend">
                        <h4><i class="fas fa-info-circle"></i> Legend</h4>
                        <div class="legend-item">
                          <div class="legend-color scheduled"></div>
                          <span>Scheduled Sessions</span>
                        </div>
                        <div class="legend-item">
                          <div class="legend-color with-mentor"></div>
                          <span>With Mentor</span>
                        </div>
                        <div class="legend-item">
                          <div class="legend-color recurring"></div>
                          <span>Recurring Sessions</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Resources Tab -->
              <div class="modal-tab-content" id="resources-content">
                <div class="resources-management">
                  <div class="resources-header">
                    <h3><i class="fas fa-book"></i> Shared Resources</h3>
                    <button onclick="uploadResource()" class="btn-primary">
                      <i class="fas fa-upload"></i> Upload Resource
                    </button>
                  </div>

                  <div class="resources-grid" id="resources-grid-content">
                    <div class="loading-resources">
                      <i class="fas fa-spinner fa-spin"></i>
                      <p>Loading resources...</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Settings Tab -->
              <div class="modal-tab-content" id="settings-content">
                <div class="group-settings">
                  <div class="settings-header">
                    <h3><i class="fas fa-cog"></i> Group Settings</h3>
                  </div>
                  <div class="settings-section">
                    <h4><i class="fas fa-bell"></i> Notifications</h4>
                    <div class="setting-item">
                      <label class="setting-label">
                        <input type="checkbox" checked> New messages
                      </label>
                    </div>
                    <div class="setting-item">
                      <label class="setting-label">
                        <input type="checkbox" checked> Session reminders
                      </label>
                    </div>
                    <div class="setting-item">
                      <label class="setting-label">
                        <input type="checkbox"> File uploads
                      </label>
                    </div>
                  </div>

                  <div class="settings-section">
                    <h4><i class="fas fa-shield-alt"></i> Privacy</h4>
                    <div class="setting-item">
                      <label class="setting-label">
                        <input type="checkbox" checked> Allow member invitations
                      </label>
                    </div>
                    <div class="setting-item">
                      <label class="setting-label">
                        <input type="checkbox"> Make group public
                      </label>
                    </div>
                  </div>

                  <div class="settings-section danger-zone">
                    <h4><i class="fas fa-exclamation-triangle"></i> Danger Zone</h4>
                    <button onclick="leaveGroup('${groupData.name}')" class="btn-danger">
                      <i class="fas fa-sign-out-alt"></i> Leave Group
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // Add modal to page
      console.log(' About to insert modal HTML into document.body');
      console.log('Document body exists:', !!document.body);
      console.log('Modal HTML length:', modalHTML.length);
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      console.log(' Modal HTML inserted into DOM');
      
      // Check immediately after insertion
      const insertedModal = document.getElementById('group-management-modal');
      console.log('Modal element immediately after insertion:', !!insertedModal);
      
      if (insertedModal) {
        console.log(' Modal successfully created in DOM');
        console.log('Modal children count:', insertedModal.children.length);
      } else {
        console.error(' Modal not found in DOM after insertion!');
        console.log('Checking if any element was added to body...');
        console.log('Body children count:', document.body.children.length);
        console.log('Body last child:', document.body.lastElementChild?.tagName);
      }
      
      console.log('Resources content now exists:', !!document.getElementById('resources-content'));
      console.log('Resources grid now exists:', !!document.querySelector('.resources-grid'));
      
      // Load group files for the resources section
      if (selectedGroupName) {
        console.log(' Loading group files for:', selectedGroupName);
        
        // Load files after a small delay to ensure DOM is ready
        setTimeout(() => {
          console.log(' DOM ready, loading files...');
          loadGroupFiles(selectedGroupName);
        }, 100);
        
        loadGroupStats(selectedGroupName);
      }
      
      // Show modal
      requestAnimationFrame(() => {
        console.log(' Activating modal with classList.add("active")');
        const modalElement = document.getElementById('group-management-modal');
        console.log('Modal element found for activation:', !!modalElement);
        if (modalElement) {
          modalElement.classList.add('active');
          console.log(' Modal activated successfully');
        } else {
          console.error(' Modal element not found for activation!');
        }
      });
      
    } catch (error) {
      console.error(' Error in showGroupManagementModal:', error);
      console.error('Error stack:', error.stack);
    }
    }

    // Modal management functions
    function closeGroupModal() {
      const modal = document.getElementById('group-management-modal');
      if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
          modal.remove();
        }, 300);
      }
    }

    function switchModalTab(tabName, buttonElement) {
      console.log(' switchModalTab FUNCTION CALLED! ');
      console.log('switchModalTab called with:', tabName);
      console.log('Button element:', buttonElement);
      
      // Update active tab button
      document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
      buttonElement.classList.add('active');
      
      // Update active tab content - HIDE ALL FIRST
      document.querySelectorAll('.modal-tab-content').forEach(content => {
        content.classList.remove('active');
        content.style.display = 'none'; // Force hide all tabs
      });
      
      const targetContent = document.getElementById(`${tabName}-content`);
      console.log(`Target content element for ${tabName}:`, targetContent);
      
      if (targetContent) {
        targetContent.classList.add('active');
        targetContent.style.display = 'block'; // Force show this tab
        console.log(`Successfully switched to ${tabName} tab`);
        
        // Ensure proper display for Resources and Settings tabs
        if (tabName === 'resources' || tabName === 'settings') {
          targetContent.style.minHeight = '400px';
          targetContent.style.padding = '20px';
          
          console.log(` ${tabName} tab is now visible`);
        }
      } else {
        console.error(`Could not find content element for ${tabName}`);
      }
      
      // Load content when tabs are opened
      if (tabName === 'resources') {
        console.log('Loading resources section...');
        
        // Debug the resources content structure
        const resourcesContent = document.getElementById('resources-content');
        if (resourcesContent) {
          console.log(' Resources content found, checking grid...');
          
          const resourcesGrid = resourcesContent.querySelector('.resources-grid');
          if (resourcesGrid) {
            console.log(' Resources grid ready');
          }
        }
        
        refreshResourcesSection();
      } else if (tabName === 'sessions') {
        console.log('Loading sessions section...');
        refreshSessionsView();
      } else if (tabName === 'settings') {
        console.log('Loading settings section...');
        
        // Settings content is static HTML, just ensure it's visible
        const settingsContentDiv = document.getElementById('settings-content');
        if (settingsContentDiv) {
          console.log(' Settings content ready');
        }
      }
    }

    // Member management functions
    function showInviteModal() {
      alert('Invite members feature coming soon!\n\nYou will be able to:\n Send email invitations\n Share join links\n Import from contacts\n Set member permissions');
    }

    function startPrivateChat(memberId) {
      alert(`Starting private chat with ${memberId}...\n\nThis will open a direct message window for one-on-one communication.`);
    }

    function viewMemberProfile(memberId) {
      alert(`Viewing profile of ${memberId}...\n\nProfile will show:\n Study interests\n Availability schedule\n Skill level\n Contact preferences`);
    }

    // Collaboration tool functions
    function startScreenShare() {
      if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
        navigator.mediaDevices.getDisplayMedia({ video: true, audio: true })
          .then(stream => {
            alert('Screen sharing started!\n\nYour screen is now being shared with group members. You can stop sharing anytime.');
            // Here you would integrate with WebRTC or similar technology
          })
          .catch(err => {
            alert('Screen sharing failed. Please check your browser permissions.');
            console.error('Error starting screen share:', err);
          });
      } else {
        alert('Screen sharing is not supported in your browser.\n\nPlease use Chrome, Firefox, or Edge for this feature.');
      }
    }

    function startVideoCall() {
      alert('Starting group video call...\n\nFeatures:\n Up to 10 participants\n Screen sharing\n Chat during call\n Recording option\n\nConnecting to video room...');
      // Redirect to video call page or open in new window
      // window.open('/video-room/' + selectedGroupName, '_blank');
    }

    function openWhiteboard() {
      alert('Opening collaborative whiteboard...\n\nFeatures:\n Real-time drawing\n Text annotations\n Shape tools\n Save and export\n\nLaunching whiteboard...');
      // Open whiteboard in new tab
      // window.open('/whiteboard/' + selectedGroupName, '_blank');
    }

    // Open code editor in separate page
    function openCodeEditor() {
      if (!selectedGroupName) {
        alert('Please select a group first');
        return;
      }
      // Get user info to pass to code editor
      const token = localStorage.getItem('token') || '';
      const userName = localStorage.getItem('userName') || 'Anonymous';
      const userId = localStorage.getItem('userId') || 'user_' + Date.now();
      
      // Navigate to code editor with group name and user info as parameters
      const params = new URLSearchParams({
        group: selectedGroupName,
        userName: userName,
        userId: userId,
        token: token
      });
      window.location.href = `code-editor.html?${params.toString()}`;
    }
    window.openCodeEditor = openCodeEditor;

    // ============ POLL FUNCTIONS ============
    let activePolls = {}; // Store polls by ID
    
    function createPoll() {
      console.log(' createPoll called');
      if (!selectedGroupName) {
        alert('Please select a group first');
        return;
      }
      document.getElementById('pollModal').classList.add('active');
      document.getElementById('pollQuestion').focus();
    }

    function closePollModal() {
      document.getElementById('pollModal').classList.remove('active');
      // Reset form
      document.getElementById('pollQuestion').value = '';
      document.getElementById('pollMultipleChoice').checked = false;
      document.getElementById('pollAnonymous').checked = false;
      document.getElementById('pollDuration').value = '';
      
      // Reset options to just 2
      const container = document.getElementById('pollOptionsContainer');
      container.innerHTML = `
        <div class="poll-option-row">
          <input type="text" class="poll-input poll-option-input" placeholder="Option 1">
          <button class="poll-remove-option" onclick="removePollOption(this)" title="Remove">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="poll-option-row">
          <input type="text" class="poll-input poll-option-input" placeholder="Option 2">
          <button class="poll-remove-option" onclick="removePollOption(this)" title="Remove">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
    }
    window.closePollModal = closePollModal;

    function addPollOption() {
      const container = document.getElementById('pollOptionsContainer');
      const optionCount = container.querySelectorAll('.poll-option-row').length + 1;
      
      if (optionCount > 10) {
        alert('Maximum 10 options allowed');
        return;
      }
      
      const row = document.createElement('div');
      row.className = 'poll-option-row';
      row.innerHTML = `
        <input type="text" class="poll-input poll-option-input" placeholder="Option ${optionCount}">
        <button class="poll-remove-option" onclick="removePollOption(this)" title="Remove">
          <i class="fas fa-times"></i>
        </button>
      `;
      container.appendChild(row);
    }
    window.addPollOption = addPollOption;

    function removePollOption(btn) {
      const container = document.getElementById('pollOptionsContainer');
      if (container.querySelectorAll('.poll-option-row').length <= 2) {
        alert('Poll must have at least 2 options');
        return;
      }
      btn.closest('.poll-option-row').remove();
      
      // Re-number placeholders
      container.querySelectorAll('.poll-option-input').forEach((input, i) => {
        input.placeholder = `Option ${i + 1}`;
      });
    }
    window.removePollOption = removePollOption;

    function submitPoll() {
      const question = document.getElementById('pollQuestion').value.trim();
      const optionInputs = document.querySelectorAll('.poll-option-input');
      const options = Array.from(optionInputs).map(input => input.value.trim()).filter(v => v);
      const allowMultiple = document.getElementById('pollMultipleChoice').checked;
      const anonymous = document.getElementById('pollAnonymous').checked;
      const durationHours = document.getElementById('pollDuration').value;
      
      // Validation
      if (!question) {
        alert('Please enter a question');
        return;
      }
      
      if (options.length < 2) {
        alert('Please add at least 2 options');
        return;
      }
      
      // Create poll object
      const pollId = 'poll_' + Date.now();
      const poll = {
        id: pollId,
        question: question,
        options: options.map((text, index) => ({
          id: index,
          text: text,
          votes: [],
          voteCount: 0
        })),
        allowMultiple: allowMultiple,
        anonymous: anonymous,
        createdBy: currentUser.name,
        createdById: currentUser.id,
        createdAt: new Date(),
        endsAt: durationHours ? new Date(Date.now() + parseInt(durationHours) * 60 * 60 * 1000) : null,
        totalVotes: 0,
        groupName: selectedGroupName
      };
      
      // Store locally
      activePolls[pollId] = poll;
      
      // Send via WebSocket
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
          group: selectedGroupName,
          senderId: currentUser.id,
          senderName: currentUser.name,
          messageType: 'poll',
          poll: poll
        }));
      }
      
      // Display poll in chat
      appendPollMessage(poll);
      
      closePollModal();
      showNotification('Poll created successfully!', 'success');
    }
    window.submitPoll = submitPoll;

    function appendPollMessage(poll) {
      if (!chatBody) {
        chatBody = document.querySelector('#chat-body');
      }
      if (!chatBody) return;
      
      // Ensure poll has groupName for voting
      if (!poll.groupName) {
        poll.groupName = selectedGroupName;
      }
      
      // Check if poll already exists in DOM (avoid duplicates)
      if (document.getElementById(`poll-${poll.id}`)) {
        return;
      }
      
      // Store poll
      activePolls[poll.id] = poll;
      
      const isEnded = poll.endsAt && new Date(poll.endsAt) < new Date();
      const userVotes = getUserVotes(poll);
      
      const container = document.createElement('div');
      container.className = 'message-container';
      container.dataset.pollId = poll.id;
      
      container.innerHTML = `
        <div class="message-avatar" style="background: linear-gradient(135deg, #ff4b2b, #ff6b4a)">
          <i class="fas fa-poll" style="font-size: 14px;"></i>
        </div>
        <div class="message-content">
          <div class="message-header">
            <span class="message-sender">${escapeHtml(poll.createdBy)}</span>
            <span class="message-time">${formatPollTime(poll.createdAt)}</span>
          </div>
          <div class="poll-message" id="poll-${poll.id}">
            <div class="poll-header">
              <div class="poll-icon"><i class="fas fa-poll"></i></div>
              <div class="poll-title">
                <p class="poll-question">${escapeHtml(poll.question)}</p>
                <div class="poll-meta">
                  ${poll.allowMultiple ? ' Multiple choice' : ' Single choice'}
                  ${poll.anonymous ? '  Anonymous' : ''}
                </div>
              </div>
            </div>
            <div class="poll-options-list">
              ${poll.options.map(opt => renderPollOption(poll, opt, userVotes, isEnded)).join('')}
            </div>
            <div class="poll-footer">
              <span class="poll-total-votes">
                <i class="fas fa-users"></i> ${poll.totalVotes} vote${poll.totalVotes !== 1 ? 's' : ''}
              </span>
              ${poll.endsAt ? (isEnded ? 
                '<span class="poll-ended"><i class="fas fa-check-circle"></i> Ended</span>' :
                `<span class="poll-end-time"><i class="fas fa-clock"></i> Ends ${formatPollEndTime(poll.endsAt)}</span>`
              ) : ''}
            </div>
          </div>
        </div>
      `;
      
      chatBody.appendChild(container);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function renderPollOption(poll, option, userVotes, isEnded) {
      const hasVoted = userVotes.includes(option.id);
      const percentage = poll.totalVotes > 0 ? Math.round((option.voteCount / poll.totalVotes) * 100) : 0;
      const showResults = userVotes.length > 0 || isEnded;
      
      return `
        <div class="poll-option-item ${hasVoted ? 'voted' : ''}" 
             onclick="${!isEnded ? `votePoll('${poll.id}', ${option.id})` : ''}"
             ${isEnded ? 'style="cursor: default;"' : ''}>
          ${showResults ? `<div class="poll-option-progress" style="width: ${percentage}%"></div>` : ''}
          <div class="poll-option-content">
            <span class="poll-option-text">${escapeHtml(option.text)}</span>
            ${showResults ? `
              <span class="poll-option-stats">
                <span class="poll-option-percent">${percentage}%</span>
                <span>${option.voteCount}</span>
              </span>
            ` : ''}
          </div>
        </div>
      `;
    }

    function getUserVotes(poll) {
      if (!poll || !poll.options) return [];
      const votes = [];
      poll.options.forEach(opt => {
        if (opt.votes && opt.votes.some(v => v.oderId === currentUser.id || v.oderId === currentUser.name)) {
          votes.push(opt.id);
        }
      });
      return votes;
    }

    function votePoll(pollId, optionId) {
      const poll = activePolls[pollId];
      if (!poll) return;
      
      const isEnded = poll.endsAt && new Date(poll.endsAt) < new Date();
      if (isEnded) {
        showNotification('This poll has ended', 'error');
        return;
      }
      
      const userVotes = getUserVotes(poll);
      
      // Check if already voted on this option
      if (userVotes.includes(optionId)) {
        // Remove vote
        const option = poll.options.find(o => o.id === optionId);
        if (option) {
          option.votes = option.votes.filter(v => v.oderId !== currentUser.id && v.oderId !== currentUser.name);
          option.voteCount = option.votes.length;
          poll.totalVotes = poll.options.reduce((sum, o) => sum + o.voteCount, 0);
        }
      } else {
        // Add vote
        if (!poll.allowMultiple && userVotes.length > 0) {
          // Remove previous vote
          poll.options.forEach(opt => {
            opt.votes = opt.votes.filter(v => v.oderId !== currentUser.id && v.oderId !== currentUser.name);
            opt.voteCount = opt.votes.length;
          });
        }
        
        const option = poll.options.find(o => o.id === optionId);
        if (option) {
          option.votes.push({
            oderId: currentUser.id,
            voterName: poll.anonymous ? 'Anonymous' : currentUser.name,
            votedAt: new Date()
          });
          option.voteCount = option.votes.length;
          poll.totalVotes = poll.options.reduce((sum, o) => sum + o.voteCount, 0);
        }
      }
      
      // Update UI
      updatePollDisplay(poll);
      
      // Send vote via WebSocket
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
          group: selectedGroupName,
          senderId: currentUser.id,
          senderName: currentUser.name,
          messageType: 'poll_vote',
          pollId: pollId,
          poll: poll
        }));
      }
    }
    window.votePoll = votePoll;

    function updatePollDisplay(poll) {
      const pollElement = document.getElementById(`poll-${poll.id}`);
      if (!pollElement) return;
      
      const isEnded = poll.endsAt && new Date(poll.endsAt) < new Date();
      const userVotes = getUserVotes(poll);
      
      // Update options
      const optionsList = pollElement.querySelector('.poll-options-list');
      if (optionsList) {
        optionsList.innerHTML = poll.options.map(opt => renderPollOption(poll, opt, userVotes, isEnded)).join('');
      }
      
      // Update total votes
      const totalVotesEl = pollElement.querySelector('.poll-total-votes');
      if (totalVotesEl) {
        totalVotesEl.innerHTML = `<i class="fas fa-users"></i> ${poll.totalVotes} vote${poll.totalVotes !== 1 ? 's' : ''}`;
      }
    }

    function formatPollTime(date) {
      const d = new Date(date);
      return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    function formatPollEndTime(date) {
      const d = new Date(date);
      const now = new Date();
      const diff = d - now;
      
      if (diff < 0) return 'Ended';
      if (diff < 60 * 60 * 1000) return `in ${Math.round(diff / 60000)} min`;
      if (diff < 24 * 60 * 60 * 1000) return `in ${Math.round(diff / 3600000)} hours`;
      return d.toLocaleDateString();
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10001;
        animation: slideIn 0.3s ease;
        background: ${type === 'success' ? 'linear-gradient(135deg, #00b894, #00cec9)' : 
                      type === 'error' ? 'linear-gradient(135deg, #e74c3c, #c0392b)' : 
                      'linear-gradient(135deg, #667eea, #764ba2)'};
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    function shareFiles() {
      console.log('shareFiles() called from group card');
      if (!selectedGroupName) {
        alert('Please select a group first');
        return;
      }
      
      const input = document.createElement('input');
      input.type = 'file';
      input.multiple = false;
      input.accept = '.pdf,.doc,.docx,.txt,.jpg,.png,.gif,.ppt,.pptx,.zip';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        console.log('File selected from group card:', {
          name: file.name,
          size: file.size,
          type: file.type
        });
        
        uploadFileToGroup(file, selectedGroupName);
      };
      input.click();
    }

    // Session management functions
    function scheduleSession(groupId = null) {
        console.log('Schedule session called with groupId:', groupId);
        
        // Use the selected group name instead of trying to get an ID
        let groupName = null;
        if (!groupId || groupId === 'current') {
            if (selectedGroupName) {
                groupName = selectedGroupName;
                console.log('Using selected group name:', groupName);
            } else {
                alert('Please select a group first before scheduling a session.');
                return;
            }
        } else {
            groupName = groupId;
        }
        
        showScheduleSessionModal(groupName);
    }

    function showScheduleSessionModal(groupName) {
        console.log('showScheduleSessionModal called with groupName:', groupName);
        
        // Remove existing modal if any
        const existingModal = document.getElementById('scheduleSessionModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        const modal = document.createElement('div');
        modal.className = 'group-modal-overlay active';
        modal.id = 'scheduleSessionModal';
        
        console.log('Creating modal element...');
        
        modal.innerHTML = `
            <div class="group-modal schedule-session-modal">
                <div class="modal-header">
                    <h3><i class="fas fa-calendar-plus"></i> Schedule Study Session</h3>
                    <button onclick="closeScheduleModal()" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="schedule-form">
                    <div class="form-section">
                        <h4><i class="fas fa-info-circle"></i> Session Details</h4>
                        <div class="form-group">
                            <label>Session Title *</label>
                            <input type="text" id="sessionTitle" placeholder="e.g., Data Structures Review Session" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="sessionDescription" placeholder="What will be covered in this session? What should participants prepare?"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Subject *</label>
                                <select id="sessionSubject" required>
                                    <option value="">Select Subject</option>
                                    <option value="mathematics">Mathematics</option>
                                    <option value="programming">Programming</option>
                                    <option value="data-science">Data Science</option>
                                    <option value="machine-learning">Machine Learning</option>
                                    <option value="web-development">Web Development</option>
                                    <option value="algorithms">Algorithms & Data Structures</option>
                                    <option value="databases">Databases</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Difficulty Level</label>
                                <select id="sessionLevel">
                                    <option value="beginner">Beginner</option>
                                    <option value="intermediate" selected>Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4><i class="fas fa-clock"></i> Schedule</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date *</label>
                                <input type="date" id="sessionDate" min="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Start Time *</label>
                                <input type="time" id="sessionStartTime" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Duration</label>
                                <select id="sessionDuration">
                                    <option value="0.5">30 minutes</option>
                                    <option value="1">1 hour</option>
                                    <option value="1.5">1.5 hours</option>
                                    <option value="2" selected>2 hours</option>
                                    <option value="3">3 hours</option>
                                    <option value="4">4 hours</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Session Type</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="sessionType" value="group" checked>
                                    <span><i class="fas fa-users"></i> Group Study</span>
                                    <small>Study session with group members only</small>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="sessionType" value="mentor">
                                    <span><i class="fas fa-user-tie"></i> Request Mentor</span>
                                    <small>Request a mentor to join and guide the session</small>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="sessionType" value="presentation">
                                    <span><i class="fas fa-presentation"></i> Presentation/Demo</span>
                                    <small>Present your work or demo a project</small>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="checkbox-option">
                                <input type="checkbox" id="recurringSession">
                                <span>Make this a recurring session</span>
                            </label>
                            <div id="recurringOptions" style="display: none; margin-top: 10px;">
                                <select id="recurringFrequency">
                                    <option value="weekly">Weekly</option>
                                    <option value="biweekly">Bi-weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                                <input type="number" id="recurringCount" value="4" min="2" max="20" style="width: 60px; margin-left: 10px;">
                                <span>sessions</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section" id="mentorSection" style="display: none;">
                        <h4><i class="fas fa-user-tie"></i> Mentor Request</h4>
                        <div class="form-group">
                            <label>Preferred Mentor (Optional)</label>
                            <select id="preferredMentor">
                                <option value="">Any available mentor</option>
                                <option value="mentor1">Dr. Sarah Johnson - AI/ML Expert</option>
                                <option value="mentor2">Prof. Mike Chen - Data Science</option>
                                <option value="mentor3">Ms. Emily Rodriguez - Web Development</option>
                                <option value="mentor4">Dr. James Wilson - Mathematics</option>
                                <option value="mentor5">Ms. Lisa Zhang - Programming</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Expertise Needed</label>
                            <div class="expertise-tags">
                                <label class="tag-option"><input type="checkbox" value="debugging"> Debugging</label>
                                <label class="tag-option"><input type="checkbox" value="code-review"> Code Review</label>
                                <label class="tag-option"><input type="checkbox" value="architecture"> Architecture</label>
                                <label class="tag-option"><input type="checkbox" value="best-practices"> Best Practices</label>
                                <label class="tag-option"><input type="checkbox" value="career-guidance"> Career Guidance</label>
                                <label class="tag-option"><input type="checkbox" value="project-planning"> Project Planning</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Special Requirements for Mentor</label>
                            <textarea id="mentorRequirements" placeholder="Describe any specific topics, technologies, or requirements for the mentor..."></textarea>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4><i class="fas fa-users"></i> Participants</h4>
                        <div class="participant-list">
                            <div class="participant-item">
                                <div style="width: 40px; height: 40px; background-color: #ff4b2b; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">Y</div>
                                <div class="participant-info">
                                    <span class="participant-name">You (Organizer)</span>
                                    <span class="participant-email">organizer@example.com</span>
                                </div>
                                <span class="role-tag organizer">Organizer</span>
                            </div>
                        </div>
                        
                        <div class="invite-section">
                            <div class="invite-input-group">
                                <input type="email" id="inviteEmail" placeholder="Enter email to invite participants">
                                <button type="button" class="invite-btn" onclick="addParticipant()">
                                    <i class="fas fa-plus"></i> Invite
                                </button>
                            </div>
                            <div class="invite-suggestions">
                                <span>Quick invite:</span>
                                <button type="button" onclick="inviteAllGroupMembers()" class="suggestion-btn">All Group Members</button>
                                <button type="button" onclick="inviteFrequentCollaborators()" class="suggestion-btn">Frequent Collaborators</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4><i class="fas fa-cog"></i> Session Settings</h4>
                        <div class="settings-grid">
                            <label class="checkbox-option">
                                <input type="checkbox" id="recordSession" checked>
                                <span><i class="fas fa-record-vinyl"></i> Record session</span>
                                <small>Automatically record for later review</small>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" id="enableChat" checked>
                                <span><i class="fas fa-comment"></i> Enable chat</span>
                                <small>Allow text chat during session</small>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" id="shareScreen" checked>
                                <span><i class="fas fa-desktop"></i> Allow screen sharing</span>
                                <small>Participants can share their screens</small>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" id="enableWhiteboard">
                                <span><i class="fas fa-chalkboard"></i> Enable whiteboard</span>
                                <small>Collaborative drawing and brainstorming</small>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" id="breakoutRooms">
                                <span><i class="fas fa-door-open"></i> Create breakout rooms</span>
                                <small>Split into smaller discussion groups</small>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" id="sendReminders" checked>
                                <span><i class="fas fa-bell"></i> Send reminders</span>
                                <small>Email reminders 24h and 1h before session</small>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeScheduleModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn-primary" onclick="createStudySession('${groupName}')">
                        <i class="fas fa-calendar-check"></i> Schedule Session
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        console.log('Modal appended to body');
        
        // Setup event listeners
        setupScheduleModalEvents();
        console.log('Modal setup complete');
    }

    function setupScheduleModalEvents() {
        // Session type change handler
        document.querySelectorAll('input[name="sessionType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const mentorSection = document.getElementById('mentorSection');
                mentorSection.style.display = this.value === 'mentor' ? 'block' : 'none';
            });
        });
        
        // Recurring session toggle
        document.getElementById('recurringSession').addEventListener('change', function() {
            const recurringOptions = document.getElementById('recurringOptions');
            recurringOptions.style.display = this.checked ? 'block' : 'none';
        });
        
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('sessionDate').min = today;
        
        // Set default time to next hour
        const nextHour = new Date();
        nextHour.setHours(nextHour.getHours() + 1, 0, 0, 0);
        document.getElementById('sessionStartTime').value = nextHour.toTimeString().slice(0, 5);
    }

    function closeScheduleModal() {
        const modal = document.getElementById('scheduleSessionModal');
        if (modal) {
            modal.remove();
        }
    }

    function addParticipant() {
        const emailInput = document.getElementById('inviteEmail');
        const email = emailInput.value.trim();
        
        if (!email) {
            alert('Please enter an email address');
            return;
        }
        
        if (!isValidEmail(email)) {
            alert('Please enter a valid email address');
            return;
        }
        
        // Check if already invited
        const existingEmails = Array.from(document.querySelectorAll('.participant-email'))
            .map(el => el.textContent.toLowerCase());
        
        if (existingEmails.includes(email.toLowerCase())) {
            alert('This person is already invited');
            return;
        }
        
        const participantList = document.querySelector('.participant-list');
        const participantItem = document.createElement('div');
        participantItem.className = 'participant-item';
        
        // Generate a random avatar color
        const colors = ['#ff4b2b', '#2196F3', '#4CAF50', '#FF9800', '#9C27B0', '#607D8B'];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        
        participantItem.innerHTML = `
            <div style="width: 40px; height: 40px; background-color: ${randomColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${email.charAt(0).toUpperCase()}</div>
            <div class="participant-info">
                <span class="participant-name">${email.split('@')[0]}</span>
                <span class="participant-email">${email}</span>
            </div>
            <span class="role-tag invited">Invited</span>
            <button class="remove-participant" onclick="this.parentElement.remove()" title="Remove participant">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        participantList.appendChild(participantItem);
        emailInput.value = '';
    }

    function inviteAllGroupMembers() {
        // Simulate adding all group members
        const groupMembers = [
            { name: 'Alice Johnson', email: 'alice.johnson@example.com' },
            { name: 'Bob Smith', email: 'bob.smith@example.com' },
            { name: 'Carol Davis', email: 'carol.davis@example.com' }
        ];
        
        const participantList = document.querySelector('.participant-list');
        const existingEmails = Array.from(document.querySelectorAll('.participant-email'))
            .map(el => el.textContent.toLowerCase());
        
        groupMembers.forEach(member => {
            if (!existingEmails.includes(member.email.toLowerCase())) {
                const participantItem = document.createElement('div');
                participantItem.className = 'participant-item';
                
                participantItem.innerHTML = `
                    <div style="width: 40px; height: 40px; background-color: #ff4b2b; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${member.name.charAt(0)}</div>
                    <div class="participant-info">
                        <span class="participant-name">${member.name}</span>
                        <span class="participant-email">${member.email}</span>
                    </div>
                    <span class="role-tag member">Member</span>
                    <button class="remove-participant" onclick="this.parentElement.remove()" title="Remove participant">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                participantList.appendChild(participantItem);
            }
        });
    }

    function inviteFrequentCollaborators() {
        // Simulate adding frequent collaborators
        const collaborators = [
            { name: 'David Kim', email: 'david.kim@example.com' },
            { name: 'Emma Wilson', email: 'emma.wilson@example.com' }
        ];
        
        const participantList = document.querySelector('.participant-list');
        const existingEmails = Array.from(document.querySelectorAll('.participant-email'))
            .map(el => el.textContent.toLowerCase());
        
        collaborators.forEach(collaborator => {
            if (!existingEmails.includes(collaborator.email.toLowerCase())) {
                document.getElementById('inviteEmail').value = collaborator.email;
                addParticipant();
            }
        });
    }

    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function createStudySession(groupName) {
        console.log('Creating study session for group:', groupName);
        
        // Collect form data
        const sessionData = {
            groupId: groupName, // Send group name as groupId
            title: document.getElementById('sessionTitle').value.trim(),
            description: document.getElementById('sessionDescription').value.trim(),
            subject: document.getElementById('sessionSubject').value,
            level: document.getElementById('sessionLevel').value,
            date: document.getElementById('sessionDate').value,
            startTime: document.getElementById('sessionStartTime').value,
            duration: parseFloat(document.getElementById('sessionDuration').value),
            type: document.querySelector('input[name="sessionType"]:checked').value,
            isRecurring: document.getElementById('recurringSession').checked,
            recurringFrequency: document.getElementById('recurringFrequency').value,
            recurringCount: parseInt(document.getElementById('recurringCount').value),
            preferredMentor: document.getElementById('preferredMentor').value,
            mentorRequirements: document.getElementById('mentorRequirements').value.trim(),
            expertiseNeeded: Array.from(document.querySelectorAll('.expertise-tags input:checked')).map(cb => cb.value),
            settings: {
                record: document.getElementById('recordSession').checked,
                chat: document.getElementById('enableChat').checked,
                screenShare: document.getElementById('shareScreen').checked,
                whiteboard: document.getElementById('enableWhiteboard').checked,
                breakoutRooms: document.getElementById('breakoutRooms').checked,
                reminders: document.getElementById('sendReminders').checked
            },
            participants: Array.from(document.querySelectorAll('.participant-email')).map(span => span.textContent),
            createdAt: new Date().toISOString()
        };
        
        console.log('Session data collected:', sessionData);
        
        // Validation
        if (!sessionData.title) {
            alert('Please enter a session title');
            document.getElementById('sessionTitle').focus();
            return;
        }
        
        if (!sessionData.subject) {
            alert('Please select a subject');
            document.getElementById('sessionSubject').focus();
            return;
        }
        
        if (!sessionData.date) {
            alert('Please select a date');
            document.getElementById('sessionDate').focus();
            return;
        }
        
        if (!sessionData.startTime) {
            alert('Please select a start time');
            document.getElementById('sessionStartTime').focus();
            return;
        }
        
        // Check if date/time is in the future
        const sessionDateTime = new Date(`${sessionData.date}T${sessionData.startTime}`);
        const now = new Date();
        
        if (sessionDateTime <= now) {
            alert('Session must be scheduled for a future date and time');
            return;
        }
        
        // Check authentication
        const token = localStorage.getItem('token');
        console.log('Auth token:', token ? 'Present' : 'Missing');
        if (!token) {
            alert('Please log in first');
            window.location.href = '../credentials/signin.html';
            return;
        }
        
        // Show loading state
        const submitBtn = document.querySelector('.btn-primary');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scheduling...';
        submitBtn.disabled = true;
        
        // Send to backend
        console.log('Sending request to:', `${window.location.origin}/api/sessions/create`);
        console.log('Request data:', JSON.stringify(sessionData, null, 2));
        
        fetch(`${window.location.origin}/api/sessions/create`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(sessionData)
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            if (!response.ok) {
                return response.text().then(text => {
                    console.error('Error response:', text);
                    throw new Error(`Server error: ${response.status} - ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Success response:', data);
            // Show success message
            showSessionCreatedConfirmation(data.session);
            
            // Close modal
            closeScheduleModal();
            
            // Reload sessions tab if it's active
            const activeTab = document.querySelector('.modal-tab.active');
            if (activeTab && activeTab.textContent.includes('Sessions')) {
                loadScheduledSessions();
            }
        })
        .catch(error => {
            console.error('Detailed error creating session:', error);
            alert('Failed to create session: ' + error.message);
        })
        .finally(() => {
            // Reset button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    }

    function showSessionCreatedConfirmation(session) {
        const confirmation = document.createElement('div');
        confirmation.className = 'notification-popup success';
        
        const sessionDate = new Date(`${session.date}T${session.startTime}`);
        const formattedDate = sessionDate.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        const formattedTime = sessionDate.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });
        
        confirmation.innerHTML = `
            <div class="notification-content">
                <div class="notification-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="notification-text">
                    <h4>Session Scheduled Successfully!</h4>
                    <p><strong>"${session.title}"</strong></p>
                    <p><i class="fas fa-calendar"></i> ${formattedDate} at ${formattedTime}</p>
                    <p><i class="fas fa-clock"></i> Duration: ${session.duration} hour${session.duration !== 1 ? 's' : ''}</p>
                    ${session.type === 'mentor' ? '<p><i class="fas fa-user-tie"></i> Mentor request sent!</p>' : ''}
                    ${session.settings.reminders ? '<p><i class="fas fa-bell"></i> Reminders will be sent to all participants</p>' : ''}
                </div>
                <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(confirmation);
        
        // Auto-remove after 8 seconds
        setTimeout(() => {
            if (confirmation.parentElement) {
                confirmation.remove();
            }
        }, 8000);
        
        // If mentor was requested, send additional notification
        if (session.type === 'mentor') {
            setTimeout(() => showMentorRequestNotification(session), 1000);
        }
    }

    function showMentorRequestNotification(session) {
        const notification = document.createElement('div');
        notification.className = 'notification-popup info';
        
        notification.innerHTML = `
            <div class="notification-content">
                <div class="notification-icon">
                    <i class="fas fa-paper-plane"></i>
                </div>
                <div class="notification-text">
                    <h4>Mentor Request Sent!</h4>
                    <p>Your request for mentor guidance has been sent to available mentors.</p>
                    ${session.preferredMentor ? '<p>Priority given to your preferred mentor.</p>' : ''}
                    <p>You'll receive a notification once a mentor accepts your request.</p>
                </div>
                <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 6000);
    }

    // Auto-refresh sessions every minute to update countdowns
    let sessionRefreshInterval = null;
    
    function startSessionAutoRefresh() {
        if (sessionRefreshInterval) {
            clearInterval(sessionRefreshInterval);
        }
        // Refresh every 30 seconds to keep countdowns updated
        sessionRefreshInterval = setInterval(() => {
            loadScheduledSessions();
        }, 30000);
    }

    function loadScheduledSessions() {
        const sessionsContainer = document.querySelector('.sessions-list');
        if (!sessionsContainer) return;
        
        // Start auto-refresh if not already running
        if (!sessionRefreshInterval) {
            startSessionAutoRefresh();
        }
        
        const sessions = JSON.parse(localStorage.getItem('scheduledSessions') || '[]');
        const upcomingSessions = sessions.filter(session => {
            const sessionDate = new Date(`${session.date}T${session.startTime}`);
            return sessionDate > new Date();
        }).sort((a, b) => new Date(`${a.date}T${a.startTime}`) - new Date(`${b.date}T${b.startTime}`));
        
        if (upcomingSessions.length === 0) {
            sessionsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-calendar-alt"></i>
                    <h3>No Scheduled Sessions</h3>
                    <p>Schedule your first study session to get started!</p>
                    <button onclick="scheduleSession()" class="btn-primary">
                        <i class="fas fa-plus"></i> Schedule Session
                    </button>
                </div>
            `;
            return;
        }
        
        sessionsContainer.innerHTML = upcomingSessions.map(session => {
            const now = new Date();
            const sessionDate = new Date(`${session.date}T${session.startTime}`);
            const endTime = new Date(sessionDate.getTime() + (session.duration * 60 * 60 * 1000));
            
            // Check session availability (can join 5 minutes early)
            const earlyJoinWindow = 5 * 60 * 1000;
            const canJoinFrom = new Date(sessionDate.getTime() - earlyJoinWindow);
            const isAvailable = now >= canJoinFrom && now <= endTime;
            const isEnded = now > endTime;
            const isLive = now >= sessionDate && now <= endTime;
            
            // Calculate time until session starts
            let timeRemaining = '';
            if (!isAvailable && !isEnded) {
                const timeUntilStart = sessionDate - now;
                const hours = Math.floor(timeUntilStart / (1000 * 60 * 60));
                const minutes = Math.floor((timeUntilStart % (1000 * 60 * 60)) / (1000 * 60));
                if (hours > 0) {
                    timeRemaining = `Starts in ${hours}h ${minutes}m`;
                } else if (minutes > 0) {
                    timeRemaining = `Starts in ${minutes}m`;
                } else {
                    timeRemaining = 'Starting soon...';
                }
            }
            
            return `
                <div class="session-card ${isLive ? 'live' : 'upcoming'} ${isEnded ? 'ended' : ''}" data-session-id="${session.id}">
                    <div class="session-status ${isLive ? 'live' : ''} ${isEnded ? 'ended' : ''}">
                        <i class="fas ${isLive ? 'fa-broadcast-tower' : isEnded ? 'fa-check-circle' : 'fa-clock'}"></i>
                        ${isLive ? 'Live Now' : isEnded ? 'Ended' : 'Upcoming'}
                    </div>
                    <div class="session-info">
                        <h4>${session.title}</h4>
                        <div class="session-meta">
                            <span class="session-subject">
                                <i class="fas fa-book"></i> ${session.subject}
                            </span>
                            <span class="session-level ${session.level}">
                                <i class="fas fa-signal"></i> ${session.level}
                            </span>
                        </div>
                        <div class="session-time">
                            <i class="fas fa-calendar"></i>
                            ${sessionDate.toLocaleDateString()} at ${sessionDate.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true})}
                        </div>
                        ${!isAvailable && !isEnded ? `<div class="session-countdown"><i class="fas fa-hourglass-half"></i> ${timeRemaining}</div>` : ''}
                        <div class="session-participants">
                            <i class="fas fa-users"></i>
                            ${session.participants.length} participant${session.participants.length !== 1 ? 's' : ''}
                            ${session.type === 'mentor' ? '<span class="mentor-badge"><i class="fas fa-user-tie"></i> Mentor Requested</span>' : ''}
                        </div>
                        ${session.description ? `<div class="session-description">${session.description}</div>` : ''}
                    </div>
                    <div class="session-actions">
                        <button onclick="joinSession('${session.id}')" class="action-btn ${isLive ? 'live' : 'primary'} ${!isAvailable ? 'disabled' : ''}" ${isEnded ? 'disabled' : ''}>
                            <i class="fas ${isLive ? 'fa-broadcast-tower' : 'fa-video'}"></i> ${isLive ? 'Join Live' : isEnded ? 'Ended' : 'Join'}
                        </button>
                        <button onclick="editSession('${session.id}')" class="action-btn" ${isEnded ? 'disabled' : ''}>
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="cancelSession('${session.id}')" class="action-btn danger" ${isEnded ? 'disabled' : ''}>
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function cancelSession(sessionId) {
        if (!confirm('Are you sure you want to cancel this session? This action cannot be undone.')) {
            return;
        }
        
        const sessions = JSON.parse(localStorage.getItem('scheduledSessions') || '[]');
        const updatedSessions = sessions.filter(session => session.id !== sessionId);
        localStorage.setItem('scheduledSessions', JSON.stringify(updatedSessions));
        
        // Show cancellation confirmation
        const notification = document.createElement('div');
        notification.className = 'notification-popup warning';
        notification.innerHTML = `
            <div class="notification-content">
                <div class="notification-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="notification-text">
                    <h4>Session Cancelled</h4>
                    <p>The study session has been cancelled and all participants have been notified.</p>
                </div>
                <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
        
        // Reload sessions
        loadScheduledSessions();
    }

    function editSession(sessionId) {
      alert(`Editing session: ${sessionId}\n\nYou can modify:\n Date and time\n Duration\n Participants\n Session materials`);
    }

    function viewRecording(sessionId) {
      alert(`Loading recording for: ${sessionId}\n\nRecording will include:\n Full video\n Chat messages\n Shared screen\n Session notes`);
    }

    function viewNotes(sessionId) {
      alert(`Opening session notes for: ${sessionId}\n\nNotes include:\n Key discussion points\n Action items\n Resource links\n Follow-up tasks`);
    }

    // Resource management functions
    function uploadResource() {
      console.log('uploadResource() called');
      if (!selectedGroupName) {
        alert('Please select a group first');
        return;
      }
      
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.pdf,.doc,.docx,.ppt,.pptx,.txt,.jpg,.png,.zip';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        console.log('File selected for upload:', {
          name: file.name,
          size: file.size,
          type: file.type
        });
        
        uploadFileToGroup(file, selectedGroupName);
      };
      input.click();
    }

    async function uploadFileToGroup(file, groupName) {
      console.log('=== UPLOADING FILE TO GROUP ===');
      console.log('File:', file.name);
      console.log('Group:', groupName);
      
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Please log in to upload files');
        return;
      }
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('group', groupName);
      
      try {
        console.log('Making upload request...');
        const response = await fetch(`${window.location.origin}/api/group-upload`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });
        
        console.log('Upload response:', response.status, response.statusText);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Upload failed with status:', response.status);
          console.error('Error response:', errorText);
          throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.message) {
          alert(`File "${file.name}" uploaded successfully to ${groupName}!`);
          // Refresh resources display
          refreshResourcesSection();
        } else {
          throw new Error(data.error || 'Upload failed');
        }
      } catch (error) {
        console.error('Upload error:', error);
        alert('Upload failed: ' + error.message);
      }
    }

    function downloadFile(filename) {
      alert(`Downloading: ${filename}\n\nFile will be saved to your Downloads folder.`);
      // Trigger download
    }

    function openSharedNote(noteId) {
      alert(`Opening shared note: ${noteId}\n\nFeatures:\n Real-time collaboration\n Version history\n Comments and suggestions\n Export options\n\nLaunching editor...`);
    }

    function openLink(linkId) {
      alert(`Opening link: ${linkId}\n\nThis will open in a new tab.`);
      // window.open(linkUrl, '_blank');
    }

    // Session management functions
    async function loadGroupSessions(groupName) {
      console.log('Loading sessions for group:', groupName);
      const container = document.getElementById('sessionsContainer');
      
      if (!container) return;
      
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          container.innerHTML = '<div class="no-sessions"><p>Please log in to view sessions</p></div>';
          return;
        }
        
        const response = await fetch(`${window.location.origin}/api/sessions/group/${encodeURIComponent(groupName)}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('Sessions loaded:', data.sessions);
          displaySessions(data.sessions);
        } else {
          console.log('Failed to load sessions:', response.status);
          container.innerHTML = '<div class="no-sessions"><p>No sessions found for this group</p></div>';
        }
      } catch (error) {
        console.error('Error loading sessions:', error);
        container.innerHTML = '<div class="no-sessions"><p>Error loading sessions</p></div>';
      }
    }

    function displaySessions(sessions) {
      console.log('displaySessions called with:', sessions);
      const container = document.getElementById('sessionsContainer');
      console.log('Container found:', container);
      if (!container) return;
      
      if (!sessions || sessions.length === 0) {
        console.log('No sessions to display');
        container.innerHTML = `
          <div class="no-sessions">
            <i class="fas fa-calendar-times"></i>
            <h4>No Sessions Yet</h4>
            <p>Create your first study session to get started!</p>
            <button onclick="scheduleSession()" class="btn-primary">
              <i class="fas fa-plus"></i> Schedule Session
            </button>
          </div>
        `;
        return;
      }
      
      const now = new Date();
      console.log('Current time:', now);
      const upcomingSessions = sessions.filter(session => {
        const sessionDate = new Date(session.sessionDate);
        console.log('Session date:', sessionDate, 'vs now:', now, 'upcoming:', sessionDate > now);
        return sessionDate > now;
      });
      const pastSessions = sessions.filter(session => new Date(session.sessionDate) <= now);
      
      console.log('Upcoming sessions:', upcomingSessions.length);
      console.log('Past sessions:', pastSessions.length);
      
      let html = '';
      
      // Upcoming sessions
      if (upcomingSessions.length > 0) {
        html += '<div class="sessions-section"><h4>Upcoming Sessions</h4>';
        upcomingSessions.forEach(session => {
          html += createSessionCard(session, 'upcoming');
        });
        html += '</div>';
      }
      
      // Past sessions
      if (pastSessions.length > 0) {
        html += '<div class="sessions-section"><h4>Past Sessions</h4>';
        pastSessions.forEach(session => {
          html += createSessionCard(session, 'completed');
        });
        html += '</div>';
      }
      
      console.log('Generated HTML:', html);
      container.innerHTML = html;
      console.log('Sessions displayed successfully');
    }

    function createSessionCard(session, status) {
      const sessionDate = new Date(session.sessionDate);
      const formattedDate = sessionDate.toLocaleDateString();
      const formattedTime = `${session.startTime} - ${session.endTime}`;
      
      return `
        <div class="session-card ${status}">
          <div class="session-status">${status === 'upcoming' ? 'Upcoming' : 'Completed'}</div>
          <div class="session-info">
            <h4>${session.title}</h4>
            <div class="session-time">
              <i class="fas fa-clock"></i> ${formattedDate}, ${formattedTime}
            </div>
            <div class="session-details">
              <span class="session-subject"><i class="fas fa-book"></i> ${session.subject}</span>
              <span class="session-level"><i class="fas fa-signal"></i> ${session.level}</span>
              <span class="session-duration"><i class="fas fa-hourglass-half"></i> ${session.duration}h</span>
            </div>
            ${session.description ? `<div class="session-description">${session.description}</div>` : ''}
            <div class="session-participants">
              <i class="fas fa-users"></i> ${session.participants?.length || 0} participants
            </div>
          </div>
          <div class="session-actions">
            ${status === 'upcoming' ? 
              `<button onclick="joinSession('${session._id}')" class="btn-join">Join</button>
               <button onclick="editSession('${session._id}')" class="btn-edit">Edit</button>` :
              `<button onclick="viewSession('${session._id}')" class="btn-secondary">Details</button>`
            }
          </div>
        </div>
      `;
    }

    function joinSession(sessionId) {
      console.log('Joining session:', sessionId);
      
      // Redirect to video room with session ID as room code
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Please login to join the session');
        return;
      }
      
      // Open video room in new tab or redirect
      window.location.href = `../mentorDash/videoRoom.html?room=${sessionId}`;
    }

    function refreshSessionsView() {
      if (selectedGroupName && document.getElementById('sessionsContainer')) {
        loadGroupSessions(selectedGroupName);
      }
    }

    // Settings functions
    function leaveGroup() {
      if (confirm('Are you sure you want to leave this group?\n\nYou will lose access to:\n Chat history\n Shared files\n Session recordings\n Group resources\n\nThis action cannot be undone.')) {
        alert('Leaving group...\n\nYou have successfully left the group. You can join again if invited by a member.');
        closeGroupModal();
      }
    }

    // Close modal when clicking outside
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('group-modal-overlay')) {
        closeGroupModal();
      }
    });

    async function loadGroupFiles(groupName) {
      try {
        console.log('Loading files for group:', groupName);
        
        const response = await fetch(`${window.location.origin}/api/group-files/${groupName}`);
        
        if (response.ok) {
          const data = await response.json();
          console.log('Group files loaded:', data.files);
          
          // Store files globally so other functions can access them
          window.currentGroupFiles = data.files;
          
          // Update resources section if visible
          updateResourcesDisplay(data.files);
        } else {
          console.log('No files found for group:', groupName, 'Status:', response.status);
          window.currentGroupFiles = [];
          updateResourcesDisplay([]);
        }
      } catch (error) {
        console.error('Error loading group files:', error);
        window.currentGroupFiles = [];
        updateResourcesDisplay([]);
      }
    }

    async function updateResourcesDisplay() {
      console.log(' Loading resources...');
      const currentGroupId = selectedGroupName;
      
      if (!currentGroupId) {
        console.error('No group ID available');
        return;
      }

      try {
        const response = await fetch(`${window.location.origin}/api/files/${currentGroupId}`);
        const files = await response.json();
        
        console.log(`Found ${files.length} files for group:`, currentGroupId);
        
        const resourcesGrid = document.querySelector('.resources-grid');
        if (!resourcesGrid) {
          console.error('Resources grid element not found');
          return;
        }

        // Group files by type
        const documents = files.filter(file => 
          ['pdf', 'doc', 'docx', 'txt', 'csv'].includes(getFileExtension(file.filename))
        );
        const images = files.filter(file => 
          ['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(getFileExtension(file.filename))
        );
        const others = files.filter(file => 
          !['pdf', 'doc', 'docx', 'txt', 'csv', 'jpg', 'jpeg', 'png', 'gif', 'svg'].includes(getFileExtension(file.filename))
        );

        let html = '';
        
        // Add Documents section
        if (documents.length > 0) {
          html += generateCategoryHTML('Documents', documents, 'fas fa-file-pdf');
        }
        
        // Add Images section  
        if (images.length > 0) {
          html += generateCategoryHTML('Images', images, 'fas fa-image');
        }
        
        // Add Others section
        if (others.length > 0) {
          html += generateCategoryHTML('Others', others, 'fas fa-file');
        }

        resourcesGrid.innerHTML = html;
        console.log(' Resources loaded successfully');

      } catch (error) {
        console.error('Error loading resources:', error);
        const resourcesGrid = document.querySelector('.resources-grid');
        if (resourcesGrid) {
          resourcesGrid.innerHTML = '<p style="text-align: center; color: #888;">Error loading resources</p>';
        }
      }
    }

    function generateCategoryHTML(categoryName, files, iconClass) {
      let html = `<div class="resource-category">
        <h4><i class="${iconClass}"></i> ${categoryName} (${files.length} files)</h4>`;
      
      files.forEach((file, index) => {
        const filename = file.filename || file._id || `file_${index}`;
        const originalname = file.originalname || file.name || `${categoryName} ${index + 1}`;
        const uploaderName = file.uploaderName || file.uploader || file.author || 'Unknown User';
        
        html += `
          <div class="resource-item">
            <div class="resource-icon"><i class="${iconClass}"></i></div>
            <div class="resource-info">
              <div class="resource-name">${originalname}</div>
              <div class="resource-meta">Uploaded by ${uploaderName}</div>
            </div>
            <div class="resource-actions">
              <button onclick="downloadGroupFile('${filename}', '${originalname}')" class="action-btn">
                <i class="fas fa-download"></i>
              </button>
            </div>
          </div>`;
      });
      
      html += '</div>';
      return html;
    }

    function getFileExtension(filename) {
      return filename.split('.').pop().toLowerCase();
    }

    // Helper functions for file loading
    async function loadGroupFiles(groupName) {
        try {
          console.log('Loading group files (chat version):', groupName);
          
          const response = await fetch(`${window.location.origin}/api/group-files/${encodeURIComponent(groupName)}`);
          
          if (response.ok) {
            const data = await response.json();
            console.log('Chat files loaded:', data.files);
            data.files.forEach(file => {
              appendFileMessage(file);
            });
          } else {
            console.log('Failed to load chat files:', response.status);
          }
        } catch (error) {
          console.error('Error loading chat files:', error);
        }
    }

    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - new Date(date);
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
      return `${Math.floor(diffDays / 30)} months ago`;
    }

    function refreshResourcesSection() {
      if (selectedGroupName) {
        loadResourcesForModal(selectedGroupName);
      }
    }
    
    async function loadResourcesForModal(groupName) {
      console.log(' Loading resources for modal:', groupName);
      
      const resourcesGrid = document.getElementById('resources-grid-content');
      if (!resourcesGrid) {
        console.error('Resources grid element not found');
        return;
      }
      
      // Show loading state
      resourcesGrid.innerHTML = `
        <div class="loading-resources">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading resources...</p>
        </div>
      `;
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${window.location.origin}/api/group-files/${encodeURIComponent(groupName)}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          const files = data.files || [];
          console.log(`Found ${files.length} files for group:`, groupName);
          
          if (files.length === 0) {
            resourcesGrid.innerHTML = `
              <div class="empty-resources">
                <i class="fas fa-folder-open"></i>
                <h4>No Resources Yet</h4>
                <p>Upload files to share with your group members.</p>
              </div>
            `;
            return;
          }
          
          // Group files by type
          const documents = files.filter(file => 
            ['pdf', 'doc', 'docx', 'txt', 'csv', 'xls', 'xlsx', 'ppt', 'pptx'].includes(getFileExtension(file.filename || file.originalname || ''))
          );
          const images = files.filter(file => 
            ['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'].includes(getFileExtension(file.filename || file.originalname || ''))
          );
          const others = files.filter(file => {
            const ext = getFileExtension(file.filename || file.originalname || '');
            return !['pdf', 'doc', 'docx', 'txt', 'csv', 'xls', 'xlsx', 'ppt', 'pptx', 'jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'].includes(ext);
          });

          let html = '';
          
          // Add Documents section
          if (documents.length > 0) {
            html += generateResourceCategoryHTML('Documents', documents, 'fas fa-file-alt');
          }
          
          // Add Images section  
          if (images.length > 0) {
            html += generateResourceCategoryHTML('Images', images, 'fas fa-image');
          }
          
          // Add Others section
          if (others.length > 0) {
            html += generateResourceCategoryHTML('Other Files', others, 'fas fa-file');
          }

          resourcesGrid.innerHTML = html;
          console.log(' Resources loaded successfully');
          
        } else {
          console.log('No files found or error:', response.status);
          resourcesGrid.innerHTML = `
            <div class="empty-resources">
              <i class="fas fa-folder-open"></i>
              <h4>No Resources Yet</h4>
              <p>Upload files to share with your group members.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading resources:', error);
        resourcesGrid.innerHTML = `
          <div class="empty-resources">
            <i class="fas fa-exclamation-circle"></i>
            <h4>Error Loading Resources</h4>
            <p>Please try again later.</p>
          </div>
        `;
      }
    }
    
    function generateResourceCategoryHTML(categoryName, files, iconClass) {
      let html = `<div class="resource-category">
        <h4><i class="${iconClass}"></i> ${categoryName} (${files.length})</h4>`;
      
      files.forEach((file) => {
        const filename = file.filename || file._id || 'unknown';
        const originalname = file.originalname || file.name || filename;
        const uploaderName = file.uploaderName || file.uploader || 'Unknown';
        const uploadDate = file.uploadedAt ? getTimeAgo(new Date(file.uploadedAt)) : '';
        const fileSize = file.size ? formatFileSize(file.size) : '';
        
        const fileIcon = getFileIcon(originalname);
        
        html += `
          <div class="resource-item">
            <div class="resource-icon"><i class="${fileIcon}"></i></div>
            <div class="resource-info">
              <div class="resource-name">${originalname}</div>
              <div class="resource-meta">
                ${uploaderName}${uploadDate ? '  ' + uploadDate : ''}${fileSize ? '  ' + fileSize : ''}
              </div>
            </div>
            <div class="resource-actions">
              <button onclick="downloadGroupFile('${filename}', '${originalname}')" class="action-btn" title="Download">
                <i class="fas fa-download"></i>
              </button>
            </div>
          </div>`;
      });
      
      html += '</div>';
      return html;
    }
    
    function getFileIcon(filename) {
      const ext = getFileExtension(filename);
      const iconMap = {
        'pdf': 'fas fa-file-pdf',
        'doc': 'fas fa-file-word',
        'docx': 'fas fa-file-word',
        'xls': 'fas fa-file-excel',
        'xlsx': 'fas fa-file-excel',
        'ppt': 'fas fa-file-powerpoint',
        'pptx': 'fas fa-file-powerpoint',
        'txt': 'fas fa-file-alt',
        'csv': 'fas fa-file-csv',
        'jpg': 'fas fa-file-image',
        'jpeg': 'fas fa-file-image',
        'png': 'fas fa-file-image',
        'gif': 'fas fa-file-image',
        'svg': 'fas fa-file-image',
        'zip': 'fas fa-file-archive',
        'rar': 'fas fa-file-archive',
        'mp4': 'fas fa-file-video',
        'mp3': 'fas fa-file-audio',
        'js': 'fas fa-file-code',
        'py': 'fas fa-file-code',
        'html': 'fas fa-file-code',
        'css': 'fas fa-file-code'
      };
      return iconMap[ext] || 'fas fa-file';
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function downloadGroupFile(filename, originalname) {
      // Use the proper download API endpoint that handles file serving
      const downloadUrl = `${window.location.origin}/api/download/${encodeURIComponent(filename)}`;
      
      // Create a hidden link and trigger download
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = originalname; // Browser may override with Content-Disposition header
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    async function loadGroupStats(groupName) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${window.location.origin}/api/groups/${groupName}/stats`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          updateGroupStatsDisplay(data.stats, data.recentActivity);
        } else {
          console.error('Failed to load group stats');
        }
      } catch (error) {
        console.error('Error loading group stats:', error);
      }
    }

    function updateGroupStatsDisplay(stats, recentActivity) {
      // Update statistics numbers
      const statBoxes = document.querySelectorAll('.stat-box .stat-number');
      if (statBoxes.length >= 4) {
        statBoxes[0].textContent = stats.members || 0;
        statBoxes[1].textContent = stats.onlineNow || 0;
        statBoxes[2].textContent = stats.messages || 0;
        statBoxes[3].textContent = stats.filesShared || 0;
      }
      
      // Update recent activity
      const activityFeed = document.querySelector('.activity-feed');
      if (activityFeed && recentActivity && recentActivity.length > 0) {
        activityFeed.innerHTML = recentActivity.map(activity => {
          const iconClass = activity.type === 'message' ? 'fas fa-comment' : 
                           activity.type === 'file' ? 'fas fa-file' : 'fas fa-clock';
          const iconBg = activity.type === 'message' ? 'online' : 
                        activity.type === 'file' ? 'file' : 'session';
          
          return `
            <div class="activity-item">
              <div class="activity-icon ${iconBg}"><i class="${iconClass}"></i></div>
              <div class="activity-content">
                <strong>${activity.user}</strong> ${activity.action}
                ${activity.details ? `<br><small>${activity.details}</small>` : ''}
                <div class="activity-time">${getTimeAgo(activity.timestamp)}</div>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    async function handleGroupSelectionMain(groupName, element) {
      console.log(' handleGroupSelection called:', groupName);
      selectedGroupName = groupName;
      
      // Remove selection from all groups and add to current
      document.querySelectorAll(".group-card").forEach(card => {
        card.classList.remove("selected-group");
      });
      if (element) element.classList.add("selected-group");
      
      // Update chat header
      document.getElementById('chat-header-title').innerHTML = `
        <i class="fas fa-users"></i>
        Group: ${groupName}
      `;
      document.getElementById('group-info-btn').style.display = 'block';
      chatBody.innerHTML = '';

      // Load chat history from API first
      await loadChatHistory(groupName);
      
      // Then load any file attachments
      await loadGroupFiles(groupName);
      
      // Setup WebSocket connection for real-time chat
      if (socket) {
        socket.close();
      }

      socket = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}`);

      socket.onopen = () => {
        socket.send(JSON.stringify({ type: 'join', group: groupName }));
        // Send system message that user joined
        socket.send(JSON.stringify({
          group: groupName,
          messageType: 'system',
          message: `${currentUser.name} joined the chat`
        }));
      };

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        // Handle poll messages
        if (data.messageType === 'poll' && data.group === selectedGroupName) {
          if (data.senderId !== currentUser.id) {
            appendPollMessage(data.poll);
          }
          return;
        }
        
        // Handle poll vote updates
        if (data.messageType === 'poll_vote' && data.group === selectedGroupName) {
          if (data.senderId !== currentUser.id && data.poll) {
            activePolls[data.pollId] = data.poll;
            updatePollDisplay(data.poll);
          }
          return;
        }
        
        // Handle different message types
        if (data.type === 'history') {
          // Legacy history format
          data.messages.forEach(msg => {
            // Check if it's a poll message
            if (msg.messageType === 'poll' && msg.poll) {
              appendPollMessage(msg.poll);
            } else {
              appendEnhancedMessage({
                senderId: msg.senderId,
                senderName: msg.senderName || msg.sender,
                senderAvatar: msg.senderAvatar,
                senderRole: msg.senderRole,
                message: msg.message,
                messageType: msg.messageType || 'text',
                timestamp: msg.timestamp,
                messageId: msg._id
              });
            }
          });
        } else if (data.type === 'message' && data.group === selectedGroupName) {
          // Handle poll messages
          if (data.messageType === 'poll' && data.poll) {
            if (data.senderId !== currentUser.id) {
              appendPollMessage(data.poll);
            }
            return;
          }
          
          // New enhanced message format
          // Don't show own messages again (we already added them when sending)
          if (data.senderId !== currentUser.id) {
            appendEnhancedMessage({
              messageId: data.messageId,
              senderId: data.senderId,
              senderName: data.senderName,
              senderAvatar: data.senderAvatar,
              senderRole: data.senderRole,
              message: data.message,
              messageType: data.messageType,
              attachment: data.attachment,
              timestamp: data.timestamp
            });
          }
        } else if (data.group === selectedGroupName && data.message) {
          // Legacy format fallback
          const isOwnMessage = data.senderId === currentUser.id || data.senderName === currentUser.name;
          if (!isOwnMessage) {
            appendEnhancedMessage({
              senderName: data.senderName || data.sender || 'User',
              message: data.message,
              timestamp: data.timestamp || new Date()
            });
          }
        }
      };

      socket.onerror = (err) => {
        console.error("WebSocket error:", err);
      };

      socket.onclose = () => {
        console.warn("WebSocket connection closed");
      };

      // Save selection to backend
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${window.location.origin}/api/save-current-group`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ groupName })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          console.log('Non-JSON response received, skipping parse');
          return;
        }

        const data = await response.json();
        console.log(data.message);
      } catch (err) {
        console.error("Error saving selected group:", err);
      }
    }

    async function loadMatchedGroups() {
      console.log("============================================================");
      console.log(" loadMatchedGroups() CALLED - Starting group fetch...");
      console.log(" Current URL:", window.location.href);
      console.log(" Origin:", window.location.origin);
      
      try {
        const token = localStorage.getItem('token');
        console.log(" Auth token found:", !!token);
        console.log(" Token length:", token?.length || 0);
        
        if (!token) {
          console.error(" No authentication token found");
          displayGroups([]);
          return;
        }
        
        const apiUrl = `${window.location.origin}/api/match-groups`;
        console.log(" Fetching from:", apiUrl);
        console.log(" Making API request NOW...");
        
        const response = await fetch(apiUrl, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log(" Response received! Status:", response.status);
        console.log(" Response OK:", response.ok);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error(" HTTP error! status:", response.status, "body:", errorText);
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(" API Response data:", JSON.stringify(data, null, 2));
        console.log(" Groups array exists:", !!data.groups);
        console.log(" Groups array length:", data.groups?.length || 0);

        if (!data.groups || !Array.isArray(data.groups) || data.groups.length === 0) {
          console.warn(" No groups found - user needs to join groups first");
          displayGroups([]);
          return;
        }

        // Transform API data to match display format
        // Now the API returns full group data with members, stats, activity
        const enhancedGroups = data.groups.map((group, index) => ({
          _id: group._id || String(index + 1),
          group_name: group.group_name,
          status: group.status || 'active',
          description: group.description || `Study group for ${group.group_name}`,
          category: group.category || 'General',
          members: group.members || [],
          totalMembers: group.totalMembers || group.members?.length || 0,
          activeMembers: group.activeMembers || 0,
          totalMessages: group.stats?.messages || 0,
          totalFiles: group.stats?.files || 0,
          totalSessions: group.stats?.sessions || 0,
          recentActivity: group.recentActivity || [],
          progress: group.progress || { percentage: 0, milestones: [] },
          userRole: group.userRole || 'member',
          isAdmin: group.isAdmin || false,
          createdAt: new Date(group.createdAt || Date.now())
        }));

        console.log(" Enhanced groups prepared:", enhancedGroups);
        displayGroups(enhancedGroups);
        
        // Update member status to online for current user
        enhancedGroups.forEach(group => {
          updateMemberStatus(group.group_name, 'online');
        });
        
        console.log(" loadMatchedGroups() COMPLETED successfully");
        console.log("============================================================");
        
      } catch (err) {
        console.error(" ERROR in loadMatchedGroups:", err);
        console.error(" Error message:", err.message);
        console.error(" Error stack:", err.stack);
        console.log("============================================================");
        displayGroups([]);
      }
    }
    
    // Update member status in a group
    async function updateMemberStatus(groupName, status) {
      try {
        const token = localStorage.getItem('token');
        await fetch(`${window.location.origin}/api/groups/${encodeURIComponent(groupName)}/status`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status })
        });
      } catch (err) {
        console.error("Error updating status:", err);
      }
    }
    
    // Leave a group
    async function leaveGroup(groupName) {
      if (!confirm(`Are you sure you want to leave "${groupName}"?`)) {
        return;
      }
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${window.location.origin}/api/groups/${encodeURIComponent(groupName)}/leave`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        if (result.success) {
          showNotification('success', `Left ${groupName} successfully`);
          loadMatchedGroups(); // Reload groups
        } else {
          showNotification('error', result.message || 'Failed to leave group');
        }
      } catch (err) {
        console.error("Error leaving group:", err);
        showNotification('error', 'Failed to leave group');
      }
    }
    
    // Record activity in a group
    async function recordGroupActivity(groupName, action, description) {
      try {
        const token = localStorage.getItem('token');
        await fetch(`${window.location.origin}/api/groups/${encodeURIComponent(groupName)}/activity`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action, description })
        });
      } catch (err) {
        console.error("Error recording activity:", err);
      }
    }
    
    // Fetch group members
    async function fetchGroupMembers(groupName) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${window.location.origin}/api/groups/${encodeURIComponent(groupName)}/members`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) throw new Error('Failed to fetch members');
        return await response.json();
      } catch (err) {
        console.error("Error fetching members:", err);
        return { members: [], total: 0, online: 0 };
      }
    }
    
    // Fetch group activity
    async function fetchGroupActivity(groupName, limit = 20) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${window.location.origin}/api/groups/${encodeURIComponent(groupName)}/activity?limit=${limit}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) throw new Error('Failed to fetch activity');
        return await response.json();
      } catch (err) {
        console.error("Error fetching activity:", err);
        return { activity: [] };
      }
    }

    function displayGroups(groups) {
      console.log(" displayGroups called with:", groups);
      console.log(" Groups length:", groups?.length || 0);
      
      const container = document.getElementById('groups-container');
      console.log(" Groups container found:", !!container);
      
      if (!container) {
        console.error(" groups-container element not found in DOM");
        alert("ERROR: groups-container not found!");
        return;
      }
      
      console.log(" Container current innerHTML length:", container.innerHTML.length);
      
      if (!groups || groups.length === 0) {
        console.log(" No groups to display, showing empty state");
        const emptyHTML = '<div class="empty-groups">' +
          '<i class="fas fa-users"></i>' +
          '<h3>No Groups Yet</h3>' +
          '<p>You haven\'t joined any study groups yet. Start by finding or creating a group!</p>' +
          '<button class="btn-primary" onclick="window.location.href=\'../ml_model/input.html\'">Find Groups</button>' +
          '</div>';
        container.innerHTML = emptyHTML;
        console.log(" Empty state HTML set");
        return;
      }

      console.log(" About to render", groups.length, "groups");
      
      const groupsHTML = groups.map((group, index) => {
        console.log(" Rendering group " + (index + 1) + ":", group.group_name);
        
        // Build members HTML from real data
        let membersHTML = '';
        if (group.members && group.members.length > 0) {
          const displayMembers = group.members.slice(0, 5); // Show max 5 members
          membersHTML = displayMembers.map(member => 
            `<div class="member-item">
              <img src="${member.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${member.name}`}" alt="${member.name}" class="member-avatar">
              <div class="member-status ${member.status || 'offline'}"></div>
              <span class="member-name">${member.name}</span>
              ${member.role === 'admin' ? '<span class="member-badge admin">Admin</span>' : ''}
              ${member.role === 'moderator' ? '<span class="member-badge mod">Mod</span>' : ''}
            </div>`
          ).join('');
          
          if (group.members.length > 5) {
            membersHTML += `<div class="member-item more">+${group.members.length - 5} more</div>`;
          }
        } else {
          membersHTML = '<div class="no-members">No members yet</div>';
        }
        
        // Build progress milestones from real data
        const progress = group.progress || { percentage: 0, milestones: [] };
        let milestonesHTML = '';
        if (progress.milestones && progress.milestones.length > 0) {
          milestonesHTML = progress.milestones.map(m => {
            const iconClass = m.status === 'completed' ? 'fas fa-check-circle' : 
                             m.status === 'current' ? 'fas fa-play-circle' : 'fas fa-circle';
            return `<div class="milestone ${m.status}" title="${m.status}: ${m.title}">
              <i class="${iconClass}"></i>
            </div>`;
          }).join('');
        } else {
          milestonesHTML = `
            <div class="milestone upcoming" title="No milestones set">
              <i class="fas fa-circle"></i>
            </div>`;
        }
        
        // Build recent activity preview
        let activityPreview = '';
        if (group.recentActivity && group.recentActivity.length > 0) {
          const latestActivity = group.recentActivity[0];
          activityPreview = `<div class="activity-preview">
            <span class="activity-user">${latestActivity.user}</span>
            <span class="activity-action">${latestActivity.description || latestActivity.action}</span>
          </div>`;
        }
        
        return `
        <div class="group-card ${group.isAdmin ? 'is-admin' : ''}" onclick="handleGroupSelection('${group.group_name}', this)" data-group-id="${group._id}">
          <div class="group-header">
            <h4 class="group-name">${group.group_name}</h4>
            <div class="group-badges">
              ${group.isAdmin ? '<span class="admin-badge" title="You are the admin"><i class="fas fa-crown"></i></span>' : ''}
              <span class="group-status ${group.status}">${group.status}</span>
            </div>
          </div>
          
          <p class="group-description">${group.description}</p>
          
          <div class="group-stats">
            <div class="stat-item">
              <div class="stat-value">${group.totalMembers}</div>
              <div class="stat-label">Members</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">${group.activeMembers}</div>
              <div class="stat-label">Online</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">${group.totalMessages || 0}</div>
              <div class="stat-label">Messages</div>
            </div>
          </div>

          <div class="group-progress">
            <div class="progress-header">
              <span class="progress-label">Group Progress</span>
              <span class="progress-percentage">${progress.percentage || 0}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress.percentage || 0}%"></div>
            </div>
            <div class="progress-milestones">
              ${milestonesHTML}
            </div>
          </div>

          <div class="group-members">
            <h4><i class="fas fa-users"></i> Members (${group.members?.length || 0})</h4>
            <div class="members-list">
              ${membersHTML}
            </div>
          </div>
          
          ${activityPreview}

          <div class="group-quick-actions">
            <button onclick="event.stopPropagation(); startVideoCall()" class="quick-btn" title="Start Video Call">
              <i class="fas fa-video"></i>
            </button>
            <button onclick="event.stopPropagation(); openWhiteboard()" class="quick-btn" title="Open Whiteboard">
              <i class="fas fa-chalkboard"></i>
            </button>
            <button onclick="event.stopPropagation(); shareFiles()" class="quick-btn" title="Share Files">
              <i class="fas fa-upload"></i>
            </button>
            <button onclick="event.stopPropagation(); scheduleSession()" class="quick-btn" title="Schedule Session">
              <i class="fas fa-calendar-plus"></i>
            </button>
            ${!group.isAdmin ? `<button onclick="event.stopPropagation(); leaveGroup('${group.group_name}')" class="quick-btn leave-btn" title="Leave Group">
              <i class="fas fa-sign-out-alt"></i>
            </button>` : ''}
          </div>
        </div>
        `;
      }).join('');
      
      console.log(" Generated HTML length:", groupsHTML.length);
      container.innerHTML = groupsHTML;
      console.log(" HTML set to container, new length:", container.innerHTML.length);
      
      // Verify the groups were actually added
      const renderedCards = container.querySelectorAll('.group-card');
      console.log(" Rendered group cards count:", renderedCards.length);
      
      if (renderedCards.length === 0) {
        console.error(" No group cards found after rendering!");
        alert("ERROR: Groups HTML was set but no cards found!");
      } else {
        console.log(" SUCCESS: Group cards successfully rendered");
      }
    }

    console.log(' All functions loaded and ready');

    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize DOM elements
      console.log("================================================================================");
      console.log(" DOMContentLoaded EVENT FIRED!");
      console.log(" Starting groups.html initialization...");
      console.log(" Page URL:", window.location.href);
      console.log("================================================================================");
      
      chatBody = document.querySelector('#chat-body');
      input = document.querySelector('#chat-input');
      
      // Load current user info first
      console.log(" Loading current user info...");
      await loadCurrentUserInfo();
      console.log(" User info loaded");
      
      // Check if groups container exists
      const groupsContainer = document.getElementById('groups-container');
      console.log(" Groups container found:", !!groupsContainer);
      if (groupsContainer) {
        console.log(" Container innerHTML before load:", groupsContainer.innerHTML.length, "chars");
      } else {
        console.error(" CRITICAL: groups-container not found!");
      }

      // Load initial data
      console.log(" About to call loadMatchedGroups...");
      try {
        await loadMatchedGroups();
        console.log(" loadMatchedGroups call completed");
      } catch (error) {
        console.error(" Error calling loadMatchedGroups:", error);
      }
      
      document.getElementById('send-btn').addEventListener('click', sendMessage);
      
      // Emoji button - wrapped in try-catch to prevent errors
      try {
        const emojiBtn = document.querySelector('#emoji-btn');
        if (emojiBtn && typeof EmojiButton !== 'undefined') {
          const picker = new EmojiButton();
        } else {
          console.warn('EmojiButton not available or emoji button not found');
        }
      } catch (error) {
        console.warn('Emoji functionality not available:', error.message);
      }
      document.getElementById('file-upload').addEventListener('change', function(event) {
        console.log('=== FILE UPLOAD TRIGGERED ===');
        const file = event.target.files[0];
        console.log('File selected:', file ? {
          name: file.name,
          size: file.size,
          type: file.type
        } : 'No file');
        console.log('Selected group:', selectedGroupName);
        
        if (!file) {
          console.log(' No file selected');
          alert('Please select a file to upload');
          return;
        }
        
        if (!selectedGroupName) {
          console.log(' No group selected');
          alert('Please select a group first');
          return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('group', selectedGroupName);
        
        const token = localStorage.getItem('token');
        console.log('Token available:', token ? 'Yes' : 'No');
        
        if (!token) {
          console.log(' No authentication token');
          alert('Please log in to upload files');
          return;
        }

        console.log(' Starting upload process...');
        console.log('Upload URL: http://localhost:5000/api/group-upload');
        
        fetch(`${window.location.origin}/api/group-upload`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        })
        .then(response => {
          console.log(' Response received:', response.status, response.statusText);
          return response.json();
        })
        .then(data => {
          console.log(' Response data:', data);
          if (data.message && !data.error) {
            alert('File uploaded successfully!');
            refreshResourcesSection();
            loadGroupFiles(selectedGroupName);
            event.target.value = ''; // Clear file input
          } else {
            throw new Error(data.error || 'Upload failed');
          }
        })
        .catch(error => {
          console.error(' Upload failed:', error);
          alert('Upload failed: ' + error.message);
        });
      });

    // Calendar functionality
    let currentCalendarDate = new Date();

    function switchSessionView(viewType) {
        // Update toggle buttons
        document.querySelectorAll('.view-toggle-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.view === viewType) {
                btn.classList.add('active');
            }
        });

        // Show/hide views
        document.querySelectorAll('.sessions-view').forEach(view => {
            view.classList.remove('active');
        });

        if (viewType === 'calendar') {
            document.getElementById('sessionsCalendarView').classList.add('active');
            initializeCalendar();
        } else {
            document.getElementById('sessionsListView').classList.add('active');
        }
    }

    function initializeCalendar() {
        updateCalendarDisplay();
        loadUpcomingSessions();
    }

    function updateCalendarDisplay() {
        const monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];

        const monthYearElement = document.getElementById('calendarMonthYear');
        if (monthYearElement) {
            monthYearElement.textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
        }

        generateCalendarDays();
    }

    function generateCalendarDays() {
        const calendarDays = document.getElementById('calendarDays');
        if (!calendarDays) return;

        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        
        // First day of the month
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        
        // First day to display (might be from previous month)
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        // Generate 42 days (6 weeks)
        const days = [];
        const currentDate = new Date(startDate);
        
        for (let i = 0; i < 42; i++) {
            const dayElement = createCalendarDay(currentDate, month);
            days.push(dayElement);
            currentDate.setDate(currentDate.getDate() + 1);
        }

        calendarDays.innerHTML = days.join('');
    }

    function createCalendarDay(date, currentMonth) {
        const today = new Date();
        const isToday = date.toDateString() === today.toDateString();
        const isOtherMonth = date.getMonth() !== currentMonth;
        
        // Mock sessions data - in real app, this would come from API
        const mockSessions = getMockSessionsForDate(date);
        const hasSession = mockSessions.length > 0;
        const hasMentorSession = mockSessions.some(s => s.type === 'mentor');

        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (isOtherMonth) classes += ' other-month';
        if (hasSession) classes += ' has-sessions';
        if (hasMentorSession) classes += ' with-mentor';

        const sessionDots = mockSessions.map(session => {
            let dotClass = 'calendar-session-dot';
            if (session.type === 'mentor') dotClass += ' with-mentor';
            if (session.isRecurring) dotClass += ' recurring';
            return `<div class="${dotClass}"></div>`;
        }).join('');

        return `
            <div class="${classes}" onclick="selectCalendarDay('${date.toISOString()}')">
                <div class="calendar-day-number">${date.getDate()}</div>
                <div class="calendar-sessions">${sessionDots}</div>
            </div>
        `;
    }

    function getMockSessionsForDate(date) {
        // Mock data - replace with real API call
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        if (date.toDateString() === tomorrow.toDateString()) {
            return [
                { title: 'JavaScript Advanced', type: 'group', isRecurring: false },
                { title: 'React Hooks', type: 'mentor', isRecurring: false }
            ];
        }
        
        // Random sessions for demo
        const random = Math.random();
        if (random > 0.8) {
            return [{ title: 'Study Session', type: 'group', isRecurring: false }];
        } else if (random > 0.9) {
            return [
                { title: 'Study Session', type: 'group', isRecurring: false },
                { title: 'Mentor Session', type: 'mentor', isRecurring: false }
            ];
        }
        
        return [];
    }

    function navigateMonth(direction) {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
        updateCalendarDisplay();
    }

    function selectCalendarDay(dateString) {
        const date = new Date(dateString);
        console.log('Selected date:', date.toDateString());
        
        // Show sessions for selected day or allow creating new session
        const sessions = getMockSessionsForDate(date);
        if (sessions.length > 0) {
            showDaySessionsPopup(date, sessions);
        } else {
            // Option to create new session on this date
            if (confirm(`No sessions scheduled for ${date.toLocaleDateString()}. Would you like to schedule a new session?`)) {
                scheduleSession();
            }
        }
    }

    function showDaySessionsPopup(date, sessions) {
        alert(`Sessions on ${date.toLocaleDateString()}:\n\n${sessions.map(s => ` ${s.title} (${s.type})`).join('\n')}`);
    }

    function loadUpcomingSessions() {
        const upcomingList = document.getElementById('upcomingSessionsList');
        if (!upcomingList) return;

        // Mock upcoming sessions
        const upcomingSessions = [
            {
                title: 'JavaScript Advanced Concepts',
                date: 'Tomorrow, 3:00 PM',
                type: 'group'
            },
            {
                title: 'React Hooks with Mentor',
                date: 'Wed, 2:00 PM',
                type: 'mentor'
            },
            {
                title: 'Algorithm Practice',
                date: 'Fri, 4:00 PM',
                type: 'group'
            }
        ];

        upcomingList.innerHTML = upcomingSessions.map(session => `
            <div class="upcoming-session-item">
                <div class="upcoming-session-title">
                    ${session.title}
                    ${session.type === 'mentor' ? '<i class="fas fa-user-tie" style="color: #667eea; margin-left: 5px;"></i>' : ''}
                </div>
                <div class="upcoming-session-time">
                    <i class="fas fa-clock"></i>
                    ${session.date}
                </div>
            </div>
        `).join('');
    }

    // Enhanced message sending function
    function sendMessage() {
        if (!input) {
          console.log('Input element not found');
          return;
        }
        
        const msg = input.value.trim();
        if (!msg) return;
        
        if (!selectedGroupName) {
          alert('Please select a group first');
          return;
        }
        
        if (socket && socket.readyState === WebSocket.OPEN) {
          // Enhanced message object with user info
          const messageObj = {
            group: selectedGroupName,
            senderId: currentUser.id,
            senderName: currentUser.name,
            senderEmail: currentUser.email,
            senderAvatar: currentUser.avatar,
            senderRole: currentUser.role,
            message: msg,
            messageType: 'text'
          };
          socket.send(JSON.stringify(messageObj));
          
          // Show message immediately with enhanced UI
          appendEnhancedMessage({
            senderId: currentUser.id,
            senderName: currentUser.name,
            senderAvatar: currentUser.avatar,
            senderRole: currentUser.role,
            message: msg,
            messageType: 'text',
            timestamp: new Date(),
            isOwn: true
          });
          
          input.value = '';
        } else {
          console.log('WebSocket not connected');
          // Still show the message locally
          appendEnhancedMessage({
            senderName: currentUser.name,
            message: msg,
            timestamp: new Date(),
            isOwn: true
          });
          input.value = '';
        }
    }

    // File loading functions
    async function loadGroupFiles(groupName) {
        try {
          console.log('Loading group files (chat version):', groupName);
          
          const response = await fetch(`${window.location.origin}/api/group-files/${encodeURIComponent(groupName)}`);
          
          if (response.ok) {
            const data = await response.json();
            console.log('Chat files loaded:', data.files);
            data.files.forEach(file => {
              appendFileMessage(file);
            });
          } else {
            console.log('Failed to load chat files:', response.status);
          }
        } catch (error) {
          console.error('Error loading chat files:', error);
        }
    }

    function appendFileMessage(file) {
        if (!chatBody) return;
        // Use enhanced message format for file attachments
        appendEnhancedMessage({
          senderName: 'File Share',
          message: `Shared a file: ${file.originalname}`,
          messageType: 'file',
          attachment: {
            filename: file.filename,
            originalname: file.originalname
          },
          timestamp: file.uploadedAt || new Date()
        });
    }

    // Simple page initialization - removed duplicate code
    // The DOMContentLoaded handler above handles all initialization
    
    // Extra helper functions for file handling within DOMContentLoaded scope
    document.addEventListener('DOMContentLoaded', async function() {
      // This is a secondary handler for any remaining setup
      
      // File upload handler
      const fileUpload = document.getElementById('file-upload');
      if (fileUpload) {
        fileUpload.addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (!file) return;
          
          if (!selectedGroupName) {
            alert('Please select a group first');
            return;
          }
          
          uploadFileToGroup(file, selectedGroupName);
        });
      }
    });

      async function loadGroupFiles(groupName) {
        try {
          console.log('Loading group files (chat version):', groupName);
          
          const response = await fetch(`${window.location.origin}/api/group-files/${encodeURIComponent(groupName)}`);
          
          if (response.ok) {
            const data = await response.json();
            console.log('Chat files loaded:', data.files);
            data.files.forEach(file => {
              appendFileMessage(file);
            });
          } else {
            console.log('Failed to load chat files:', response.status);
          }
        } catch (error) {
          console.error('Error loading chat files:', error);
        }
      }

      function appendFileMessage(file) {
          const msg = document.createElement('p');
          msg.innerHTML = `<a href="${window.location.origin}/uploads/${file.filename}" target="_blank"> ${file.originalname}</a>`;
          chatBody.appendChild(msg);
          chatBody.scrollTop = chatBody.scrollHeight;
      }

      // function appendMessage(content, className = '') {
      //   const msg = document.createElement('p');
      //   if (className) msg.classList.add(className);
      //   msg.textContent = content;
      //   chatBody.appendChild(msg);
      //   chatBody.scrollTop = chatBody.scrollHeight;
      // }

      // sendMessage is defined earlier in the file - removed duplicate

      function handleSend(event) {
        if (event.key === 'Enter') {
          sendMessage();
        }
      }
      
      // Basic function existence check for debugging
      console.log(' Page loaded - Modal functions ready');
    });
  </script>

  <!-- Poll Creation Modal -->
  <div class="poll-modal-overlay" id="pollModal">
    <div class="poll-modal">
      <div class="poll-modal-header">
        <h3><i class="fas fa-poll"></i> Create a Poll</h3>
        <button class="poll-modal-close" onclick="closePollModal()">&times;</button>
      </div>
      <div class="poll-modal-body">
        <div class="poll-form-group">
          <label>Question</label>
          <input type="text" class="poll-input" id="pollQuestion" placeholder="Ask your group a question...">
        </div>
        
        <div class="poll-form-group">
          <label>Options</label>
          <div class="poll-options-container" id="pollOptionsContainer">
            <div class="poll-option-row">
              <input type="text" class="poll-input poll-option-input" placeholder="Option 1">
              <button class="poll-remove-option" onclick="removePollOption(this)" title="Remove">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="poll-option-row">
              <input type="text" class="poll-input poll-option-input" placeholder="Option 2">
              <button class="poll-remove-option" onclick="removePollOption(this)" title="Remove">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <button class="poll-add-option" onclick="addPollOption()">
            <i class="fas fa-plus"></i> Add Option
          </button>
        </div>

        <div class="poll-form-group">
          <label>Settings</label>
          <div class="poll-settings">
            <label class="poll-checkbox-label">
              <input type="checkbox" id="pollMultipleChoice">
              Allow multiple votes
            </label>
            <label class="poll-checkbox-label">
              <input type="checkbox" id="pollAnonymous">
              Anonymous voting
            </label>
          </div>
        </div>

        <div class="poll-form-group">
          <label>Duration (optional)</label>
          <select class="poll-input" id="pollDuration">
            <option value="">No time limit</option>
            <option value="1">1 hour</option>
            <option value="6">6 hours</option>
            <option value="12">12 hours</option>
            <option value="24">24 hours</option>
            <option value="48">2 days</option>
            <option value="168">1 week</option>
          </select>
        </div>
      </div>
      <div class="poll-modal-footer">
        <button class="poll-btn poll-btn-cancel" onclick="closePollModal()">Cancel</button>
        <button class="poll-btn poll-btn-create" onclick="submitPoll()">
          <i class="fas fa-paper-plane"></i> Create Poll
        </button>
      </div>
    </div>
  </div>

</body>
</html>