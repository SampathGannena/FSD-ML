<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Mentor Dashboard - StudyFinder</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="../js/notifications.js"></script>
  <script src="../js/mentor-auth-guard.js"></script>
  <script src="../js/toast.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      min-height: 100vh;
    }

    /* Header */
    .dashboard-header {
      background: rgba(26, 26, 46, 0.9);
      backdrop-filter: blur(20px);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid rgba(255, 107, 0, 0.3);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 24px;
      font-weight: 700;
      color: #ff6b00;
    }

    .logo i {
      font-size: 32px;
    }

    .mentor-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .mentor-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6b00, #ff4b2b);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      border: 3px solid rgba(255, 107, 0, 0.3);
    }

    .mentor-details h3 {
      font-size: 16px;
      margin-bottom: 3px;
    }

    .mentor-details p {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .notification-btn {
      position: relative;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 107, 0, 0.3);
      color: #fff;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .notification-btn:hover {
      background: rgba(255, 107, 0, 0.2);
      transform: translateY(-2px);
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4b2b;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .logout-btn {
      background: linear-gradient(135deg, #ff6b00, #ff4b2b);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(255, 107, 0, 0.4);
    }

    /* Main Container */
    .dashboard-container {
      display: flex;
      height: calc(100vh - 80px);
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: rgba(26, 26, 46, 0.7);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 107, 0, 0.2);
      padding: 20px 0;
      overflow-y: auto;
    }

    .sidebar::-webkit-scrollbar {
      width: 0;
      display: none;
    }

    .sidebar::-webkit-scrollbar-track {
      display: none;
    }

    .sidebar::-webkit-scrollbar-thumb {
      display: none;
    }

    .nav-item {
      padding: 15px 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 15px;
      color: rgba(255, 255, 255, 0.7);
      border-left: 3px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255, 107, 0, 0.1);
      color: #ff6b00;
      border-left-color: #ff6b00;
    }

    .nav-item.active {
      background: rgba(255, 107, 0, 0.15);
      color: #ff6b00;
      border-left-color: #ff6b00;
    }

    .nav-item i {
      font-size: 20px;
      width: 25px;
    }

    .nav-badge {
      margin-left: auto;
      background: #ff4b2b;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
    }

    .main-content::-webkit-scrollbar {
      width: 0;
      display: none;
    }

    .main-content::-webkit-scrollbar-track {
      display: none;
    }

    .main-content::-webkit-scrollbar-thumb {
      display: none;
    }

    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(26, 26, 46, 0.7);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 107, 0, 0.2);
      border-radius: 12px;
      padding: 25px;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(255, 107, 0, 0.2);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .stat-icon.blue { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .stat-icon.green { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .stat-icon.orange { background: rgba(255, 107, 0, 0.2); color: #ff6b00; }
    .stat-icon.purple { background: rgba(168, 85, 247, 0.2); color: #a855f7; }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.6);
    }

    .stat-change {
      font-size: 12px;
      color: #10b981;
      margin-top: 10px;
    }

    .stat-change.negative {
      color: #ef4444;
    }

    /* Section Title */
    .section-title {
      font-size: 24px;
      margin-bottom: 20px;
      color: #ff6b00;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Requests List */
    .requests-container {
      background: rgba(26, 26, 46, 0.7);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 107, 0, 0.2);
      border-radius: 12px;
      padding: 25px;
    }

    .request-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .request-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 107, 0, 0.3);
    }

    .request-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .request-student {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .student-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 600;
    }

    .student-info h4 {
      font-size: 16px;
      margin-bottom: 3px;
    }

    .student-info p {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
    }

    .request-time {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
    }

    .request-message {
      padding: 15px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.6;
    }

    .request-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-accept {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .btn-accept:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-decline {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .btn-decline:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    .btn-view {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .btn-view:hover {
      background: rgba(59, 130, 246, 0.3);
    }

    /* Mentees Grid */
    .mentees-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .mentee-card {
      background: rgba(26, 26, 46, 0.7);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 107, 0, 0.2);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .mentee-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(255, 107, 0, 0.2);
    }

    .mentee-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .mentee-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6b00, #ff4b2b);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 600;
    }

    .mentee-info h3 {
      font-size: 18px;
      margin-bottom: 5px;
    }

    .mentee-info p {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
    }

    .mentee-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .mentee-stat {
      text-align: center;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
    }

    .mentee-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #ff6b00;
    }

    .mentee-stat-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 3px;
    }

    .mentee-actions {
      display: flex;
      gap: 10px;
    }

    .btn-small {
      flex: 1;
      padding: 8px 12px;
      font-size: 13px;
    }

    /* Progress Tracker */
    .progress-tracker {
      background: rgba(26, 26, 46, 0.7);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 107, 0, 0.2);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }

    .progress-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .progress-info h4 {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b00, #ff4b2b);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .progress-percentage {
      font-size: 18px;
      font-weight: 700;
      color: #ff6b00;
      min-width: 60px;
      text-align: right;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255, 255, 255, 0.6);
    }

    .empty-state i {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: rgba(255, 255, 255, 0.8);
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 40px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 107, 0, 0.2);
      border-top-color: #ff6b00;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Progress Tracking Styles */
    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b00, #ff8c00);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .btn-small {
      padding: 8px 16px !important;
      font-size: 13px !important;
    }

    .progress-tab-content {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal input,
    .modal textarea,
    .modal select {
      font-family: 'Poppins', sans-serif;
    }

    .modal input:focus,
    .modal textarea:focus,
    .modal select:focus {
      outline: none;
      border-color: #ff6b00;
      box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1);
    }

    /* Filter Buttons */
    .filter-btn {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 107, 0, 0.2);
      color: rgba(255, 255, 255, 0.7);
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filter-btn:hover {
      background: rgba(255, 107, 0, 0.1);
      border-color: rgba(255, 107, 0, 0.4);
      color: white;
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #ff6b00, #ff8c00);
      border-color: #ff6b00;
      color: white;
      font-weight: 600;
    }

    /* Sessions Table */
    .sessions-table {
      width: 100%;
      background: rgba(26, 26, 46, 0.7);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 107, 0, 0.2);
      border-radius: 12px;
      overflow: hidden;
    }

    .sessions-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .sessions-table thead {
      background: rgba(255, 107, 0, 0.1);
    }

    .sessions-table th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #ff6b00;
      border-bottom: 1px solid rgba(255, 107, 0, 0.2);
    }

    .sessions-table td {
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .sessions-table tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .status-badge {
      padding: 5px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .status-badge.pending {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .status-badge.accepted {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .status-badge.completed {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .status-badge.declined {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -280px;
        top: 80px;
        height: calc(100vh - 80px);
        z-index: 100;
        transition: left 0.3s ease;
      }

      .sidebar.active {
        left: 0;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .mentees-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-left">
      <div class="logo">
        <i class="fas fa-graduation-cap"></i>
        <span>Mentor Dashboard</span>
      </div>
    </div>
    <div class="mentor-info">
      <div class="mentor-avatar" id="mentor-avatar">M</div>
      <div class="mentor-details">
        <h3 id="mentor-name">Loading...</h3>
        <p id="mentor-email">Loading...</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="notification-btn" onclick="toggleNotifications()">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notification-count">0</span>
      </button>
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>

  <!-- Main Container -->
  <div class="dashboard-container">
    <!-- Sidebar Navigation -->
    <div class="sidebar">
      <div class="nav-item active" onclick="showSection('overview')">
        <i class="fas fa-chart-line"></i>
        <span>Overview</span>
      </div>
      <div class="nav-item" onclick="showSection('requests')">
        <i class="fas fa-user-plus"></i>
        <span>Requests</span>
        <span class="nav-badge" id="requests-badge">0</span>
      </div>
      <div class="nav-item" onclick="showSection('mentees')">
        <i class="fas fa-users"></i>
        <span>My Mentees</span>
      </div>
      <div class="nav-item" onclick="showSection('progress')">
        <i class="fas fa-chart-bar"></i>
        <span>Progress Tracking</span>
      </div>
      <div class="nav-item" onclick="showSection('sessions')">
        <i class="fas fa-calendar-alt"></i>
        <span>Sessions</span>
      </div>
      <div class="nav-item" onclick="showSection('doubts')">
        <i class="fas fa-question-circle"></i>
        <span>Doubts</span>
        <span class="nav-badge" id="doubts-badge">0</span>
      </div>
      <div class="nav-item" onclick="window.location.href='mentorMain.html'">
        <i class="fas fa-home"></i>
        <span>Main Dashboard</span>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Overview Section -->
      <div class="content-section active" id="overview-section">
        <h2 class="section-title">
          <i class="fas fa-chart-line"></i>
          Dashboard Overview
        </h2>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-value" id="total-mentees">0</div>
                <div class="stat-label">Total Mentees</div>
              </div>
              <div class="stat-icon blue">
                <i class="fas fa-users"></i>
              </div>
            </div>
            <div class="stat-change">
              <i class="fas fa-arrow-up"></i> +12% from last month
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-value" id="completed-sessions">0</div>
                <div class="stat-label">Sessions Completed</div>
              </div>
              <div class="stat-icon green">
                <i class="fas fa-check-circle"></i>
              </div>
            </div>
            <div class="stat-change">
              <i class="fas fa-arrow-up"></i> +8% this week
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-value" id="pending-requests">0</div>
                <div class="stat-label">Pending Requests</div>
              </div>
              <div class="stat-icon orange">
                <i class="fas fa-clock"></i>
              </div>
            </div>
            <div class="stat-change">
              <i class="fas fa-exclamation-circle"></i> Needs attention
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-value" id="avg-rating">4.8</div>
                <div class="stat-label">Average Rating</div>
              </div>
              <div class="stat-icon purple">
                <i class="fas fa-star"></i>
              </div>
            </div>
            <div class="stat-change">
              <i class="fas fa-arrow-up"></i> +0.3 this month
            </div>
          </div>
        </div>

        <h3 class="section-title">
          <i class="fas fa-fire"></i>
          Recent Activity
        </h3>
        <div id="recent-activity" class="requests-container">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading recent activity...</p>
          </div>
        </div>
      </div>

      <!-- Requests Section -->
      <div class="content-section" id="requests-section">
        <h2 class="section-title">
          <i class="fas fa-user-plus"></i>
          Mentorship Requests
        </h2>
        <div id="requests-container" class="requests-container">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading requests...</p>
          </div>
        </div>
      </div>

      <!-- Mentees Section -->
      <div class="content-section" id="mentees-section">
        <h2 class="section-title">
          <i class="fas fa-users"></i>
          My Mentees
        </h2>
        <div id="mentees-grid" class="mentees-grid">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading mentees...</p>
          </div>
        </div>
      </div>

      <!-- Progress Tracking Section -->
      <div class="content-section" id="progress-section">
        <h2 class="section-title">
          <i class="fas fa-chart-bar"></i>
          Mentee Progress Tracking
        </h2>
        
        <!-- Mentee Selector -->
        <div style="margin-bottom: 30px;">
          <select id="progress-mentee-select" onchange="loadMenteeProgress(this.value)" 
                  style="width: 100%; max-width: 400px; padding: 12px; background: rgba(26, 26, 46, 0.7); 
                         border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 8px; color: white; 
                         font-size: 14px;">
            <option value="">Select a mentee to view progress</option>
          </select>
        </div>

        <div id="progress-container">
          <div class="empty-state">
            <i class="fas fa-user-graduate"></i>
            <h3>Select a Mentee</h3>
            <p>Choose a mentee from the dropdown above to view and manage their progress.</p>
          </div>
        </div>
      </div>

      <!-- Sessions Section -->
      <div class="content-section" id="sessions-section">
        <h2 class="section-title">
          <i class="fas fa-calendar-alt"></i>
          Session Management
        </h2>
        <div id="sessions-container" class="sessions-table">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading sessions...</p>
          </div>
        </div>
      </div>

      <!-- Doubts Section -->
      <div class="content-section" id="doubts-section">
        <h2 class="section-title">
          <i class="fas fa-question-circle"></i>
          Student Doubts
        </h2>
        <div id="doubts-container" class="requests-container">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading doubts...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let currentMentor = null;
    let mentees = [];
    let requests = [];
    let doubts = [];
    let currentMenteeId = null;
    let tasks = [];
    let goals = [];
    let sessions = [];
    let sessionFilter = 'all';
    let notifications = [];
    let notificationPanelOpen = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
      await loadMentorProfile();
      await loadDashboardData();
      await updateNotificationBadge(); // Update badge count on init
    });

    // Load mentor profile
    async function loadMentorProfile() {
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch('${window.location.origin}/api/mentor/profile', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          currentMentor = data.profile;
          
          document.getElementById('mentor-name').textContent = data.profile.fullname;
          document.getElementById('mentor-email').textContent = data.profile.email;
          document.getElementById('mentor-avatar').textContent = data.profile.fullname.charAt(0).toUpperCase();
          
          // Update stats
          document.getElementById('total-mentees').textContent = data.stats.menteesGuided || 0;
          document.getElementById('completed-sessions').textContent = data.stats.sessionsCompleted || 0;
          document.getElementById('pending-requests').textContent = data.stats.pendingRequests || 0;
        }
      } catch (error) {
        console.error('Error loading mentor profile:', error);
        Toast.error('Failed to load profile', 'Error');
      }
    }

    // Load all dashboard data
    async function loadDashboardData() {
      await Promise.all([
        loadRequests(),
        loadMentees(),
        loadSessions(),
        loadDoubts(),
        loadRecentActivity()
      ]);
      updateBadges();
    }

    // Load mentorship requests
    async function loadRequests() {
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch('${window.location.origin}/api/mentor/requests', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          requests = data.requests || [];
          displayRequests();
        }
      } catch (error) {
        console.error('Error loading requests:', error);
        displayEmptyRequests();
      }
    }

    // Display requests
    function displayRequests() {
      const container = document.getElementById('requests-container');
      
      const pendingRequests = requests.filter(r => r.status === 'pending');
      
      if (pendingRequests.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>No Pending Requests</h3>
            <p>You're all caught up! New mentorship requests will appear here.</p>
          </div>
        `;
        return;
      }

      const html = pendingRequests.map(request => `
        <div class="request-item">
          <div class="request-header">
            <div class="request-student">
              <div class="student-avatar">${request.learnerName.charAt(0).toUpperCase()}</div>
              <div class="student-info">
                <h4>${request.learnerName}</h4>
                <p>${request.learnerEmail}</p>
              </div>
            </div>
            <div class="request-time">${getTimeAgo(request.requestDate)}</div>
          </div>
          <div class="request-message">
            ${request.message || 'This student wants you as their mentor.'}
          </div>
          <div class="request-actions">
            <button class="btn btn-accept" onclick="handleRequest('${request._id}', 'accepted')">
              <i class="fas fa-check"></i> Accept
            </button>
            <button class="btn btn-decline" onclick="handleRequest('${request._id}', 'declined')">
              <i class="fas fa-times"></i> Decline
            </button>
            <button class="btn btn-view" onclick="viewLearnerProfile('${request.learnerId}')">
              <i class="fas fa-eye"></i> View Profile
            </button>
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    function displayEmptyRequests() {
      document.getElementById('requests-container').innerHTML = `
        <div class="empty-state">
          <i class="fas fa-inbox"></i>
          <h3>No Requests Yet</h3>
          <p>New mentorship requests will appear here.</p>
        </div>
      `;
    }

    // Handle request accept/decline
    async function handleRequest(requestId, status) {
      try {
        const token = localStorage.getItem('mentorToken');
        const message = status === 'accepted' 
          ? 'Welcome to my mentorship program! I look forward to guiding you.'
          : 'Thank you for your interest. Unfortunately, I cannot accept more mentees at this time.';

        const response = await fetch(`${window.location.origin}/api/mentor/requests/${requestId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status, message })
        });

        if (response.ok) {
          Toast.success(
            status === 'accepted' ? 'Request accepted successfully!' : 'Request declined',
            status === 'accepted' ? 'Success' : 'Declined'
          );
          await loadDashboardData();
        } else {
          const data = await response.json();
          Toast.error(data.error || 'Failed to update request', 'Error');
        }
      } catch (error) {
        console.error('Error handling request:', error);
        Toast.error('Failed to update request', 'Error');
      }
    }

    // Load mentees
    async function loadMentees() {
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch('${window.location.origin}/api/mentor/mentees', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          mentees = data.mentees || [];
          displayMentees();
          populateMenteeSelectors();
        }
      } catch (error) {
        console.error('Error loading mentees:', error);
        displayEmptyMentees();
      }
    }

    // Populate mentee selectors
    function populateMenteeSelectors() {
      const progressSelect = document.getElementById('progress-mentee-select');
      
      const options = mentees.map(mentee => 
        `<option value="${mentee.id}">${mentee.name}</option>`
      ).join('');
      
      progressSelect.innerHTML = `
        <option value="">Select a mentee to view progress</option>
        ${options}
      `;
    }

    // Display mentees
    function displayMentees() {
      const container = document.getElementById('mentees-grid');
      
      if (mentees.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-users"></i>
            <h3>No Mentees Yet</h3>
            <p>Accept mentorship requests to start guiding students.</p>
          </div>
        `;
        return;
      }

      const html = mentees.map(mentee => {
        const lastActiveText = mentee.lastActive 
          ? getTimeAgo(mentee.lastActive)
          : 'Never';
        const taskProgress = mentee.tasksCount > 0 
          ? Math.round((mentee.completedTasks / mentee.tasksCount) * 100)
          : 0;
        
        return `
        <div class="mentee-card" style="background: rgba(26, 26, 46, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 107, 0, 0.2); border-radius: 15px; padding: 20px; transition: all 0.3s ease;">
          <div class="mentee-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
            <div class="mentee-avatar" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #ff6b00, #ff8c00); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: white; flex-shrink: 0;">
              ${mentee.name.charAt(0).toUpperCase()}
            </div>
            <div class="mentee-info" style="flex: 1; min-width: 0;">
              <h3 style="font-size: 18px; font-weight: 600; color: white; margin: 0 0 5px 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${mentee.name}</h3>
              <p style="font-size: 13px; color: rgba(255, 255, 255, 0.6); margin: 0 0 3px 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                <i class="fas fa-envelope"></i> ${mentee.email}
              </p>
              <p style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin: 0;">
                <i class="fas fa-clock"></i> Active ${lastActiveText}
              </p>
            </div>
          </div>
          
          ${mentee.bio ? `
          <div style="margin-bottom: 15px; padding: 10px; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
            <p style="font-size: 13px; color: rgba(255, 255, 255, 0.7); margin: 0; line-height: 1.4;">
              <i class="fas fa-quote-left" style="font-size: 10px; opacity: 0.5;"></i>
              ${mentee.bio.substring(0, 100)}${mentee.bio.length > 100 ? '...' : ''}
              <i class="fas fa-quote-right" style="font-size: 10px; opacity: 0.5;"></i>
            </p>
          </div>
          ` : ''}
          
          <div class="mentee-badges" style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
            ${mentee.streak > 0 ? `
            <span style="background: rgba(255, 107, 0, 0.2); color: #ff6b00; padding: 4px 10px; border-radius: 12px; font-size: 11px; display: flex; align-items: center; gap: 4px;">
              <i class="fas fa-fire"></i> ${mentee.streak} day streak
            </span>
            ` : ''}
            ${mentee.groups && mentee.groups.length > 0 ? `
            <span style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 4px 10px; border-radius: 12px; font-size: 11px; display: flex; align-items: center; gap: 4px; cursor: pointer;" title="${mentee.groups.join(', ')}">
              <i class="fas fa-users"></i> ${mentee.groups.slice(0, 2).join(', ')}${mentee.groups.length > 2 ? ` +${mentee.groups.length - 2}` : ''}
            </span>
            ` : ''}
            ${mentee.badges && mentee.badges.length > 0 ? `
            <span style="background: rgba(168, 85, 247, 0.2); color: #a855f7; padding: 4px 10px; border-radius: 12px; font-size: 11px; display: flex; align-items: center; gap: 4px;">
              <i class="fas fa-award"></i> ${mentee.badges.length} badges
            </span>
            ` : ''}
          </div>
          
          <div class="mentee-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 10px; padding: 12px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #3b82f6; margin-bottom: 4px;">${mentee.sessionsCount || 0}</div>
              <div style="font-size: 11px; color: rgba(255, 255, 255, 0.6);">Total Sessions</div>
              <div style="font-size: 10px; color: rgba(255, 255, 255, 0.4); margin-top: 2px;">${mentee.completedSessions || 0} completed</div>
            </div>
            <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 10px; padding: 12px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #10b981; margin-bottom: 4px;">${mentee.tasksCount || 0}</div>
              <div style="font-size: 11px; color: rgba(255, 255, 255, 0.6);">Tasks</div>
              <div style="font-size: 10px; color: rgba(255, 255, 255, 0.4); margin-top: 2px;">${taskProgress}% complete</div>
            </div>
            <div style="background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 10px; padding: 12px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #a855f7; margin-bottom: 4px;">${mentee.goalsCount || 0}</div>
              <div style="font-size: 11px; color: rgba(255, 255, 255, 0.6);">Goals</div>
            </div>
            <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 10px; padding: 12px; text-align: center;">
              <div style="font-size: 11px; color: rgba(255, 255, 255, 0.6); margin-bottom: 4px;">Joined</div>
              <div style="font-size: 12px; font-weight: 600; color: #f59e0b;">${new Date(mentee.acceptedDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
            </div>
          </div>
          
          <div class="mentee-actions" style="display: flex; gap: 8px;">
            <button class="btn btn-small" onclick="viewMenteeProfile('${mentee.id}')" style="flex: 1; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6; padding: 10px; border-radius: 8px; font-size: 13px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i class="fas fa-user"></i> Profile
            </button>
            <button class="btn btn-small" onclick="viewMenteeProgress('${mentee.id}')" style="flex: 1; background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981; padding: 10px; border-radius: 8px; font-size: 13px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i class="fas fa-chart-line"></i> Progress
            </button>
            <button class="btn btn-small" onclick="scheduleMeeting('${mentee.id}', '${mentee.name}')" style="flex: 1; background: rgba(168, 85, 247, 0.2); border: 1px solid rgba(168, 85, 247, 0.3); color: #a855f7; padding: 10px; border-radius: 8px; font-size: 13px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px;">
              <i class="fas fa-calendar"></i> Schedule
            </button>
          </div>
        </div>
      `;
      }).join('');

      container.innerHTML = html;
    }

    function displayEmptyMentees() {
      document.getElementById('mentees-grid').innerHTML = `
        <div class="empty-state">
          <i class="fas fa-users"></i>
          <h3>No Mentees Yet</h3>
          <p>Accept mentorship requests to start guiding students.</p>
        </div>
      `;
    }

    // Load sessions
    async function loadSessions() {
      const container = document.getElementById('sessions-container');
      container.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading sessions...</p>
        </div>
      `;
      
      try {
        const token = localStorage.getItem('mentorToken');
        let url = '${window.location.origin}/api/mentor/sessions';
        
        // Apply filters
        const params = new URLSearchParams();
        if (sessionFilter === 'upcoming') params.append('upcoming', 'true');
        else if (sessionFilter === 'past') params.append('past', 'true');
        else if (sessionFilter !== 'all') params.append('status', sessionFilter);
        
        if (params.toString()) url += '?' + params.toString();
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          sessions = data.sessions || [];
          displaySessions(sessions);
        } else {
          throw new Error('Failed to fetch sessions');
        }
      } catch (error) {
        console.error('Error loading sessions:', error);
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-circle"></i>
            <h3>Error Loading Sessions</h3>
            <p>Failed to load sessions. Please try again.</p>
          </div>
        `;
      }
    }

    function displaySessions(sessionsList) {
      const container = document.getElementById('sessions-container');
      
      if (sessionsList.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-calendar-alt"></i>
            <h3>No Sessions Found</h3>
            <p>Schedule a session with your mentees to get started.</p>
            <button class="btn btn-accept" onclick="showScheduleSessionModal()" style="margin-top: 20px; display: inline-flex; align-items: center; justify-content: center;">
              <i class="fas fa-plus"></i> Schedule Session
            </button>
          </div>
        `;
        return;
      }

      const now = new Date();
      const html = `
        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="filter-btn ${sessionFilter === 'all' ? 'active' : ''}" onclick="filterSessions('all')">
              All Sessions
            </button>
            <button class="filter-btn ${sessionFilter === 'upcoming' ? 'active' : ''}" onclick="filterSessions('upcoming')">
              Upcoming
            </button>
            <button class="filter-btn ${sessionFilter === 'completed' ? 'active' : ''}" onclick="filterSessions('completed')">
              Completed
            </button>
            <button class="filter-btn ${sessionFilter === 'cancelled' ? 'active' : ''}" onclick="filterSessions('cancelled')">
              Cancelled
            </button>
          </div>
          <button class="btn btn-accept" onclick="showScheduleSessionModal()" style="white-space: nowrap;">
            <i class="fas fa-plus"></i> Schedule Session
          </button>
        </div>

        <div style="display: grid; gap: 15px;">
          ${sessionsList.map(session => {
            const sessionDate = new Date(session.scheduledDate);
            const isUpcoming = sessionDate > now && (session.status === 'scheduled' || session.status === 'rescheduled');
            const isPast = sessionDate < now;
            const statusColors = {
              'scheduled': '#3b82f6',
              'ongoing': '#10b981',
              'completed': '#10b981',
              'cancelled': '#ef4444',
              'rescheduled': '#f59e0b',
              'no-show': '#6b7280'
            };
            
            return `
              <div class="request-item" style="border-left: 4px solid ${statusColors[session.status] || '#3b82f6'};">
                <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 20px; align-items: start;">
                  <!-- Date/Time Column -->
                  <div style="text-align: center; min-width: 80px;">
                    <div style="font-size: 28px; font-weight: 700; color: #ff6b00; line-height: 1;">
                      ${sessionDate.getDate()}
                    </div>
                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); text-transform: uppercase;">
                      ${sessionDate.toLocaleString('default', { month: 'short' })}
                    </div>
                    <div style="font-size: 13px; color: rgba(255, 255, 255, 0.8); margin-top: 5px;">
                      ${sessionDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                  </div>

                  <!-- Session Details -->
                  <div>
                    <h4 style="font-size: 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                      ${session.title}
                      <span class="status-badge ${session.status}">${session.status}</span>
                      ${session.type !== 'one-on-one' ? `<span style="padding: 4px 10px; background: rgba(255, 107, 0, 0.2); border-radius: 12px; font-size: 11px; color: #ff6b00;">${session.type}</span>` : ''}
                    </h4>
                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-bottom: 10px;">
                      ${session.description || 'No description provided'}
                    </p>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 13px; color: rgba(255, 255, 255, 0.6);">
                      <span><i class="fas fa-user"></i> ${session.menteeName}</span>
                      <span><i class="fas fa-clock"></i> ${session.duration} minutes</span>
                      <span><i class="fas fa-${session.mode === 'video-call' ? 'video' : session.mode === 'audio-call' ? 'phone' : session.mode === 'chat' ? 'comment' : session.mode === 'in-person' ? 'handshake' : 'desktop'}"></i> ${session.mode.replace('-', ' ')}</span>
                      ${session.meetingLink ? `<a href="${session.meetingLink}" target="_blank" style="color: #3b82f6;"><i class="fas fa-link"></i> Join Meeting</a>` : ''}
                    </div>
                    ${session.agenda && session.agenda.length > 0 ? `
                      <div style="margin-top: 10px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 5px;">Agenda:</div>
                        ${session.agenda.slice(0, 3).map(item => `
                          <div style="font-size: 13px; color: rgba(255, 255, 255, 0.8); margin-bottom: 3px;">
                            ${item.completed ? '✅' : '⭕'} ${item.item}
                          </div>
                        `).join('')}
                        ${session.agenda.length > 3 ? `<div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">+${session.agenda.length - 3} more</div>` : ''}
                      </div>
                    ` : ''}
                  </div>

                  <!-- Actions -->
                  <div style="display: flex; flex-direction: column; gap: 8px; min-width: 120px;">
                    ${isUpcoming && session.status === 'scheduled' ? `
                      <button class="btn btn-accept btn-small" onclick="startSession('${session._id}')">
                        <i class="fas fa-play"></i> Start
                      </button>
                      <button class="btn btn-view btn-small" onclick="viewSessionDetails('${session._id}')">
                        <i class="fas fa-eye"></i> View
                      </button>
                      <button class="btn btn-view btn-small" onclick="editSession('${session._id}')">
                        <i class="fas fa-edit"></i> Edit
                      </button>
                      <button class="btn btn-decline btn-small" onclick="cancelSession('${session._id}')">
                        <i class="fas fa-times"></i> Cancel
                      </button>
                    ` : session.status === 'ongoing' ? `
                      <button class="btn btn-accept btn-small" onclick="endSession('${session._id}')">
                        <i class="fas fa-stop"></i> End Session
                      </button>
                      <button class="btn btn-view btn-small" onclick="viewSessionDetails('${session._id}')">
                        <i class="fas fa-eye"></i> View
                      </button>
                    ` : session.status === 'completed' ? `
                      <button class="btn btn-view btn-small" onclick="viewSessionDetails('${session._id}')">
                        <i class="fas fa-eye"></i> View Details
                      </button>
                      ${session.feedback && session.feedback.menteeRating ? `
                        <div style="background: rgba(16, 185, 129, 0.2); padding: 8px; border-radius: 6px; text-align: center;">
                          <div style="color: #10b981; font-size: 18px;">⭐ ${session.feedback.menteeRating}</div>
                          <div style="font-size: 10px; color: rgba(255, 255, 255, 0.6);">Mentee Rating</div>
                        </div>
                      ` : ''}
                    ` : `
                      <button class="btn btn-view btn-small" onclick="viewSessionDetails('${session._id}')">
                        <i class="fas fa-eye"></i> View
                      </button>
                      <button class="btn btn-decline btn-small" onclick="deleteSession('${session._id}')">
                        <i class="fas fa-trash"></i> Delete
                      </button>
                    `}
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      container.innerHTML = html;
      
      // Update completed sessions count in overview
      const completedCount = sessionsList.filter(s => s.status === 'completed').length;
      const completedSessionsEl = document.getElementById('completed-sessions');
      if (completedSessionsEl) {
        completedSessionsEl.textContent = completedCount;
      }
    }

    function filterSessions(filter) {
      sessionFilter = filter;
      loadSessions();
    }

    // Load doubts
    async function loadDoubts() {
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch('${window.location.origin}/api/mentor/doubts', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          doubts = data.doubts || [];
          displayDoubts();
        }
      } catch (error) {
        console.error('Error loading doubts:', error);
        displayEmptyDoubts();
      }
    }

    // Display doubts
    function displayDoubts() {
      const container = document.getElementById('doubts-container');
      
      const openDoubts = doubts.filter(d => d.status === 'open' || d.status === 'in-progress');
      
      if (openDoubts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <h3>All Caught Up!</h3>
            <p>No pending doubts at the moment.</p>
          </div>
        `;
        return;
      }

      const html = openDoubts.map(doubt => `
        <div class="request-item">
          <div class="request-header">
            <div class="request-student">
              <div class="student-avatar">${doubt.studentName.charAt(0).toUpperCase()}</div>
              <div class="student-info">
                <h4>${doubt.studentName}</h4>
                <p>${doubt.category} - ${doubt.priority.toUpperCase()} Priority</p>
              </div>
            </div>
            <div class="request-time">${getTimeAgo(doubt.createdAt)}</div>
          </div>
          <div class="request-message">
            <strong>${doubt.subject}</strong><br>
            ${doubt.question}
          </div>
          <div class="request-actions">
            <button class="btn btn-accept" onclick="answerDoubt('${doubt._id}')">
              <i class="fas fa-reply"></i> Answer
            </button>
            <button class="btn btn-view" onclick="viewDoubtDetails('${doubt._id}')">
              <i class="fas fa-eye"></i> View Details
            </button>
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    function displayEmptyDoubts() {
      document.getElementById('doubts-container').innerHTML = `
        <div class="empty-state">
          <i class="fas fa-check-circle"></i>
          <h3>No Doubts</h3>
          <p>Student doubts will appear here.</p>
        </div>
      `;
    }

    // Load recent activity
    async function loadRecentActivity() {
      try {
        const token = localStorage.getItem('mentorToken');
        console.log('Loading recent activity...');
        
        // Fetch recent data from multiple sources
        const [requestsRes, sessionsRes, doubtsRes] = await Promise.all([
          fetch('${window.location.origin}/api/mentor/requests', {
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
          }),
          fetch('${window.location.origin}/api/mentor/sessions', {
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
          }),
          fetch('${window.location.origin}/api/mentor/doubts', {
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
          })
        ]);

        const activities = [];

        // Parse requests
        if (requestsRes.ok) {
          const requestsData = await requestsRes.json();
          (requestsData.requests || []).forEach(req => {
            activities.push({
              type: 'request',
              icon: 'user-plus',
              color: '#3b82f6',
              title: 'New Mentorship Request',
              description: `${req.learnerName} wants to be your mentee`,
              time: req.createdAt,
              status: req.status
            });
          });
        }

        // Parse sessions
        if (sessionsRes.ok) {
          const sessionsData = await sessionsRes.json();
          (sessionsData.sessions || []).slice(0, 5).forEach(session => {
            activities.push({
              type: 'session',
              icon: session.status === 'completed' ? 'check-circle' : 'calendar-alt',
              color: session.status === 'completed' ? '#10b981' : '#a855f7',
              title: session.status === 'completed' ? 'Session Completed' : 'Upcoming Session',
              description: `${session.title} with ${session.menteeName}`,
              time: session.scheduledDate,
              status: session.status
            });
          });
        }

        // Parse doubts
        if (doubtsRes.ok) {
          const doubtsData = await doubtsRes.json();
          (doubtsData.doubts || []).slice(0, 3).forEach(doubt => {
            activities.push({
              type: 'doubt',
              icon: 'question-circle',
              color: '#f59e0b',
              title: 'New Doubt Posted',
              description: doubt.question.substring(0, 60) + '...',
              time: doubt.createdAt,
              status: doubt.status
            });
          });
        }

        // Sort by time (most recent first)
        activities.sort((a, b) => new Date(b.time) - new Date(a.time));

        console.log('Recent activities:', activities.length);
        // Display only the 10 most recent activities
        displayRecentActivity(activities.slice(0, 10));
        
      } catch (error) {
        console.error('Error loading recent activity:', error);
        document.getElementById('recent-activity').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-circle"></i>
            <h3>Failed to Load Activity</h3>
            <p>Could not load recent activity.</p>
          </div>
        `;
      }
    }

    function displayRecentActivity(activities) {
      const container = document.getElementById('recent-activity');
      
      if (activities.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>No Recent Activity</h3>
            <p>Your recent activities will appear here.</p>
          </div>
        `;
        return;
      }

      const html = activities.map(activity => `
        <div class="request-item" style="border-left: 3px solid ${activity.color};">
          <div style="display: flex; gap: 15px; align-items: start;">
            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${activity.color}20; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <i class="fas fa-${activity.icon}" style="color: ${activity.color}; font-size: 18px;"></i>
            </div>
            <div style="flex: 1;">
              <h4 style="font-size: 14px; margin-bottom: 5px; font-weight: 600;">${activity.title}</h4>
              <p style="color: rgba(255, 255, 255, 0.7); font-size: 13px; margin-bottom: 5px;">${activity.description}</p>
              <span style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">
                <i class="far fa-clock"></i> ${getTimeAgo(activity.time)}
              </span>
            </div>
            ${activity.status ? `<span class="status-badge ${activity.status}" style="font-size: 11px; padding: 4px 10px;">${activity.status}</span>` : ''}
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    // Update navigation badges
    function updateBadges() {
      const pendingRequests = requests.filter(r => r.status === 'pending').length;
      const openDoubts = doubts.filter(d => d.status === 'open' || d.status === 'in-progress').length;
      
      document.getElementById('requests-badge').textContent = pendingRequests;
      document.getElementById('doubts-badge').textContent = openDoubts;
      document.getElementById('notification-count').textContent = pendingRequests + openDoubts;
      
      // Update pending requests stat
      document.getElementById('pending-requests').textContent = pendingRequests;
    }

    // Navigation
    function showSection(sectionName) {
      // Update nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.currentTarget.classList.add('active');

      // Update content sections
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(`${sectionName}-section`).classList.add('active');
    }

    // Utility functions
    function getTimeAgo(timestamp) {
      const now = new Date();
      const diff = now - new Date(timestamp);
      const minutes = Math.floor(diff / (1000 * 60));
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));

      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      return `${days}d ago`;
    }

    function viewLearnerProfile(learnerId) {
      Toast.info('Profile viewer coming soon!', 'Info');
    }

    function viewMenteeProgress(menteeId) {
      document.getElementById('progress-mentee-select').value = menteeId;
      loadMenteeProgress(menteeId);
      showSection('progress');
    }

    async function viewMenteeProfile(menteeId) {
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch(`${window.location.origin}/api/mentor/mentees/${menteeId}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          showMenteeProfileModal(data);
        } else {
          Toast.error('Failed to load mentee profile', 'Error');
        }
      } catch (error) {
        console.error('Error loading mentee profile:', error);
        Toast.error('Failed to load mentee profile', 'Error');
      }
    }

    function showMenteeProfileModal(data) {
      const { profile, stats, recentSessions, recentTasks, activeGoals } = data;
      
      const modalHTML = `
        <div id="mentee-profile-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 20px; animation: fadeIn 0.3s ease;">
          <div style="background: rgba(26, 26, 46, 0.98); backdrop-filter: blur(20px); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 20px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);">
            
            <!-- Header -->
            <div style="padding: 30px; border-bottom: 1px solid rgba(255, 107, 0, 0.2); display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 20px;">
                <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #ff6b00, #ff8c00); display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: bold; color: white;">
                  ${profile.name.charAt(0).toUpperCase()}
                </div>
                <div>
                  <h2 style="font-size: 28px; color: #ff6b00; margin: 0 0 8px 0;">${profile.name}</h2>
                  <p style="font-size: 14px; color: rgba(255, 255, 255, 0.6); margin: 0 0 5px 0;">
                    <i class="fas fa-envelope"></i> ${profile.email}
                  </p>
                  <p style="font-size: 13px; color: rgba(255, 255, 255, 0.5); margin: 0;">
                    <i class="fas fa-calendar-alt"></i> Member since ${new Date(profile.createdAt).toLocaleDateString()}
                  </p>
                </div>
              </div>
              <button onclick="closeMenteeProfileModal()" style="background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 0; width: 40px; height: 40px;">&times;</button>
            </div>
            
            <!-- Bio & Badges -->
            <div style="padding: 20px 30px; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
              ${profile.bio ? `
              <div style="background: rgba(255, 255, 255, 0.03); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                <h4 style="font-size: 13px; color: rgba(255, 255, 255, 0.5); margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 1px;">About</h4>
                <p style="font-size: 14px; color: rgba(255, 255, 255, 0.8); margin: 0; line-height: 1.6;">${profile.bio}</p>
              </div>
              ` : ''}
              
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                ${profile.streak > 0 ? `
                <span style="background: rgba(255, 107, 0, 0.2); border: 1px solid rgba(255, 107, 0, 0.3); color: #ff6b00; padding: 8px 15px; border-radius: 15px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                  <i class="fas fa-fire"></i> ${profile.streak} day streak
                </span>
                ` : ''}
                ${profile.groups && profile.groups.length > 0 ? `
                <span style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6; padding: 8px 15px; border-radius: 15px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                  <i class="fas fa-users"></i> ${profile.groups.length} study groups
                </span>
                ` : ''}
                ${profile.badges && profile.badges.length > 0 ? `
                <span style="background: rgba(168, 85, 247, 0.2); border: 1px solid rgba(168, 85, 247, 0.3); color: #a855f7; padding: 8px 15px; border-radius: 15px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                  <i class="fas fa-award"></i> ${profile.badges.length} badges earned
                </span>
                ` : ''}
                ${profile.lastActive ? `
                <span style="background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981; padding: 8px 15px; border-radius: 15px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                  <i class="fas fa-circle" style="font-size: 8px;"></i> Last active ${getTimeAgo(profile.lastActive)}
                </span>
                ` : ''}
              </div>
            </div>
            
            <!-- Stats Grid -->
            <div style="padding: 20px 30px; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
              <h3 style="font-size: 16px; color: white; margin: 0 0 15px 0;">Performance Overview</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 15px; text-align: center;">
                  <div style="font-size: 32px; font-weight: bold; color: #3b82f6; margin-bottom: 5px;">${stats.totalSessions}</div>
                  <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 3px;">Total Sessions</div>
                  <div style="font-size: 11px; color: rgba(255, 255, 255, 0.4);">${stats.completedSessions} completed</div>
                </div>
                <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 12px; padding: 15px; text-align: center;">
                  <div style="font-size: 32px; font-weight: bold; color: #10b981; margin-bottom: 5px;">${stats.totalTasks}</div>
                  <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 3px;">Tasks</div>
                  <div style="font-size: 11px; color: rgba(255, 255, 255, 0.4);">${stats.completedTasks} completed</div>
                </div>
                <div style="background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 12px; padding: 15px; text-align: center;">
                  <div style="font-size: 32px; font-weight: bold; color: #a855f7; margin-bottom: 5px;">${stats.totalGoals}</div>
                  <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 3px;">Goals</div>
                  <div style="font-size: 11px; color: rgba(255, 255, 255, 0.4);">${stats.completedGoals} completed</div>
                </div>
                ${stats.averageRating ? `
                <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 12px; padding: 15px; text-align: center;">
                  <div style="font-size: 32px; font-weight: bold; color: #ffd700; margin-bottom: 5px;">${stats.averageRating} <i class="fas fa-star" style="font-size: 20px;"></i></div>
                  <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">Avg Rating</div>
                </div>
                ` : ''}
                ${stats.upcomingSessions > 0 ? `
                <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 12px; padding: 15px; text-align: center;">
                  <div style="font-size: 32px; font-weight: bold; color: #f59e0b; margin-bottom: 5px;">${stats.upcomingSessions}</div>
                  <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">Upcoming</div>
                </div>
                ` : ''}
                ${stats.overdueTasks > 0 ? `
                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 12px; padding: 15px; text-align: center;">
                  <div style="font-size: 32px; font-weight: bold; color: #ef4444; margin-bottom: 5px;">${stats.overdueTasks}</div>
                  <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">Overdue Tasks</div>
                </div>
                ` : ''}
              </div>
            </div>
            
            <!-- Recent Activity Tabs -->
            <div style="padding: 20px 30px;">
              <h3 style="font-size: 16px; color: white; margin: 0 0 15px 0;">Recent Activity</h3>
              
              ${profile.groupDetails && profile.groupDetails.length > 0 ? `
              <div style="margin-bottom: 20px;">
                <h4 style="font-size: 14px; color: rgba(255, 255, 255, 0.7); margin: 0 0 10px 0;">
                  <i class="fas fa-users"></i> Study Groups (${profile.groupDetails.length})
                </h4>
                <div style="display: grid; gap: 10px;">
                  ${profile.groupDetails.map(group => `
                    <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); padding: 12px; border-radius: 10px;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                        <div style="font-size: 15px; color: #3b82f6; font-weight: 600;">
                          <i class="fas fa-users" style="font-size: 12px;"></i> ${group.name}
                        </div>
                        <span style="background: ${group.status === 'active' ? 'rgba(16, 185, 129, 0.2)' : 'rgba(107, 114, 128, 0.2)'}; color: ${group.status === 'active' ? '#10b981' : '#6b7280'}; padding: 3px 8px; border-radius: 10px; font-size: 10px; text-transform: uppercase;">
                          ${group.status}
                        </span>
                      </div>
                      ${group.description ? `
                      <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 8px; line-height: 1.4;">
                        ${group.description.substring(0, 80)}${group.description.length > 80 ? '...' : ''}
                      </div>
                      ` : ''}
                      <div style="display: flex; gap: 15px; font-size: 11px; color: rgba(255, 255, 255, 0.5);">
                        <span>
                          <i class="fas fa-tag"></i> ${group.category || 'General'}
                        </span>
                        <span>
                          <i class="fas fa-user-friends"></i> ${group.memberCount} members
                        </span>
                        <span>
                          <i class="far fa-calendar"></i> ${new Date(group.createdAt).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}
                        </span>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
              ` : ''}
              
              ${recentSessions && recentSessions.length > 0 ? `
              <div style="margin-bottom: 20px;">
                <h4 style="font-size: 14px; color: rgba(255, 255, 255, 0.7); margin: 0 0 10px 0;">
                  <i class="fas fa-calendar"></i> Recent Sessions
                </h4>
                ${recentSessions.map(session => `
                  <div style="background: rgba(255, 255, 255, 0.03); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${session.status === 'completed' ? '#10b981' : session.status === 'scheduled' ? '#3b82f6' : '#6b7280'};">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                      <div>
                        <div style="font-size: 14px; color: white; font-weight: 500;">${session.title}</div>
                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 3px;">
                          <i class="far fa-calendar"></i> ${new Date(session.scheduledDate).toLocaleDateString()} • ${session.duration}min
                        </div>
                      </div>
                      <span style="background: ${session.status === 'completed' ? 'rgba(16, 185, 129, 0.2)' : session.status === 'scheduled' ? 'rgba(59, 130, 246, 0.2)' : 'rgba(107, 114, 128, 0.2)'}; color: ${session.status === 'completed' ? '#10b981' : session.status === 'scheduled' ? '#3b82f6' : '#6b7280'}; padding: 4px 10px; border-radius: 12px; font-size: 11px;">
                        ${session.status}
                      </span>
                    </div>
                  </div>
                `).join('')}
              </div>
              ` : ''}
              
              ${recentTasks && recentTasks.length > 0 ? `
              <div style="margin-bottom: 20px;">
                <h4 style="font-size: 14px; color: rgba(255, 255, 255, 0.7); margin: 0 0 10px 0;">
                  <i class="fas fa-tasks"></i> Recent Tasks
                </h4>
                ${recentTasks.map(task => `
                  <div style="background: rgba(255, 255, 255, 0.03); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${task.status === 'completed' ? '#10b981' : task.status === 'in-progress' ? '#f59e0b' : '#6b7280'};">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                      <div style="flex: 1;">
                        <div style="font-size: 14px; color: white; font-weight: 500;">${task.title}</div>
                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 3px;">
                          ${task.dueDate ? `<i class="far fa-clock"></i> Due ${new Date(task.dueDate).toLocaleDateString()}` : 'No due date'}
                        </div>
                      </div>
                      <span style="background: ${task.status === 'completed' ? 'rgba(16, 185, 129, 0.2)' : task.status === 'in-progress' ? 'rgba(245, 158, 11, 0.2)' : 'rgba(107, 114, 128, 0.2)'}; color: ${task.status === 'completed' ? '#10b981' : task.status === 'in-progress' ? '#f59e0b' : '#6b7280'}; padding: 4px 10px; border-radius: 12px; font-size: 11px;">
                        ${task.status}
                      </span>
                    </div>
                  </div>
                `).join('')}
              </div>
              ` : ''}
              
              ${activeGoals && activeGoals.length > 0 ? `
              <div>
                <h4 style="font-size: 14px; color: rgba(255, 255, 255, 0.7); margin: 0 0 10px 0;">
                  <i class="fas fa-bullseye"></i> Active Goals
                </h4>
                ${activeGoals.map(goal => `
                  <div style="background: rgba(255, 255, 255, 0.03); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #a855f7;">
                    <div style="font-size: 14px; color: white; font-weight: 500; margin-bottom: 5px;">${goal.title}</div>
                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">
                      ${goal.targetDate ? `<i class="far fa-calendar-check"></i> Target: ${new Date(goal.targetDate).toLocaleDateString()}` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
              ` : ''}
            </div>
            
            <!-- Footer Actions -->
            <div style="padding: 20px 30px; border-top: 1px solid rgba(255, 255, 255, 0.05); display: flex; gap: 10px;">
              <button onclick="viewMenteeProgress('${profile.id}')" style="flex: 1; background: linear-gradient(135deg, #10b981, #059669); border: none; color: white; padding: 12px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-chart-line"></i> View Full Progress
              </button>
              <button onclick="scheduleMeeting('${profile.id}', '${profile.name}')" style="flex: 1; background: linear-gradient(135deg, #a855f7, #9333ea); border: none; color: white; padding: 12px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-calendar-plus"></i> Schedule Session
              </button>
            </div>
            
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function closeMenteeProfileModal() {
      const modal = document.getElementById('mentee-profile-modal');
      if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => modal.remove(), 300);
      }
    }

    function scheduleMeeting(menteeId, menteeName) {
      closeMenteeProfileModal();
      // Pre-fill the session form if it exists
      const sessionMenteeSelect = document.getElementById('session-mentee-id');
      if (sessionMenteeSelect) {
        sessionMenteeSelect.value = menteeId;
      }
      showSection('sessions');
      document.getElementById('schedule-session-btn')?.click();
    }

    function answerDoubt(doubtId) {
      Toast.info('Doubt answering system coming soon!', 'Info');
    }

    function viewDoubtDetails(doubtId) {
      Toast.info('Detailed view coming soon!', 'Info');
    }

    function toggleNotifications() {
      if (notificationPanelOpen) {
        closeNotificationPanel();
      } else {
        openNotificationPanel();
      }
    }

    async function openNotificationPanel() {
      notificationPanelOpen = true;
      
      // Create notification panel
      const panelHTML = `
        <div id="notification-panel" style="position: fixed; top: 0; right: 0; width: 400px; height: 100vh; background: rgba(26, 26, 46, 0.98); backdrop-filter: blur(20px); border-left: 1px solid rgba(255, 107, 0, 0.2); z-index: 2000; box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column; animation: slideInRight 0.3s ease;">
          <div style="padding: 20px; border-bottom: 1px solid rgba(255, 107, 0, 0.2); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="font-size: 20px; color: #ff6b00; margin: 0;">
              <i class="fas fa-bell"></i> Notifications
            </h3>
            <div style="display: flex; gap: 10px;">
              <button onclick="markAllNotificationsAsRead()" style="background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                <i class="fas fa-check-double"></i> Mark All Read
              </button>
              <button onclick="closeNotificationPanel()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px;">
                &times;
              </button>
            </div>
          </div>
          <div id="notifications-list" style="flex: 1; overflow-y: auto; padding: 10px;">
            <div class="loading" style="text-align: center; padding: 40px;">
              <div class="spinner"></div>
              <p>Loading notifications...</p>
            </div>
          </div>
        </div>
        <style>
          @keyframes slideInRight {
            from {
              transform: translateX(100%);
            }
            to {
              transform: translateX(0);
            }
          }
          @keyframes slideOutRight {
            from {
              transform: translateX(0);
            }
            to {
              transform: translateX(100%);
            }
          }
          #notifications-list::-webkit-scrollbar {
            width: 6px;
          }
          #notifications-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
          }
          #notifications-list::-webkit-scrollbar-thumb {
            background: rgba(255, 107, 0, 0.5);
            border-radius: 3px;
          }
        </style>
      `;
      
      document.body.insertAdjacentHTML('beforeend', panelHTML);
      
      // Load notifications
      await loadNotifications();
    }

    function closeNotificationPanel() {
      notificationPanelOpen = false;
      const panel = document.getElementById('notification-panel');
      if (panel) {
        panel.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => panel.remove(), 300);
      }
    }

    async function updateNotificationBadge() {
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch('${window.location.origin}/api/mentor/notifications?limit=1&unreadOnly=true', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          const notificationCount = document.getElementById('notification-count');
          if (notificationCount) {
            notificationCount.textContent = data.unreadCount || 0;
          }
        }
      } catch (error) {
        console.error('Error updating notification badge:', error);
      }
    }

    async function loadNotifications() {
      try {
        const token = localStorage.getItem('mentorToken');
        console.log('Loading notifications with token:', token ? 'exists' : 'missing');
        
        const response = await fetch('${window.location.origin}/api/mentor/notifications?limit=50', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('Notification response status:', response.status);
        
        if (response.ok) {
          const data = await response.json();
          console.log('Notification data:', data);
          notifications = data.notifications || [];
          displayNotifications(notifications);
          
          // Update notification count badge
          const notificationCount = document.getElementById('notification-count');
          if (notificationCount) {
            notificationCount.textContent = data.unreadCount || 0;
          }
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('Notification fetch failed:', response.status, errorData);
          throw new Error(`Failed to load notifications: ${response.status}`);
        }
      } catch (error) {
        console.error('Error loading notifications:', error);
        const listEl = document.getElementById('notifications-list');
        if (listEl) {
          listEl.innerHTML = `
            <div class="empty-state" style="padding: 40px 20px; text-align: center;">
              <i class="fas fa-exclamation-circle" style="font-size: 48px; color: #ef4444; margin-bottom: 15px;"></i>
              <h3 style="color: rgba(255, 255, 255, 0.8); margin-bottom: 10px;">Failed to Load</h3>
              <p style="color: rgba(255, 255, 255, 0.5);">${error.message}</p>
            </div>
          `;
        }
      }
    }

    function displayNotifications(notificationsList) {
      const listEl = document.getElementById('notifications-list');
      if (!listEl) return;
      
      if (notificationsList.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state" style="padding: 60px 20px;">
            <i class="fas fa-inbox" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px;"></i>
            <h3 style="font-size: 16px; color: rgba(255, 255, 255, 0.7);">No Notifications</h3>
            <p style="font-size: 13px; color: rgba(255, 255, 255, 0.5);">You're all caught up!</p>
          </div>
        `;
        return;
      }

      const notificationIcons = {
        'mentorship_request': { icon: 'user-plus', color: '#3b82f6' },
        'mentorship_accepted': { icon: 'check-circle', color: '#10b981' },
        'mentorship_declined': { icon: 'times-circle', color: '#ef4444' },
        'session_scheduled': { icon: 'calendar-plus', color: '#a855f7' },
        'session_reminder': { icon: 'bell', color: '#f59e0b' },
        'session_cancelled': { icon: 'calendar-times', color: '#ef4444' },
        'session_rescheduled': { icon: 'calendar', color: '#f59e0b' },
        'session_completed': { icon: 'check-circle', color: '#10b981' },
        'task_assigned': { icon: 'tasks', color: '#3b82f6' },
        'goal_assigned': { icon: 'bullseye', color: '#a855f7' },
        'feedback_received': { icon: 'star', color: '#ffd700' },
        'doubt_answered': { icon: 'question-circle', color: '#10b981' },
        'message': { icon: 'comment', color: '#3b82f6' },
        'general': { icon: 'info-circle', color: '#6b7280' }
      };

      const html = notificationsList.map(notification => {
        const iconData = notificationIcons[notification.type] || notificationIcons['general'];
        const timeAgo = getTimeAgo(notification.createdAt);
        
        return `
          <div class="notification-item" onclick="markNotificationAsRead('${notification._id}')" style="padding: 15px; margin-bottom: 10px; background: ${notification.read ? 'rgba(255, 255, 255, 0.02)' : 'rgba(255, 107, 0, 0.1)'}; border-left: 3px solid ${iconData.color}; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; ${!notification.read ? 'box-shadow: 0 0 10px rgba(255, 107, 0, 0.2);' : ''}">
            <div style="display: flex; gap: 12px; align-items: start;">
              <div style="width: 36px; height: 36px; border-radius: 50%; background: ${iconData.color}20; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <i class="fas fa-${iconData.icon}" style="color: ${iconData.color}; font-size: 16px;"></i>
              </div>
              <div style="flex: 1; min-width: 0;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                  <h4 style="font-size: 14px; font-weight: 600; color: ${notification.read ? 'rgba(255, 255, 255, 0.8)' : 'white'}; margin: 0;">${notification.title}</h4>
                  ${!notification.read ? '<div style="width: 8px; height: 8px; border-radius: 50%; background: #ff6b00; flex-shrink: 0; margin-top: 4px;"></div>' : ''}
                </div>
                <p style="font-size: 13px; color: rgba(255, 255, 255, 0.6); margin: 0 0 8px 0; line-height: 1.4;">${notification.message}</p>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 11px; color: rgba(255, 255, 255, 0.4);">
                    <i class="far fa-clock"></i> ${timeAgo}
                  </span>
                  <button onclick="event.stopPropagation(); deleteNotification('${notification._id}')" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      listEl.innerHTML = html;
    }

    async function markNotificationAsRead(notificationId) {
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch(`${window.location.origin}/api/mentor/notifications/${notificationId}/read`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          // Update local notification
          const notification = notifications.find(n => n._id === notificationId);
          if (notification) {
            notification.read = true;
            notification.readAt = new Date();
          }
          
          // Reload notifications to update UI
          await loadNotifications();
        }
      } catch (error) {
        console.error('Error marking notification as read:', error);
      }
    }

    async function markAllNotificationsAsRead() {
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch('${window.location.origin}/api/mentor/notifications/read-all', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          Toast.success('All notifications marked as read', 'Success');
          await loadNotifications();
          await updateNotificationBadge();
        }
      } catch (error) {
        console.error('Error marking all notifications as read:', error);
        Toast.error('Failed to mark notifications as read', 'Error');
      }
    }

    async function deleteNotification(notificationId) {
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch(`${window.location.origin}/api/mentor/notifications/${notificationId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          notifications = notifications.filter(n => n._id !== notificationId);
          displayNotifications(notifications);
          await updateNotificationBadge();
        }
      } catch (error) {
        console.error('Error deleting notification:', error);
        Toast.error('Failed to delete notification', 'Error');
      }
    }

    // ============ PROGRESS TRACKING FUNCTIONS ============

    async function loadMenteeProgress(menteeId) {
      if (!menteeId) {
        document.getElementById('progress-container').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-user-graduate"></i>
            <h3>Select a Mentee</h3>
            <p>Choose a mentee from the dropdown above to view and manage their progress.</p>
          </div>
        `;
        return;
      }

      currentMenteeId = menteeId;
      const mentee = mentees.find(m => m.id == menteeId);

      document.getElementById('progress-container').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading progress data...</p>
        </div>
      `;

      try {
        const token = localStorage.getItem('mentorToken');
        
        // Load progress summary
        const progressResponse = await fetch(`${window.location.origin}/api/mentor/progress/${menteeId}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (progressResponse.ok) {
          const progressData = await progressResponse.json();
          displayProgressDashboard(mentee, progressData);
        }
      } catch (error) {
        console.error('Error loading progress:', error);
        Toast.error('Failed to load progress data', 'Error');
      }
    }

    function displayProgressDashboard(mentee, progressData) {
      const html = `
        <div style="background: rgba(26, 26, 46, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255, 107, 0, 0.2); border-radius: 12px; padding: 25px; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <h3 style="font-size: 22px; margin-bottom: 5px;">${mentee.name}'s Progress</h3>
              <p style="color: rgba(255, 255, 255, 0.6); font-size: 14px;">${mentee.email}</p>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-accept" onclick="showAssignTaskModal()">
                <i class="fas fa-plus"></i> Assign Task
              </button>
              <button class="btn btn-view" onclick="showSetGoalModal()">
                <i class="fas fa-bullseye"></i> Set Goal
              </button>
            </div>
          </div>

          <!-- Progress Stats -->
          <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 30px;">
            <div class="stat-card" style="padding: 20px;">
              <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: 700; color: #3b82f6;">${progressData.taskStats.total}</div>
                <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6); margin-top: 5px;">Total Tasks</div>
              </div>
            </div>
            <div class="stat-card" style="padding: 20px;">
              <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: 700; color: #10b981;">${progressData.taskStats.completed}</div>
                <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6); margin-top: 5px;">Completed Tasks</div>
              </div>
            </div>
            <div class="stat-card" style="padding: 20px;">
              <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: 700; color: #ff6b00;">${progressData.taskStats.averageProgress}%</div>
                <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6); margin-top: 5px;">Avg Task Progress</div>
              </div>
            </div>
            <div class="stat-card" style="padding: 20px;">
              <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: 700; color: #a855f7;">${progressData.goalStats.total}</div>
                <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6); margin-top: 5px;">Active Goals</div>
              </div>
            </div>
          </div>

          <!-- Tasks & Goals Tabs -->
          <div style="margin-bottom: 20px;">
            <div style="display: flex; gap: 15px; border-bottom: 2px solid rgba(255, 107, 0, 0.2);">
              <button class="progress-tab active" onclick="switchProgressTab('tasks')" style="padding: 12px 24px; background: none; border: none; color: #ff6b00; font-weight: 600; border-bottom: 3px solid #ff6b00; cursor: pointer;">
                Tasks (${progressData.taskStats.total})
              </button>
              <button class="progress-tab" onclick="switchProgressTab('goals')" style="padding: 12px 24px; background: none; border: none; color: rgba(255, 255, 255, 0.6); font-weight: 600; border-bottom: 3px solid transparent; cursor: pointer;">
                Goals (${progressData.goalStats.total})
              </button>
            </div>
          </div>

          <!-- Tasks View -->
          <div id="tasks-view" class="progress-tab-content active">
            ${displayTasks(progressData.recentTasks)}
          </div>

          <!-- Goals View -->
          <div id="goals-view" class="progress-tab-content" style="display: none;">
            ${displayGoals(progressData.recentGoals)}
          </div>
        </div>
      `;

      document.getElementById('progress-container').innerHTML = html;
      
      // Load full tasks and goals
      loadAllTasksAndGoals(currentMenteeId);
    }

    function displayTasks(tasksList) {
      if (tasksList.length === 0) {
        return `
          <div class="empty-state">
            <i class="fas fa-tasks"></i>
            <h3>No Tasks Yet</h3>
            <p>Assign tasks to help your mentee progress.</p>
          </div>
        `;
      }

      return tasksList.map(task => `
        <div class="request-item" style="margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <div style="flex: 1;">
              <h4 style="font-size: 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
                ${task.title}
                <span class="status-badge ${task.status}">${task.status.replace('-', ' ')}</span>
              </h4>
              <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-bottom: 8px;">${task.description}</p>
              <div style="display: flex; gap: 15px; font-size: 13px; color: rgba(255, 255, 255, 0.5);">
                <span><i class="fas fa-tag"></i> ${task.category}</span>
                <span><i class="fas fa-exclamation-circle"></i> ${task.priority} priority</span>
                <span><i class="fas fa-calendar"></i> Due: ${new Date(task.dueDate).toLocaleDateString()}</span>
              </div>
            </div>
            <div style="min-width: 120px; text-align: right;">
              <div style="font-size: 24px; font-weight: 700; color: #ff6b00;">${task.progressPercentage}%</div>
              <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">Progress</div>
            </div>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill" style="width: ${task.progressPercentage}%"></div>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 12px;">
            <button class="btn btn-view btn-small" onclick="editTask('${task._id}')">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="btn btn-decline btn-small" onclick="deleteTask('${task._id}')">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      `).join('');
    }

    function displayGoals(goalsList) {
      if (goalsList.length === 0) {
        return `
          <div class="empty-state">
            <i class="fas fa-bullseye"></i>
            <h3>No Goals Set</h3>
            <p>Set goals to guide your mentee's development.</p>
          </div>
        `;
      }

      return goalsList.map(goal => {
        const completedMilestones = goal.milestones ? goal.milestones.filter(m => m.completed).length : 0;
        const totalMilestones = goal.milestones ? goal.milestones.length : 0;
        
        return `
          <div class="request-item" style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div style="flex: 1;">
                <h4 style="font-size: 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
                  ${goal.title}
                  <span class="status-badge ${goal.status}">${goal.status}</span>
                </h4>
                <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-bottom: 8px;">${goal.description}</p>
                <div style="display: flex; gap: 15px; font-size: 13px; color: rgba(255, 255, 255, 0.5);">
                  <span><i class="fas fa-tag"></i> ${goal.category.replace('-', ' ')}</span>
                  <span><i class="fas fa-calendar"></i> Target: ${new Date(goal.targetDate).toLocaleDateString()}</span>
                  ${totalMilestones > 0 ? `<span><i class="fas fa-flag"></i> ${completedMilestones}/${totalMilestones} milestones</span>` : ''}
                </div>
                
                ${goal.milestones && goal.milestones.length > 0 ? `
                  <div style="margin-top: 12px; padding: 12px; background: rgba(168, 85, 247, 0.1); border-radius: 6px;">
                    <div style="font-size: 13px; color: rgba(255, 255, 255, 0.8); margin-bottom: 8px; font-weight: 600;">
                      <i class="fas fa-list-check"></i> Milestones:
                    </div>
                    ${goal.milestones.map((milestone, idx) => `
                      <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 6px; font-size: 13px;">
                        <input type="checkbox" ${milestone.completed ? 'checked' : ''} 
                               onchange="toggleMilestone('${goal._id}', ${idx})"
                               style="margin-top: 3px; cursor: pointer;">
                        <span style="color: ${milestone.completed ? 'rgba(16, 185, 129, 0.8)' : 'rgba(255, 255, 255, 0.6)'}; ${milestone.completed ? 'text-decoration: line-through;' : ''}">
                          ${milestone.title}${milestone.description ? ` - ${milestone.description}` : ''}
                        </span>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
              <div style="min-width: 120px; text-align: right;">
                <div style="font-size: 24px; font-weight: 700; color: #a855f7;">${goal.progressPercentage}%</div>
                <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">Progress</div>
              </div>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar-fill" style="width: ${goal.progressPercentage}%; background: linear-gradient(90deg, #a855f7, #8b5cf6);"></div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 12px;">
              <button class="btn btn-view btn-small" onclick="viewGoalDetails('${goal._id}')">
                <i class="fas fa-eye"></i> View Details
              </button>
              <button class="btn btn-accept btn-small" onclick="editGoal('${goal._id}')" style="background: linear-gradient(135deg, #a855f7, #8b5cf6);">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button class="btn btn-decline btn-small" onclick="deleteGoal('${goal._id}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadAllTasksAndGoals(menteeId) {
      try {
        const token = localStorage.getItem('mentorToken');
        
        // Load tasks
        const tasksResponse = await fetch(`${window.location.origin}/api/mentor/tasks?menteeId=${menteeId}`, {
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        });
        
        if (tasksResponse.ok) {
          const tasksData = await tasksResponse.json();
          tasks = tasksData.tasks || [];
          if (document.getElementById('tasks-view')) {
            document.getElementById('tasks-view').innerHTML = displayTasks(tasks);
          }
        }
        
        // Load goals
        const goalsResponse = await fetch(`${window.location.origin}/api/mentor/goals?menteeId=${menteeId}`, {
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        });
        
        if (goalsResponse.ok) {
          const goalsData = await goalsResponse.json();
          goals = goalsData.goals || [];
          if (document.getElementById('goals-view')) {
            document.getElementById('goals-view').innerHTML = displayGoals(goals);
          }
        }
      } catch (error) {
        console.error('Error loading tasks and goals:', error);
      }
    }

    function switchProgressTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.progress-tab').forEach(tab => {
        tab.classList.remove('active');
        tab.style.color = 'rgba(255, 255, 255, 0.6)';
        tab.style.borderBottomColor = 'transparent';
      });
      
      event.currentTarget.classList.add('active');
      event.currentTarget.style.color = '#ff6b00';
      event.currentTarget.style.borderBottomColor = '#ff6b00';
      
      // Update content
      document.querySelectorAll('.progress-tab-content').forEach(content => {
        content.style.display = 'none';
      });
      
      document.getElementById(`${tabName}-view`).style.display = 'block';
    }

    function showAssignTaskModal() {
      const mentee = mentees.find(m => m.id == currentMenteeId);
      const modalHTML = `
        <div class="modal" id="task-modal" style="display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;">
          <div style="background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="font-size: 22px; color: #ff6b00;"><i class="fas fa-tasks"></i> Assign Task to ${mentee.name}</h3>
              <button onclick="closeTaskModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <form id="task-form" onsubmit="submitTask(event)">
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Task Title *</label>
                <input type="text" id="task-title" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 6px; color: white; font-size: 14px;">
              </div>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Description *</label>
                <textarea id="task-description" required rows="3" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 6px; color: white; font-size: 14px; resize: vertical;"></textarea>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Category</label>
                  <select id="task-category" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 6px; color: white; font-size: 14px;">
                    <option value="assignment">Assignment</option>
                    <option value="project">Project</option>
                    <option value="reading">Reading</option>
                    <option value="practice">Practice</option>
                    <option value="research">Research</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Priority</label>
                  <select id="task-priority" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 6px; color: white; font-size: 14px;">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                  </select>
                </div>
              </div>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Due Date *</label>
                <input type="date" id="task-duedate" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 6px; color: white; font-size: 14px;">
              </div>
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Additional Notes</label>
                <textarea id="task-notes" rows="2" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 6px; color: white; font-size: 14px; resize: vertical;"></textarea>
              </div>
              <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeTaskModal()" class="btn btn-decline">Cancel</button>
                <button type="submit" class="btn btn-accept"><i class="fas fa-check"></i> Assign Task</button>
              </div>
            </form>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Set minimum date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('task-duedate').setAttribute('min', today);
    }

    function closeTaskModal() {
      const modal = document.getElementById('task-modal');
      if (modal) modal.remove();
    }

    async function submitTask(event) {
      event.preventDefault();
      
      const mentee = mentees.find(m => m.id == currentMenteeId);
      const taskData = {
        menteeId: currentMenteeId,
        menteeName: mentee.name,
        title: document.getElementById('task-title').value,
        description: document.getElementById('task-description').value,
        category: document.getElementById('task-category').value,
        priority: document.getElementById('task-priority').value,
        dueDate: document.getElementById('task-duedate').value,
        notes: document.getElementById('task-notes').value
      };
      
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch('${window.location.origin}/api/mentor/tasks', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(taskData)
        });
        
        if (response.ok) {
          Toast.success('Task assigned successfully!', 'Success');
          closeTaskModal();
          loadMenteeProgress(currentMenteeId);
        } else {
          const data = await response.json();
          Toast.error(data.error || 'Failed to assign task', 'Error');
        }
      } catch (error) {
        console.error('Error assigning task:', error);
        Toast.error('Failed to assign task', 'Error');
      }
    }

    function showSetGoalModal() {
      const mentee = mentees.find(m => m.id == currentMenteeId);
      const modalHTML = `
        <div class="modal" id="goal-modal" style="display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;">
          <div style="background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 12px; padding: 30px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="font-size: 22px; color: #a855f7;"><i class="fas fa-bullseye"></i> Set Goal for ${mentee.name}</h3>
              <button onclick="closeGoalModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <form id="goal-form" onsubmit="submitGoal(event)">
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Goal Title *</label>
                <input type="text" id="goal-title" required placeholder="e.g., Master Data Structures & Algorithms" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 14px;">
              </div>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Description *</label>
                <textarea id="goal-description" required rows="3" placeholder="Describe the goal and what success looks like..." style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 14px; resize: vertical;"></textarea>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Category</label>
                  <select id="goal-category" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 14px;">
                    <option value="skill-development">Skill Development</option>
                    <option value="academic">Academic</option>
                    <option value="career">Career</option>
                    <option value="project">Project</option>
                    <option value="certification">Certification</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Target Date *</label>
                  <input type="date" id="goal-targetdate" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 14px;">
                </div>
              </div>
              
              <!-- Milestones Section -->
              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <label style="font-size: 14px; color: rgba(255, 255, 255, 0.8);">Milestones (Optional)</label>
                  <button type="button" onclick="addMilestoneField()" style="background: rgba(168, 85, 247, 0.2); border: 1px solid rgba(168, 85, 247, 0.3); color: #a855f7; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                    <i class="fas fa-plus"></i> Add Milestone
                  </button>
                </div>
                <div id="milestones-container" style="display: flex; flex-direction: column; gap: 10px;">
                  <!-- Milestones will be added here -->
                </div>
              </div>

              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Initial Notes</label>
                <textarea id="goal-notes" rows="2" placeholder="Add any additional context or notes..." style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 14px; resize: vertical;"></textarea>
              </div>
              <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeGoalModal()" class="btn btn-decline">Cancel</button>
                <button type="submit" class="btn btn-accept" style="background: linear-gradient(135deg, #a855f7, #8b5cf6);"><i class="fas fa-check"></i> Set Goal</button>
              </div>
            </form>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Set minimum date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('goal-targetdate').setAttribute('min', today);
    }

    function closeGoalModal() {
      const modal = document.getElementById('goal-modal');
      if (modal) modal.remove();
    }

    let milestoneCounter = 0;

    function addMilestoneField() {
      milestoneCounter++;
      const container = document.getElementById('milestones-container');
      const milestoneHTML = `
        <div class="milestone-item" id="milestone-${milestoneCounter}" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 6px; padding: 12px;">
          <div style="display: flex; gap: 10px; margin-bottom: 8px;">
            <input type="text" class="milestone-title" placeholder="Milestone title" style="flex: 1; padding: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 4px; color: white; font-size: 13px;">
            <button type="button" onclick="removeMilestone(${milestoneCounter})" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; padding: 8px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <textarea class="milestone-description" placeholder="Milestone description (optional)" rows="2" style="width: 100%; padding: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 4px; color: white; font-size: 13px; resize: vertical;"></textarea>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', milestoneHTML);
    }

    function removeMilestone(id) {
      const milestone = document.getElementById(`milestone-${id}`);
      if (milestone) milestone.remove();
    }

    async function submitGoal(event) {
      event.preventDefault();
      
      const mentee = mentees.find(m => m.id == currentMenteeId);
      
      // Collect milestones
      const milestoneElements = document.querySelectorAll('.milestone-item');
      const milestones = [];
      milestoneElements.forEach(element => {
        const title = element.querySelector('.milestone-title').value.trim();
        const description = element.querySelector('.milestone-description').value.trim();
        if (title) {
          milestones.push({
            title: title,
            description: description || '',
            completed: false
          });
        }
      });
      
      const goalData = {
        menteeId: currentMenteeId,
        menteeName: mentee.name,
        title: document.getElementById('goal-title').value,
        description: document.getElementById('goal-description').value,
        category: document.getElementById('goal-category').value,
        targetDate: document.getElementById('goal-targetdate').value,
        milestones: milestones,
        notes: document.getElementById('goal-notes').value
      };
      
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch('${window.location.origin}/api/mentor/goals', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(goalData)
        });
        
        if (response.ok) {
          Toast.success('Goal set successfully!', 'Success');
          closeGoalModal();
          loadMenteeProgress(currentMenteeId);
          milestoneCounter = 0; // Reset counter
        } else {
          const data = await response.json();
          Toast.error(data.error || 'Failed to set goal', 'Error');
        }
      } catch (error) {
        console.error('Error setting goal:', error);
        Toast.error('Failed to set goal', 'Error');
      }
    }

    function editTask(taskId) {
      const task = tasks.find(t => t._id === taskId);
      if (!task) return;

      const modalHTML = `
        <div class="modal" id="edit-task-modal" style="display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;">
          <div style="background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="font-size: 22px; color: #ff6b00;"><i class="fas fa-edit"></i> Edit Task</h3>
              <button onclick="closeEditTaskModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
            </div>

            <form onsubmit="updateTask(event, '${taskId}')">
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Title *</label>
                <input type="text" id="edit-task-title" value="${task.title.replace(/"/g, '&quot;')}" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 6px; color: white; font-size: 14px;">
              </div>

              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Description *</label>
                <textarea id="edit-task-description" required rows="3" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 6px; color: white; font-size: 14px; resize: vertical;">${task.description}</textarea>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Category</label>
                  <select id="edit-task-category" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 6px; color: white; font-size: 14px;">
                    <option value="assignment" ${task.category === 'assignment' ? 'selected' : ''}>Assignment</option>
                    <option value="project" ${task.category === 'project' ? 'selected' : ''}>Project</option>
                    <option value="reading" ${task.category === 'reading' ? 'selected' : ''}>Reading</option>
                    <option value="practice" ${task.category === 'practice' ? 'selected' : ''}>Practice</option>
                    <option value="research" ${task.category === 'research' ? 'selected' : ''}>Research</option>
                    <option value="other" ${task.category === 'other' ? 'selected' : ''}>Other</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Priority</label>
                  <select id="edit-task-priority" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 6px; color: white; font-size: 14px;">
                    <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Low</option>
                    <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>Medium</option>
                    <option value="high" ${task.priority === 'high' ? 'selected' : ''}>High</option>
                    <option value="urgent" ${task.priority === 'urgent' ? 'selected' : ''}>Urgent</option>
                  </select>
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Status</label>
                  <select id="edit-task-status" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 6px; color: white; font-size: 14px;">
                    <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                    <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                    <option value="overdue" ${task.status === 'overdue' ? 'selected' : ''}>Overdue</option>
                    <option value="cancelled" ${task.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Due Date *</label>
                  <input type="date" id="edit-task-duedate" value="${new Date(task.dueDate).toISOString().split('T')[0]}" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 6px; color: white; font-size: 14px;">
                </div>
              </div>

              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">
                  Progress: <span id="edit-task-progress-value">${task.progressPercentage}%</span>
                </label>
                <input type="range" id="edit-task-progress" min="0" max="100" value="${task.progressPercentage}" 
                  oninput="document.getElementById('edit-task-progress-value').textContent = this.value + '%'"
                  style="width: 100%; height: 8px; border-radius: 4px; background: rgba(255, 255, 255, 0.1); outline: none; -webkit-appearance: none;">
                <style>
                  #edit-task-progress::-webkit-slider-thumb {
                    -webkit-appearance: none;
                    appearance: none;
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #ff6b00, #ff8c00);
                    cursor: pointer;
                    box-shadow: 0 2px 10px rgba(255, 107, 0, 0.5);
                  }
                  #edit-task-progress::-moz-range-thumb {
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #ff6b00, #ff8c00);
                    cursor: pointer;
                    box-shadow: 0 2px 10px rgba(255, 107, 0, 0.5);
                    border: none;
                  }
                </style>
              </div>

              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Feedback</label>
                <textarea id="edit-task-feedback" rows="3" placeholder="Provide feedback on task progress..." style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 6px; color: white; font-size: 14px; resize: vertical;">${task.feedback || ''}</textarea>
              </div>

              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Rating (0-5)</label>
                <input type="number" id="edit-task-rating" min="0" max="5" step="0.5" value="${task.rating || ''}" placeholder="Optional rating" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 107, 0, 0.3); border-radius: 6px; color: white; font-size: 14px;">
              </div>

              <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeEditTaskModal()" class="btn btn-decline">Cancel</button>
                <button type="submit" class="btn btn-accept" style="background: linear-gradient(135deg, #ff6b00, #ff8c00);">
                  <i class="fas fa-save"></i> Update Task
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function closeEditTaskModal() {
      const modal = document.getElementById('edit-task-modal');
      if (modal) modal.remove();
    }

    async function updateTask(event, taskId) {
      event.preventDefault();

      const taskData = {
        title: document.getElementById('edit-task-title').value,
        description: document.getElementById('edit-task-description').value,
        category: document.getElementById('edit-task-category').value,
        priority: document.getElementById('edit-task-priority').value,
        status: document.getElementById('edit-task-status').value,
        dueDate: document.getElementById('edit-task-duedate').value,
        progressPercentage: parseInt(document.getElementById('edit-task-progress').value),
        feedback: document.getElementById('edit-task-feedback').value,
        rating: parseFloat(document.getElementById('edit-task-rating').value) || null
      };

      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch(`${window.location.origin}/api/mentor/tasks/${taskId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(taskData)
        });

        if (response.ok) {
          Toast.success('Task updated successfully!', 'Success');
          closeEditTaskModal();
          loadMenteeProgress(currentMenteeId);
        } else {
          const error = await response.json();
          Toast.error(error.message || 'Failed to update task', 'Error');
        }
      } catch (error) {
        console.error('Error updating task:', error);
        Toast.error('Failed to update task', 'Error');
      }
    }

    async function deleteTask(taskId) {
      if (!confirm('Are you sure you want to delete this task?')) return;
      
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch(`${window.location.origin}/api/mentor/tasks/${taskId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          Toast.success('Task deleted successfully', 'Success');
          loadMenteeProgress(currentMenteeId);
        } else {
          Toast.error('Failed to delete task', 'Error');
        }
      } catch (error) {
        console.error('Error deleting task:', error);
        Toast.error('Failed to delete task', 'Error');
      }
    }

    function editGoal(goalId) {
      const goal = goals.find(g => g._id === goalId);
      if (!goal) return;

      const modalHTML = `
        <div class="modal" id="edit-goal-modal" style="display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;">
          <div style="background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 12px; padding: 30px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="font-size: 22px; color: #a855f7;"><i class="fas fa-edit"></i> Edit Goal</h3>
              <button onclick="closeEditGoalModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
            </div>

            <form onsubmit="updateGoal(event, '${goalId}')">
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Title *</label>
                <input type="text" id="edit-goal-title" value="${goal.title.replace(/"/g, '&quot;')}" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 14px;">
              </div>

              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Description *</label>
                <textarea id="edit-goal-description" required rows="3" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 14px; resize: vertical;">${goal.description}</textarea>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Category</label>
                  <select id="edit-goal-category" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 14px;">
                    <option value="skill-development" ${goal.category === 'skill-development' ? 'selected' : ''}>Skill Development</option>
                    <option value="academic" ${goal.category === 'academic' ? 'selected' : ''}>Academic</option>
                    <option value="career" ${goal.category === 'career' ? 'selected' : ''}>Career</option>
                    <option value="project" ${goal.category === 'project' ? 'selected' : ''}>Project</option>
                    <option value="certification" ${goal.category === 'certification' ? 'selected' : ''}>Certification</option>
                    <option value="other" ${goal.category === 'other' ? 'selected' : ''}>Other</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Status</label>
                  <select id="edit-goal-status" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 14px;">
                    <option value="active" ${goal.status === 'active' ? 'selected' : ''}>Active</option>
                    <option value="achieved" ${goal.status === 'achieved' ? 'selected' : ''}>Achieved</option>
                    <option value="delayed" ${goal.status === 'delayed' ? 'selected' : ''}>Delayed</option>
                    <option value="cancelled" ${goal.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                  </select>
                </div>
              </div>

              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Target Date *</label>
                <input type="date" id="edit-goal-targetdate" value="${new Date(goal.targetDate).toISOString().split('T')[0]}" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 14px;">
              </div>

              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">
                  Progress: <span id="edit-goal-progress-value">${goal.progressPercentage}%</span>
                </label>
                <input type="range" id="edit-goal-progress" min="0" max="100" value="${goal.progressPercentage}" 
                  oninput="document.getElementById('edit-goal-progress-value').textContent = this.value + '%'"
                  style="width: 100%; height: 8px; border-radius: 4px; background: rgba(255, 255, 255, 0.1); outline: none; -webkit-appearance: none;">
                <style>
                  #edit-goal-progress::-webkit-slider-thumb {
                    -webkit-appearance: none;
                    appearance: none;
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #a855f7, #8b5cf6);
                    cursor: pointer;
                    box-shadow: 0 2px 10px rgba(168, 85, 247, 0.5);
                  }
                  #edit-goal-progress::-moz-range-thumb {
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #a855f7, #8b5cf6);
                    cursor: pointer;
                    box-shadow: 0 2px 10px rgba(168, 85, 247, 0.5);
                    border: none;
                  }
                </style>
              </div>

              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Notes</label>
                <textarea id="edit-goal-notes" rows="3" placeholder="Additional notes..." style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 14px; resize: vertical;">${goal.notes || ''}</textarea>
              </div>

              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <label style="font-size: 14px; color: rgba(255, 255, 255, 0.8);">Milestones</label>
                  <button type="button" onclick="addEditMilestoneField()" class="btn-small btn-view">
                    <i class="fas fa-plus"></i> Add Milestone
                  </button>
                </div>
                <div id="edit-milestones-container">
                  ${(goal.milestones || []).map((milestone, index) => `
                    <div class="milestone-item" data-index="${index}" style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                      <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                        <input type="text" class="milestone-title" value="${milestone.title}" placeholder="Milestone title" style="flex: 1; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 13px;">
                        <input type="date" class="milestone-date" value="${milestone.targetDate ? new Date(milestone.targetDate).toISOString().split('T')[0] : ''}" style="padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 13px;">
                        <button type="button" onclick="removeEditMilestone(${index})" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; padding: 8px 12px; border-radius: 6px; cursor: pointer;">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                      <textarea class="milestone-description" placeholder="Milestone description" rows="2" style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 13px; resize: vertical;">${milestone.description || ''}</textarea>
                      <label style="display: flex; align-items: center; gap: 8px; margin-top: 8px; font-size: 13px; color: rgba(255, 255, 255, 0.7); cursor: pointer;">
                        <input type="checkbox" class="milestone-completed" ${milestone.completed ? 'checked' : ''} style="width: 16px; height: 16px; cursor: pointer;">
                        Completed
                      </label>
                    </div>
                  `).join('')}
                </div>
              </div>

              <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeEditGoalModal()" class="btn btn-decline">Cancel</button>
                <button type="submit" class="btn btn-accept" style="background: linear-gradient(135deg, #a855f7, #8b5cf6);">
                  <i class="fas fa-save"></i> Update Goal
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    let editMilestoneCounter = 1000;

    function addEditMilestoneField() {
      const container = document.getElementById('edit-milestones-container');
      const milestoneHTML = `
        <div class="milestone-item" data-index="new-${editMilestoneCounter}" style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
          <div style="display: flex; gap: 10px; margin-bottom: 8px;">
            <input type="text" class="milestone-title" placeholder="Milestone title" style="flex: 1; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 13px;">
            <input type="date" class="milestone-date" style="padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 13px;">
            <button type="button" onclick="this.closest('.milestone-item').remove()" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; padding: 8px 12px; border-radius: 6px; cursor: pointer;">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <textarea class="milestone-description" placeholder="Milestone description" rows="2" style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; color: white; font-size: 13px; resize: vertical;"></textarea>
          <label style="display: flex; align-items: center; gap: 8px; margin-top: 8px; font-size: 13px; color: rgba(255, 255, 255, 0.7); cursor: pointer;">
            <input type="checkbox" class="milestone-completed" style="width: 16px; height: 16px; cursor: pointer;">
            Completed
          </label>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', milestoneHTML);
      editMilestoneCounter++;
    }

    function removeEditMilestone(index) {
      const item = document.querySelector(`.milestone-item[data-index="${index}"]`);
      if (item) item.remove();
    }

    function closeEditGoalModal() {
      const modal = document.getElementById('edit-goal-modal');
      if (modal) modal.remove();
    }

    async function updateGoal(event, goalId) {
      event.preventDefault();

      // Collect milestones
      const milestoneItems = document.querySelectorAll('#edit-milestones-container .milestone-item');
      const milestones = Array.from(milestoneItems).map(item => ({
        title: item.querySelector('.milestone-title').value,
        description: item.querySelector('.milestone-description').value,
        targetDate: item.querySelector('.milestone-date').value || null,
        completed: item.querySelector('.milestone-completed').checked
      })).filter(m => m.title.trim());

      const goalData = {
        title: document.getElementById('edit-goal-title').value,
        description: document.getElementById('edit-goal-description').value,
        category: document.getElementById('edit-goal-category').value,
        status: document.getElementById('edit-goal-status').value,
        targetDate: document.getElementById('edit-goal-targetdate').value,
        progressPercentage: parseInt(document.getElementById('edit-goal-progress').value),
        notes: document.getElementById('edit-goal-notes').value,
        milestones: milestones
      };

      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch(`${window.location.origin}/api/mentor/goals/${goalId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(goalData)
        });

        if (response.ok) {
          Toast.success('Goal updated successfully!', 'Success');
          closeEditGoalModal();
          loadMenteeProgress(currentMenteeId);
        } else {
          const error = await response.json();
          Toast.error(error.message || 'Failed to update goal', 'Error');
        }
      } catch (error) {
        console.error('Error updating goal:', error);
        Toast.error('Failed to update goal', 'Error');
      }
    }

    async function toggleMilestone(goalId, milestoneIndex) {
      try {
        const goal = goals.find(g => g._id === goalId);
        if (!goal) return;
        
        // Toggle the milestone
        goal.milestones[milestoneIndex].completed = !goal.milestones[milestoneIndex].completed;
        
        // Update on server
        const token = localStorage.getItem('mentorToken');
        const response = await fetch(`${window.location.origin}/api/mentor/goals/${goalId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ milestones: goal.milestones })
        });
        
        if (response.ok) {
          Toast.success('Milestone updated!', 'Success');
          loadMenteeProgress(currentMenteeId);
        } else {
          Toast.error('Failed to update milestone', 'Error');
        }
      } catch (error) {
        console.error('Error toggling milestone:', error);
        Toast.error('Failed to update milestone', 'Error');
      }
    }

    function viewGoalDetails(goalId) {
      const goal = goals.find(g => g._id === goalId);
      if (!goal) return;
      
      const mentee = mentees.find(m => m.id == currentMenteeId);
      const completedMilestones = goal.milestones ? goal.milestones.filter(m => m.completed).length : 0;
      const totalMilestones = goal.milestones ? goal.milestones.length : 0;
      
      const modalHTML = `
        <div class="modal" id="goal-details-modal" style="display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;">
          <div style="background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 12px; padding: 30px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="font-size: 22px; color: #a855f7;"><i class="fas fa-bullseye"></i> Goal Details</h3>
              <button onclick="closeGoalDetailsModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div style="flex: 1;">
                  <h4 style="font-size: 20px; margin-bottom: 8px;">${goal.title}</h4>
                  <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                    <span class="status-badge ${goal.status}">${goal.status}</span>
                    <span style="padding: 6px 12px; background: rgba(168, 85, 247, 0.2); border-radius: 20px; font-size: 12px; color: #a855f7;">
                      ${goal.category.replace('-', ' ')}
                    </span>
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 32px; font-weight: 700; color: #a855f7;">${goal.progressPercentage}%</div>
                  <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">Progress</div>
                </div>
              </div>
              
              <div class="progress-bar-container" style="margin-bottom: 20px;">
                <div class="progress-bar-fill" style="width: ${goal.progressPercentage}%; background: linear-gradient(90deg, #a855f7, #8b5cf6);"></div>
              </div>
              
              <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6); margin-bottom: 5px;">Description</div>
                <div style="color: rgba(255, 255, 255, 0.9); line-height: 1.6;">${goal.description}</div>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px;">
                  <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-bottom: 5px;">Target Date</div>
                  <div style="color: #a855f7; font-weight: 600;">${new Date(goal.targetDate).toLocaleDateString()}</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px;">
                  <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-bottom: 5px;">Created On</div>
                  <div style="color: rgba(255, 255, 255, 0.8);">${new Date(goal.createdAt).toLocaleDateString()}</div>
                </div>
              </div>
              
              ${totalMilestones > 0 ? `
                <div style="background: rgba(168, 85, 247, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="font-size: 14px; color: rgba(255, 255, 255, 0.9); font-weight: 600;">
                      <i class="fas fa-flag-checkered"></i> Milestones (${completedMilestones}/${totalMilestones} completed)
                    </div>
                  </div>
                  ${goal.milestones.map((milestone, idx) => `
                    <div style="display: flex; align-items: start; gap: 10px; padding: 10px; background: ${milestone.completed ? 'rgba(16, 185, 129, 0.1)' : 'rgba(255, 255, 255, 0.05)'}; border-radius: 6px; margin-bottom: 8px;">
                      <div style="margin-top: 2px;">
                        ${milestone.completed ? 
                          '<i class="fas fa-check-circle" style="color: #10b981; font-size: 18px;"></i>' : 
                          '<i class="far fa-circle" style="color: rgba(255, 255, 255, 0.3); font-size: 18px;"></i>'}
                      </div>
                      <div style="flex: 1;">
                        <div style="font-weight: 600; color: ${milestone.completed ? '#10b981' : 'rgba(255, 255, 255, 0.9)'}; margin-bottom: 4px;">
                          ${milestone.title}
                        </div>
                        ${milestone.description ? `
                          <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6);">
                            ${milestone.description}
                          </div>
                        ` : ''}
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              
              ${goal.reflections && goal.reflections.length > 0 ? `
                <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px;">
                  <div style="font-size: 14px; color: rgba(255, 255, 255, 0.9); font-weight: 600; margin-bottom: 12px;">
                    <i class="fas fa-comment-dots"></i> Reflections
                  </div>
                  ${goal.reflections.map(reflection => `
                    <div style="padding: 10px; background: rgba(255, 255, 255, 0.05); border-left: 3px solid #a855f7; border-radius: 4px; margin-bottom: 10px;">
                      <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-bottom: 5px;">
                        ${new Date(reflection.date).toLocaleDateString()} - ${reflection.author}
                      </div>
                      <div style="color: rgba(255, 255, 255, 0.8);">${reflection.content}</div>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button onclick="closeGoalDetailsModal()" class="btn btn-decline">Close</button>
              <button onclick="closeGoalDetailsModal(); editGoal('${goal._id}')" class="btn btn-accept" style="background: linear-gradient(135deg, #a855f7, #8b5cf6);">
                <i class="fas fa-edit"></i> Edit Goal
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function closeGoalDetailsModal() {
      const modal = document.getElementById('goal-details-modal');
      if (modal) modal.remove();
    }

    // ============ SESSION MANAGEMENT FUNCTIONS ============

    function showScheduleSessionModal() {
      if (mentees.length === 0) {
        Toast.error('No mentees available. Accept mentorship requests first.', 'Error');
        return;
      }

      const modalHTML = `
        <div class="modal" id="session-modal" style="display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;">
          <div style="background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 30px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="font-size: 22px; color: #3b82f6;"><i class="fas fa-calendar-plus"></i> Schedule New Session</h3>
              <button onclick="closeSessionModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <form id="session-form" onsubmit="submitSession(event)">
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Select Mentee *</label>
                <select id="session-mentee" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; color: white; font-size: 14px;">
                  <option value="">Choose a mentee...</option>
                  ${mentees.map(mentee => `<option value="${mentee.id}">${mentee.name}</option>`).join('')}
                </select>
              </div>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Session Title *</label>
                <input type="text" id="session-title" required placeholder="e.g., Code Review Session" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; color: white; font-size: 14px;">
              </div>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Description *</label>
                <textarea id="session-description" required rows="3" placeholder="What will you cover in this session?" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; color: white; font-size: 14px; resize: vertical;"></textarea>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Session Type</label>
                  <select id="session-type" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; color: white; font-size: 14px;">
                    <option value="one-on-one">One-on-One</option>
                    <option value="group">Group</option>
                    <option value="workshop">Workshop</option>
                    <option value="code-review">Code Review</option>
                    <option value="career-guidance">Career Guidance</option>
                    <option value="project-discussion">Project Discussion</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Mode *</label>
                  <select id="session-mode" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; color: white; font-size: 14px;">
                    <option value="video-call">Video Call</option>
                    <option value="audio-call">Audio Call</option>
                    <option value="chat">Chat</option>
                    <option value="screen-share">Screen Share</option>
                    <option value="in-person">In-Person</option>
                  </select>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Date & Time *</label>
                  <input type="datetime-local" id="session-datetime" required style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; color: white; font-size: 14px;">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Duration (minutes) *</label>
                  <input type="number" id="session-duration" required min="15" max="480" value="60" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; color: white; font-size: 14px;">
                </div>
              </div>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Meeting Link (Optional)</label>
                <input type="url" id="session-link" placeholder="https://meet.google.com/..." style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; color: white; font-size: 14px;">
              </div>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Agenda Items (Optional)</label>
                <div id="agenda-container" style="margin-bottom: 10px;">
                  <input type="text" class="agenda-item" placeholder="Add agenda item..." style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 6px; color: white; font-size: 13px; margin-bottom: 8px;">
                </div>
                <button type="button" onclick="addAgendaItem()" style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer;">
                  <i class="fas fa-plus"></i> Add Agenda Item
                </button>
              </div>
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: rgba(255, 255, 255, 0.8);">Additional Notes</label>
                <textarea id="session-notes" rows="2" placeholder="Any additional information..." style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; color: white; font-size: 14px; resize: vertical;"></textarea>
              </div>
              <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeSessionModal()" class="btn btn-decline">Cancel</button>
                <button type="submit" class="btn btn-accept" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"><i class="fas fa-check"></i> Schedule Session</button>
              </div>
            </form>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Set minimum datetime to now
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('session-datetime').min = now.toISOString().slice(0, 16);
    }

    function closeSessionModal() {
      const modal = document.getElementById('session-modal');
      if (modal) modal.remove();
    }

    function addAgendaItem() {
      const container = document.getElementById('agenda-container');
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'agenda-item';
      input.placeholder = 'Add agenda item...';
      input.style.cssText = 'width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 6px; color: white; font-size: 13px; margin-bottom: 8px;';
      container.appendChild(input);
    }

    async function submitSession(event) {
      event.preventDefault();
      
      const menteeId = document.getElementById('session-mentee').value;
      const mentee = mentees.find(m => m.id == menteeId);
      
      // Collect agenda items
      const agendaInputs = document.querySelectorAll('.agenda-item');
      const agenda = [];
      agendaInputs.forEach(input => {
        if (input.value.trim()) {
          agenda.push({ item: input.value.trim(), completed: false });
        }
      });
      
      const sessionData = {
        menteeId,
        menteeName: mentee.name,
        title: document.getElementById('session-title').value,
        description: document.getElementById('session-description').value,
        type: document.getElementById('session-type').value,
        mode: document.getElementById('session-mode').value,
        scheduledDate: document.getElementById('session-datetime').value,
        duration: parseInt(document.getElementById('session-duration').value),
        meetingLink: document.getElementById('session-link').value,
        agenda: agenda,
        notes: document.getElementById('session-notes').value
      };
      
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch('${window.location.origin}/api/mentor/sessions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(sessionData)
        });
        
        if (response.ok) {
          Toast.success('Session scheduled successfully!', 'Success');
          closeSessionModal();
          loadSessions();
        } else {
          const data = await response.json();
          Toast.error(data.error || 'Failed to schedule session', 'Error');
        }
      } catch (error) {
        console.error('Error scheduling session:', error);
        Toast.error('Failed to schedule session', 'Error');
      }
    }

    async function startSession(sessionId) {
      if (!confirm('Start this session now?')) return;
      
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch(`${window.location.origin}/api/mentor/sessions/${sessionId}/start`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          Toast.success('Session started!', 'Success');
          loadSessions();
        } else {
          Toast.error('Failed to start session', 'Error');
        }
      } catch (error) {
        console.error('Error starting session:', error);
        Toast.error('Failed to start session', 'Error');
      }
    }

    async function endSession(sessionId) {
      const outcomes = prompt('Session outcomes (optional):');
      const feedback = prompt('Your feedback for the mentee (optional):');
      
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch(`${window.location.origin}/api/mentor/sessions/${sessionId}/end`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ outcomes, mentorFeedback: feedback })
        });
        
        if (response.ok) {
          Toast.success('Session ended successfully!', 'Success');
          loadSessions();
          loadMentorProfile(); // Refresh profile stats
        } else {
          Toast.error('Failed to end session', 'Error');
        }
      } catch (error) {
        console.error('Error ending session:', error);
        Toast.error('Failed to end session', 'Error');
      }
    }

    async function cancelSession(sessionId) {
      const reason = prompt('Reason for cancellation (optional):');
      if (reason === null) return; // User clicked Cancel
      
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch(`${window.location.origin}/api/mentor/sessions/${sessionId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: 'cancelled', notes: reason })
        });
        
        if (response.ok) {
          Toast.success('Session cancelled', 'Success');
          loadSessions();
        } else {
          Toast.error('Failed to cancel session', 'Error');
        }
      } catch (error) {
        console.error('Error cancelling session:', error);
        Toast.error('Failed to cancel session', 'Error');
      }
    }

    async function deleteSession(sessionId) {
      if (!confirm('Are you sure you want to delete this session? This action cannot be undone.')) return;
      
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch(`${window.location.origin}/api/mentor/sessions/${sessionId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          Toast.success('Session deleted', 'Success');
          loadSessions();
        } else {
          Toast.error('Failed to delete session', 'Error');
        }
      } catch (error) {
        console.error('Error deleting session:', error);
        Toast.error('Failed to delete session', 'Error');
      }
    }

    function viewSessionDetails(sessionId) {
      const session = sessions.find(s => s._id === sessionId);
      if (!session) return;
      
      Toast.info('Session details view coming soon!', 'Info');
    }

    function editSession(sessionId) {
      Toast.info('Session editing coming soon!', 'Info');
    }

    async function deleteGoal(goalId) {
      if (!confirm('Are you sure you want to delete this goal?')) return;
      
      try {
        const token = localStorage.getItem('mentorToken');
        const response = await fetch(`${window.location.origin}/api/mentor/goals/${goalId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          Toast.success('Goal deleted successfully', 'Success');
          loadMenteeProgress(currentMenteeId);
        } else {
          Toast.error('Failed to delete goal', 'Error');
        }
      } catch (error) {
        console.error('Error deleting goal:', error);
        Toast.error('Failed to delete goal', 'Error');
      }
    }

    function logout() {
      localStorage.removeItem('mentorToken');
      localStorage.removeItem('mentorId');
      localStorage.removeItem('mentorName');
      localStorage.removeItem('mentorEmail');
      window.location.href = '../mentor/signin.html';
    }
  </script>
</body>
</html>
